<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1.4 Extraction using exactextractr::exact_extract() | R as GIS for Economists</title>
  <meta name="description" content="This is a book for Economists who regularly use spatial datasets for their econometric work." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="1.4 Extraction using exactextractr::exact_extract() | R as GIS for Economists" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a book for Economists who regularly use spatial datasets for their econometric work." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1.4 Extraction using exactextractr::exact_extract() | R as GIS for Economists" />
  
  <meta name="twitter:description" content="This is a book for Economists who regularly use spatial datasets for their econometric work." />
  

<meta name="author" content="Taro Mieno" />


<meta name="date" content="2020-07-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="extraction-stars-polygons.html"/>
<link rel="next" href="speed-comparison.html"/>
<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R as GIS for Economists</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html"><i class="fa fa-check"></i>Why R as GIS for Economists?</a>
<ul>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#r-vs-python"><i class="fa fa-check"></i>R vs Python</a></li>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#r-vs-arcgis-or-qgis"><i class="fa fa-check"></i>R vs ArcGIS or QGIS</a></li>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#summary"><i class="fa fa-check"></i>Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="how-is-this-book-different-from-other-online-books-and-resources.html"><a href="how-is-this-book-different-from-other-online-books-and-resources.html"><i class="fa fa-check"></i>How is this book different from other online books and resources?</a></li>
<li class="chapter" data-level="" data-path="what-is-going-to-be-covered-in-this-book.html"><a href="what-is-going-to-be-covered-in-this-book.html"><i class="fa fa-check"></i>What is going to be covered in this book?</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html"><i class="fa fa-check"></i>Conventions of the book and some notes</a>
<ul>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#texts-in-gray-boxes"><i class="fa fa-check"></i>Texts in gray boxes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#colored-boxes"><i class="fa fa-check"></i>Colored Boxes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#parentheses-around-codes"><i class="fa fa-check"></i>Parentheses around codes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#footnotes"><i class="fa fa-check"></i>Footnotes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information.html"><a href="session-information.html"><i class="fa fa-check"></i>Session Information</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="int-RV.html"><a href="int-RV.html"><i class="fa fa-check"></i><b>1</b> Spatial Interactions of Vector and Raster Data</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start.html"><a href="before-you-start.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start.html"><a href="before-you-start.html#direction-for-replication"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="1.1" data-path="raster-crop.html"><a href="raster-crop.html"><i class="fa fa-check"></i><b>1.1</b> Spatial cropping (subsetting) to the area of interest</a></li>
<li class="chapter" data-level="1.2" data-path="extraction-stars-points.html"><a href="extraction-stars-points.html"><i class="fa fa-check"></i><b>1.2</b> Extracting raster cell values for points</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="extraction-stars-points.html"><a href="extraction-stars-points.html#simple-visual-illustration-of-raster-data-extraction-for-points"><i class="fa fa-check"></i><b>1.2.1</b> Simple visual illustration of raster data extraction for points</a></li>
<li class="chapter" data-level="1.2.2" data-path="extraction-stars-points.html"><a href="extraction-stars-points.html#extraction-using-aggregate.stars"><i class="fa fa-check"></i><b>1.2.2</b> Extraction using <code>aggregate.stars()</code></a></li>
<li class="chapter" data-level="1.2.3" data-path="extraction-stars-points.html"><a href="extraction-stars-points.html#extraction-using-terraextract"><i class="fa fa-check"></i><b>1.2.3</b> Extraction using <code>terra::extract()</code></a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="extraction-stars-polygons.html"><a href="extraction-stars-polygons.html"><i class="fa fa-check"></i><b>1.3</b> Extracting raster cell values for polygons: <code>aggregate()</code></a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="extraction-stars-polygons.html"><a href="extraction-stars-polygons.html#simple-visual-illustration-of-raster-data-extraction-for-polygons"><i class="fa fa-check"></i><b>1.3.1</b> Simple visual illustration of raster data extraction for polygons</a></li>
<li class="chapter" data-level="1.3.2" data-path="extraction-stars-polygons.html"><a href="extraction-stars-polygons.html#extraction-using-aggregate.stars-1"><i class="fa fa-check"></i><b>1.3.2</b> Extraction using <code>aggregate.stars()</code></a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="extraction-using-exactextractrexact-extract.html"><a href="extraction-using-exactextractrexact-extract.html"><i class="fa fa-check"></i><b>1.4</b> Extraction using <code>exactextractr::exact_extract()</code></a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="extraction-using-exactextractrexact-extract.html"><a href="extraction-using-exactextractrexact-extract.html#extraction-using-exact_extract-and-post-extraction-processing"><i class="fa fa-check"></i><b>1.4.1</b> Extraction using <code>exact_extract()</code> and post-extraction processing</a></li>
<li class="chapter" data-level="1.4.2" data-path="extraction-using-exactextractrexact-extract.html"><a href="extraction-using-exactextractrexact-extract.html#summarizing-the-extracted-values-inside-exact_extract"><i class="fa fa-check"></i><b>1.4.2</b> Summarizing the extracted values inside <code>exact_extract()</code></a></li>
<li class="chapter" data-level="1.4.3" data-path="extraction-using-exactextractrexact-extract.html"><a href="extraction-using-exactextractrexact-extract.html#extraction-from-raster-data-with-discrete-values-and-post-extraction-processing"><i class="fa fa-check"></i><b>1.4.3</b> Extraction from raster data with discrete values and post-extraction processing</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="speed-comparison.html"><a href="speed-comparison.html"><i class="fa fa-check"></i><b>1.5</b> Speed Comparison</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="speed-comparison.html"><a href="speed-comparison.html#points"><i class="fa fa-check"></i><b>1.5.1</b> Points</a></li>
<li class="chapter" data-level="1.5.2" data-path="speed-comparison.html"><a href="speed-comparison.html#polygons"><i class="fa fa-check"></i><b>1.5.2</b> Polygons</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R as GIS for Economists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script>

<div id="extraction-using-exactextractrexact_extract" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Extraction using <code>exactextractr::exact_extract()</code></h2>
<p>A great alternative is <code>exact_extract()</code> from the <code>exactextractr</code> package. It is considerably faster than <code>aggregate()</code> and it also returns the value of all the cells that partially overlap with polygons with <code>coverage_fraction</code> which is a measure of the fraction of the overlapping area. Let’s confirm this using the illustrative example. Here is the map of the raster cells and the polygon (Figure <a href="extraction-using-exactextractrexact-extract.html#fig:polygons-extact-viz-2">1.6</a>).</p>
<div class="figure"><span id="fig:polygons-extact-viz-2"></span>
<img src="R_GIS_Book_files/figure-html/polygons-extact-viz-2-1.png" alt="Visual illustration of raster data extraction for polygons data" width="672" />
<p class="caption">
Figure 1.6: Visual illustration of raster data extraction for polygons data
</p>
</div>
<p>Here is the output when <code>exact_extract()</code> is applied to the raster data and polygon.</p>
<pre><code>   value coverage_fraction
5      6        0.06666667
6      2        0.32023808
8     39        0.15000001
9     35        0.44999999
10    33        0.75000000
11    45        0.98333335
12    11        0.76190478
13    59        0.08333334
14    13        1.00000000
15    62        1.00000000
16    18        1.00000000
17     1        1.00000000
18    12        0.52380955
19    51        0.25000000
20    19        1.00000000
21    16        1.00000000
22    56        1.00000000
23     8        1.00000000
24    52        0.28571430
25    14        0.40833333
26    50        0.93333334
27    34        0.86666667
28    55        0.80000001
29    28        0.73333335
30    43        0.05833333</code></pre>
<p>As you can see there are two variables in the returned object: <code>value</code> and <code>coverage_fraction</code>. You can also see that the value of the cell that holds <span class="math inline">\(6\)</span> is extracted with its <code>coverage_fraction</code> of 0.0666667.</p>
<p>The only inconvenience about this function (for those who use <code>stars</code> as the main raster data handling package) is that the raster data has to be a <code>Raster</code><span class="math inline">\(^*\)</span> object instead of a <code>stars</code> object. So, we first need to convert a <code>stars</code> object into a <code>Raster</code><span class="math inline">\(^*\)</span> object.</p>
<div id="extraction-using-exact_extract-and-post-extraction-processing" class="section level3" number="1.4.1">
<h3><span class="header-section-number">1.4.1</span> Extraction using <code>exact_extract()</code> and post-extraction processing</h3>
<p>Let’s now look at a demonstration of how <code>exact_extract()</code> works using the same data. Before we use the function to extract values from a <code>stars</code> raster data, we first need to convert the <code>stars</code> object into a <code>Raster</code><span class="math inline">\(^*\)</span> object.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="extraction-using-exactextractrexact-extract.html#cb49-1"></a>(</span>
<span id="cb49-2"><a href="extraction-using-exactextractrexact-extract.html#cb49-2"></a>tmax_m1_y09_KS_rb &lt;-<span class="st"> </span><span class="kw">as</span>(tmax_m1_y09_KS_stars, <span class="st">&quot;Raster&quot;</span>)</span>
<span id="cb49-3"><a href="extraction-using-exactextractrexact-extract.html#cb49-3"></a>)</span></code></pre></div>
<pre><code>class      : RasterBrick 
dimensions : 73, 179, 13067, 10  (nrow, ncol, ncell, nlayers)
resolution : 0.04166667, 0.04166667  (x, y)
extent     : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0 
source     : memory
names      : layer.1, layer.2, layer.3, layer.4, layer.5, layer.6, layer.7, layer.8, layer.9, layer.10 
min values :  -2.409,   3.844,   7.267,  -1.286,  -6.891,  -2.286,   1.078,   0.981,   1.523,    6.916 
max values :  10.005,  16.707,  21.849,  23.119,   1.519,   9.483,  10.993,  19.211,  20.871,   19.750 </code></pre>
<p>Now, we can use <code>exact_extract()</code> as follows:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="extraction-using-exactextractrexact-extract.html#cb51-1"></a>extracted_values &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(tmax_m1_y09_KS_rb, KS_county_sf)  </span></code></pre></div>
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<p>The returned outcome is a list of <code>data.frame</code>. <span class="math inline">\(n\)</span>th element of the list corresponds to the <span class="math inline">\(n\)</span>th polygon (the polygon stored in the <span class="math inline">\(n\)</span>th row of the <code>sf</code>) in the <code>sf</code> object (<code>KS_county_sf</code>). Let’s take a look at the first 6 rows of the first 5 elements of the list.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="extraction-using-exactextractrexact-extract.html#cb53-1"></a>extracted_values[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">lapply</span>(., head)</span></code></pre></div>
<pre><code>[[1]]
  layer.1 layer.2 layer.3 layer.4 layer.5 layer.6 layer.7 layer.8 layer.9
1   0.351   8.296  12.857  18.988  -2.009   1.289   2.159   7.414   7.634
2   0.231   8.179  12.848  18.988  -2.106   1.256   2.156   7.135   7.408
3   0.137   8.102  12.808  18.924  -2.184   1.246   2.138   6.947   7.245
4   0.106   8.050  12.781  18.997  -2.176   1.227   2.157   6.837   7.116
5  -0.140   7.959  12.638  18.829  -2.358   1.243   2.128   6.586   6.813
6   0.055   8.023  12.728  19.178  -2.142   1.204   2.288   6.771   6.873
  layer.10 coverage_fraction
1   15.644         0.1455645
2   15.633         0.4065359
3   15.629         0.3808859
4   15.628         0.3552359
5   15.643         0.3295859
6   15.772         0.3039359

[[2]]
  layer.1 layer.2 layer.3 layer.4 layer.5 layer.6 layer.7 layer.8 layer.9
1  -0.626   7.676  11.821  17.662  -3.028   1.417   2.015   5.982   6.122
2  -0.544   7.753  12.006  17.799  -2.882   1.378   1.991   6.144   6.358
3  -0.523   7.747  11.984  17.806  -2.885   1.387   2.018   6.136   6.330
4  -0.395   7.786  12.131  18.056  -2.743   1.376   2.046   6.312   6.508
5  -0.347   7.853  12.169  17.998  -2.693   1.332   2.018   6.280   6.548
6  -0.344   7.882  12.198  17.999  -2.655   1.312   2.022   6.292   6.563
  layer.10 coverage_fraction
1   15.202        0.04257641
2   15.258        0.95364380
3   15.285        0.95364380
4   15.383        0.95364380
5   15.404        0.95364380
6   15.432        0.95364380

[[3]]
  layer.1 layer.2 layer.3 layer.4 layer.5 layer.6 layer.7 layer.8 layer.9
1  -1.666   5.542   9.483  10.994  -5.027   1.124   2.940   3.936   2.851
2  -1.804   5.577   9.670  11.143  -5.015   1.394   2.901   3.955   2.536
3  -1.825   5.526   9.663  10.910  -5.107   1.393   2.937   3.824   2.497
4  -1.693   5.432   9.498  10.968  -5.229   1.114   2.891   3.754   2.776
5  -1.518   5.578   9.568  11.925  -5.057   0.994   2.749   4.024   3.204
6  -1.390   5.624   9.539  12.437  -4.999   0.922   2.685   4.072   3.501
  layer.10 coverage_fraction
1   14.212        0.06267522
2   14.249        0.20578006
3   14.232        0.20578006
4   14.256        0.20578006
5   14.322        0.20578006
6   14.301        0.20578006

[[4]]
  layer.1 layer.2 layer.3 layer.4 layer.5 layer.6 layer.7 layer.8 layer.9
1   2.391  12.068  13.188  13.936   0.259   3.234   9.586  16.704  17.657
2   2.292  12.000  13.040  13.866   0.305   3.126   9.517  16.602  17.386
3   2.220  11.734  12.779  13.681   0.311   3.001   9.469  16.509  17.270
4   2.071  11.601  12.672  13.277   0.284   2.793   9.464  16.343  17.184
5   2.092  11.457  12.639  13.207   0.245   2.794   9.369  16.415  17.206
6   2.088  11.383  12.599  13.225   0.262   2.741   9.299  16.418  17.127
  layer.10 coverage_fraction
1   15.159         0.5101141
2   15.261         0.5395203
3   15.265         0.5395203
4   15.150         0.5395203
5   15.146         0.5395203
6   15.154         0.5395203

[[5]]
  layer.1 layer.2 layer.3 layer.4 layer.5 layer.6 layer.7 layer.8 layer.9
1   2.695   8.597  14.697   4.014  -2.460   4.491   9.340  14.703  19.272
2   2.705   8.694  14.659   4.176  -2.457   4.512   9.339  14.806  19.303
3   2.623   8.694  14.633   4.266  -2.476   4.521   9.317  14.817  19.264
4   2.481   8.609  14.611   4.330  -2.524   4.512   9.268  14.756  19.169
5   2.396   8.595  14.592   4.367  -2.547   4.516   9.248  14.752  19.116
6   2.315   8.562  14.577   4.389  -2.571   4.514   9.223  14.729  19.052
  layer.10 coverage_fraction
1   13.600        0.03798972
2   13.642        0.11312678
3   13.602        0.12354344
4   13.493        0.13396011
5   13.462        0.14437677
6   13.427        0.15479344</code></pre>
<p>As you can see, each <code>data.frame</code> has variables called <code>layer.1</code>, <span class="math inline">\(\dots\)</span>, <code>layer.10</code> and <code>coverage_fraction</code>. Remember that after converting a <code>stars</code> object into a <code>Raster</code><span class="math inline">\(^*\)</span> object, the information on the third dimension (here <code>date</code>) is lost. <code>layer.**d**</code> corresponds to <span class="math inline">\(d\)</span>th value stored in the date dimension of the original <code>stars</code> object. So, for example, <code>layer.5</code> corresponds to 2009-01-05.</p>
<hr />
<p>In order to make the results easier to work with, you can process them to get a single <code>data.frame</code>, taking advantage of <code>dplyr::bind_rows()</code> to combine the list of the datasets into one dataset. In doing so, you can use <code>.id</code> option to create a new identifier column that links each row to its original data (<code>data.table</code> users can use <code>rbindlist()</code> with the <code>idcol</code> option).</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="extraction-using-exactextractrexact-extract.html#cb55-1"></a>extracted_values_df &lt;-<span class="st"> </span>extracted_values <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb55-2"><a href="extraction-using-exactextractrexact-extract.html#cb55-2"></a><span class="st">  </span><span class="co">#--- combine the list of data.frames ---#</span></span>
<span id="cb55-3"><a href="extraction-using-exactextractrexact-extract.html#cb55-3"></a><span class="st">  </span><span class="kw">bind_rows</span>(., <span class="dt">.id =</span> <span class="st">&quot;rowid&quot;</span>)  </span></code></pre></div>
<p>In <code>extracted_values_df</code>, parts of the data that comes from <span class="math inline">\(n\)</span>th list has <code>rowid</code> value of <span class="math inline">\(n\)</span>. This means that the data with <code>rowid == n</code> is for <span class="math inline">\(n\)</span>th polygon in <code>KS_county_sf</code>. Therefore, we can easily merge the extracted information and <code>KS_county_sf</code> by creating an id variable that is identical with the row numbers.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="extraction-using-exactextractrexact-extract.html#cb56-1"></a>KS_county_sf &lt;-<span class="st"> </span>KS_county_sf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb56-2"><a href="extraction-using-exactextractrexact-extract.html#cb56-2"></a><span class="st">  </span><span class="co">#--- generate numeric id ---#</span></span>
<span id="cb56-3"><a href="extraction-using-exactextractrexact-extract.html#cb56-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">county_num_id =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.)) </span></code></pre></div>
<hr />
<p>Now that all the extracted data is in a single <code>data.frame</code>, we should recover the date information that was lost at the time of <code>stars</code> to <code>RasterBrick</code> conversion. To do this, we can use <code>st_get_dimension_values()</code> to first get the date values in the original <code>stars</code> object.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="extraction-using-exactextractrexact-extract.html#cb57-1"></a>dates_ls &lt;-<span class="st"> </span><span class="kw">st_get_dimension_values</span>(tmax_m1_y09_KS_stars, <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb57-2"><a href="extraction-using-exactextractrexact-extract.html#cb57-2"></a><span class="st">  </span><span class="co">#--- variable names should be character ---#</span></span>
<span id="cb57-3"><a href="extraction-using-exactextractrexact-extract.html#cb57-3"></a><span class="st">  </span><span class="kw">as.character</span>()</span></code></pre></div>
<p>We can then assign the date values as the variable names as follows:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="extraction-using-exactextractrexact-extract.html#cb58-1"></a>extracted_values_df &lt;-<span class="st"> </span>extracted_values_df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-2"><a href="extraction-using-exactextractrexact-extract.html#cb58-2"></a><span class="st">  </span><span class="kw">setnames</span>(<span class="kw">paste0</span>(<span class="st">&quot;layer.&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(dates_ls)), dates_ls)</span></code></pre></div>
<p>You can easily convert it into a long format, which is typically more convenient for further data processing.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="extraction-using-exactextractrexact-extract.html#cb59-1"></a>extracted_values_long &lt;-<span class="st"> </span><span class="kw">pivot_longer</span>(extracted_values_df, <span class="kw">c</span>(<span class="op">-</span>rowid, <span class="op">-</span>coverage_fraction), <span class="dt">names_to =</span> <span class="st">&quot;date&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;tmax&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-2"><a href="extraction-using-exactextractrexact-extract.html#cb59-2"></a><span class="st">  </span><span class="co">#--- convert from character to Date ---#</span></span>
<span id="cb59-3"><a href="extraction-using-exactextractrexact-extract.html#cb59-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">as.Date</span>(date))</span></code></pre></div>
<p>You can then summarize the data for each polygon-date combination. For example, if you would like coverage-weighted mean of tmax for each polygon, you can do the following:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="extraction-using-exactextractrexact-extract.html#cb60-1"></a>extracted_values_long <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb60-2"><a href="extraction-using-exactextractrexact-extract.html#cb60-2"></a><span class="st">  </span><span class="kw">group_by</span>(rowid, date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb60-3"><a href="extraction-using-exactextractrexact-extract.html#cb60-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="kw">sum</span>(tmax <span class="op">*</span><span class="st"> </span>coverage_fraction)<span class="op">/</span><span class="kw">sum</span>(coverage_fraction))</span></code></pre></div>
<pre><code># A tibble: 1,050 x 3
# Groups:   rowid [105]
   rowid date       `sum(tmax * coverage_fraction)/sum(coverage_fraction)`
   &lt;chr&gt; &lt;date&gt;                                                      &lt;dbl&gt;
 1 1     2009-01-01                                                  0.704
 2 1     2009-01-02                                                  8.25 
 3 1     2009-01-03                                                 13.2  
 4 1     2009-01-04                                                 19.4  
 5 1     2009-01-05                                                 -1.74 
 6 1     2009-01-06                                                  1.24 
 7 1     2009-01-07                                                  2.36 
 8 1     2009-01-08                                                  7.33 
 9 1     2009-01-09                                                  7.66 
10 1     2009-01-10                                                 15.8  
# … with 1,040 more rows</code></pre>
</div>
<div id="summarizing-the-extracted-values-inside-exact_extract" class="section level3" number="1.4.2">
<h3><span class="header-section-number">1.4.2</span> Summarizing the extracted values inside <code>exact_extract()</code></h3>
<p>Instead of returning the value from all the intersecting cells, <code>exact_extract()</code> can summarize the extracted values by polygon and then return the summarized numbers. This is much like how <code>aggregate()</code> works, which we saw above. There are multiple default options you can choose from. All you need to do is to add the desired summary function name as the third argument of <code>exact_extract()</code>. For example, the following will get us the mean of the extracted values weighted by <code>coverage_fraction</code>.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="extraction-using-exactextractrexact-extract.html#cb62-1"></a>(</span>
<span id="cb62-2"><a href="extraction-using-exactextractrexact-extract.html#cb62-2"></a>extacted_mean &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(tmax_m1_y09_KS_rb, KS_county_sf, <span class="st">&quot;mean&quot;</span>)   </span>
<span id="cb62-3"><a href="extraction-using-exactextractrexact-extract.html#cb62-3"></a>)</span></code></pre></div>
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<pre><code>    mean.layer.1 mean.layer.2 mean.layer.3 mean.layer.4 mean.layer.5
1     0.70351136     8.245142    13.214272  19.38991737 -1.738446593
2    -0.10191893     7.932328    12.460896  18.95470238 -2.342871189
3    -1.22754347     5.703299     9.563211  13.00720119 -4.827352047
4     2.62281823    11.604864    12.600451  15.20523167  0.098847926
5     2.23965144     9.153767    13.622676   6.50082016 -1.968742728
6     0.74984622     8.350090    13.372252  21.17984200 -1.260589600
7    -1.53988183     5.234149     8.736140   9.66305256 -5.350415230
8     1.71388805     8.440231    12.574240  14.00719261 -1.360022902
9     0.61160660     7.854358    12.633851  13.62496090 -2.404829025
10    2.67427158    10.441068    11.700580  21.47598648 -0.462472916
11    2.13225913     8.827114    13.805976  22.36149216  0.003791556
12    5.86026096     7.858763    19.140535   0.46220100 -1.242904782
13    4.75798702    14.760186    16.101652  16.82142067  0.156729117
14    0.21882862     6.549259    11.627972   6.68853760 -3.862231255
15   -0.09769533     6.851544    11.788856   5.04193306 -3.428673983
16   -0.34123743     7.930270    12.124799  17.38428879 -2.716316462
17    3.73477387    13.283279    14.402586  17.12748146  0.313392669
18    2.31066680     9.298834    11.089808  16.94831085 -0.835903764
19    1.47230101     8.383532    13.558976  21.63944244 -0.271432787
20    3.18585181     7.444498    16.871641  -0.69584364 -0.852988720
21    1.70233095     7.104459    12.556689   8.83697796 -3.195532560
22   -1.29303753     4.906859     8.771229  11.00326061 -5.730754852
23   -0.69985610     7.213567    10.883278  17.72315216 -3.443958282
24    2.94718695    12.363817    14.690255  10.61329842 -0.863278151
25    1.81908453     9.467833    12.122618  19.49016953 -0.878729820
26    2.73625898     8.437631    14.995607   2.61929774 -2.265066147
27    1.21023309     7.837215    13.324194   5.75148678 -2.584592819
28    5.29390717    13.818607    18.003904   8.80731297 -1.775831938
29    3.79063153    14.190764    16.497419  11.99686241 -1.079543591
30   -0.74796224     7.405661    11.498960  18.28328705 -3.122235060
31    0.13511652     6.696955    12.146982  10.50378895 -3.633607626
32    3.69514060     9.226775    16.274940   2.29995704 -1.651724339
33    3.12260079     8.204881    15.011528   0.46572676 -1.720995426
34    8.12845802    14.966170    20.180084  13.46672249 -1.662024736
35    4.40006828    14.324323    17.713417  10.85753155 -1.716818452
36    7.73141718    11.749987    18.637899   5.17361641 -1.510375023
37    1.00910187     8.668888    12.623693  17.36485672 -1.486948133
38    8.94485474    13.572463    19.077152   8.82075405 -2.043977499
39    2.23534131    10.190441    11.528857  14.61020184 -0.237510264
40    1.15820491     8.432584    12.217549  10.48284531 -2.073924303
41    6.44248819    15.018713    18.993431  13.25049210 -1.277440906
42    3.69778800    13.583066    16.470251   8.66716957 -1.756125808
43   -1.17190957     5.950772     9.991387  12.09021378 -4.484534740
44   -0.89916795     6.432462    10.271325  15.81192017 -4.187053680
45   -0.64862430     7.225645    11.477347   3.97085047 -2.531219721
46   -1.13759923     6.440622    10.475100  18.90671539 -3.489784002
47    7.46681595    13.737487    18.997866  10.02016544 -1.957920432
48    1.69497585    10.052828    11.859150  11.92744255 -0.592457771
49    2.92541695    12.848423    14.510609  12.65587807 -0.433746636
50    1.87426841     8.637786    13.599962  21.73176384 -0.758635581
51    4.36128664    12.171407    17.606804   5.33854818 -1.853681087
52   -0.94544649     6.150405    10.084399  16.62258148 -4.146828175
53    0.84613425     7.373491    13.784738   5.19747162 -3.056994677
54   -0.16769440     7.851293    12.434641  20.32059860 -2.002675533
55    4.67357397     9.794602    17.531445   4.70527554 -1.011406422
56   -0.17090045     7.623302    12.071114  15.36985111 -2.792487383
57    1.12187612     8.281607    12.328888   8.26296043 -2.271543503
58    1.04127812     7.763101    12.418225  11.00451565 -2.621742964
59   -1.05458665     6.124114     9.056909   5.77868509 -4.109149933
60    5.81701231    15.332402    17.806080  16.31328392 -0.396336526
61   -0.94318950     6.956118    10.960990  19.52577400 -3.055749655
62    0.35581541     7.366903    13.266233   4.73208904 -2.782687664
63    2.05318809     9.549910    12.979400  21.87686920 -0.622698247
64   -0.31458351     6.738388    11.979355  12.24590683 -3.482398272
65    9.50877953    15.183223    20.702177  17.53730011 -1.463043451
66   -1.44522655     5.499273     8.655470   8.02225590 -4.632665634
67    1.38364363     8.165549    13.411731  20.57429886 -1.330177665
68    3.39862370    11.814606    16.250645   5.06956148 -2.150942326
69    2.21096444     7.704083    14.494526  -0.09258448 -1.236304402
70   -0.61300737     7.460170    11.634279  16.70393753 -3.244388580
71    1.83869648     7.783587    14.616658   3.20968127 -2.608352184
72    0.88888782     6.960223    12.810863   5.94945908 -3.465459347
73    2.95394397    11.519921    14.648426   8.18758678 -1.371018529
74    2.03086567     7.489221    14.343473   0.93294013 -1.961974978
75   -0.59876496     6.125490    10.540584   9.59593868 -4.147626877
76    2.01599574    11.243022    12.799949  12.42138004  0.201648518
77    4.76784754     7.518116    18.791695  -0.26356536 -0.681705952
78    1.21307456     9.733344    12.137431   9.38590527 -1.202627301
79   -0.67744142     6.843583    10.744307   4.41120720 -3.267356396
80    1.25195622     8.604998    12.675180   7.29818821 -1.930691600
81    0.03638019     6.489722    11.326155   8.28431320 -3.882951736
82    3.54538465     8.289118    15.041138   1.23137796 -2.269782782
83    3.72036457    10.040650    14.975635   5.22179174 -2.280197620
84    1.75560880     7.987249    14.600950   4.09021378 -2.761831045
85    1.07903564     7.493184    12.655621   6.51456881 -2.956942320
86    4.90620089    11.962405    17.588787   5.85287380 -1.760897875
87    1.56271791     8.694112    11.709779  12.07033443 -1.265539289
88    7.27548027    15.892849    19.357677  16.99795532 -0.274422377
89   -0.49625471     6.953659    11.074713  15.44565201 -3.605958223
90    3.22970939     7.814662    16.013432   0.55027246 -1.438064933
91    5.04852629     8.392007    19.191233   3.43102002 -1.743004322
92    0.77319115     7.268792    13.412246   2.58885217 -2.342285633
93    2.05321956    10.510877    13.042306  10.11344624 -0.639760971
94    9.35150909    14.610689    21.076834  15.02815914 -1.985622168
95    8.49344921    15.873698    20.273939  17.50824165 -0.486420751
96    2.43191361     9.510320    10.946580  15.26636314 -0.467334151
97    3.81495738     8.186193    17.640615   1.91789234 -1.107007742
98    2.99098253     8.723813    15.062769   1.43042254 -1.919782043
99   -0.75638896     6.581856    11.268191  13.38694286 -3.992025375
100   6.46377802     9.995872    18.915541   4.98032331 -1.279720187
101  -0.80600458     6.755408     9.919728   5.03966808 -3.853855371
102   6.25559378    11.716198    17.777464   6.69806623 -1.567839265
103   1.47452664     8.980499    12.812661  20.55772781 -1.014705062
104   0.39539194     8.507732    12.768641  18.95978737 -1.818284512
105  -0.94089907     6.419802    10.426237  18.64139557 -3.318722248
    mean.layer.6 mean.layer.7 mean.layer.8 mean.layer.9 mean.layer.10
1      1.2371500     2.363872     7.333200     7.661112     15.753071
2      1.2627786     2.298537     6.604548     6.575373     15.767478
3      1.0112866     2.593534     4.239894     3.920052     14.265254
4      3.0234931     8.596673    17.024591    16.366323     15.871804
5      3.9445314     9.065735    15.379592    18.763727     13.982010
6      1.1100723     3.062339     7.112000     7.105553     16.864832
7      0.3655367     3.201526     3.298370     3.411432     13.805099
8      2.4498131     2.629557    10.342471    10.431979     17.117462
9      2.3100524     2.843310     8.709601     9.299550     15.734372
10     1.3376291     2.449276    11.688751    10.562595     18.207508
11     1.8255717     2.616267     8.290398     9.144671     16.781599
12     6.1764774     7.283258    13.604939    18.203562      7.869013
13     6.2227092    10.370955    18.639774    19.631033     16.511066
14     2.6685946     6.743182     7.130967     8.680034     12.785807
15     3.0565031     8.255677     8.042775     9.391355     11.814754
16     1.3355118     1.849987     6.482727     6.918704     15.245775
17     4.6906667    10.001215    18.125460    18.589598     16.370871
18     2.1339493     1.926307    11.287497    10.951304     18.493641
19     1.1740626     2.897195     7.448478     8.227261     16.503309
20     4.5406384     9.049601    11.543014    19.096294     10.253411
21     2.9839005     5.907438     8.916230    10.667792     14.142785
22     0.8586771     2.869056     3.272631     3.508464     13.942183
23     1.7332202     2.687034     5.656171     5.287071     15.223598
24     4.5281630     9.835311    16.716187    18.917719     14.955274
25     1.7487094     2.373982    10.919181     9.770478     17.300205
26     4.6467400     9.592978    14.384918    19.605453     13.353614
27     3.6850865     8.060434    12.966660    15.769124     13.885804
28     6.4847889     9.186861    17.571150    19.798059     14.130003
29     5.7222128     9.957215    17.539810    19.272112     15.145851
30     1.5165842     2.315939     5.703478     5.354421     15.578660
31     2.4548078     3.941454     6.828683     8.186698     13.990755
32     5.3562703     8.852802    14.796917    19.502489     12.154106
33     4.8755851     9.646011    13.711706    19.560047     12.004269
34     7.3913598     9.420206    18.446276    19.451790     14.737358
35     6.0219288     9.389985    17.713203    19.193050     14.871526
36     6.3506913     7.840635    17.035995    19.802849     10.794697
37     1.9703251     2.288678     9.581449     9.178806     16.598799
38     7.4076052     8.735802    17.928137    20.183001     12.424517
39     2.5098076     5.333600    14.762303    14.221740     16.170998
40     2.4339838     4.615407    11.022880    10.766328     15.711755
41     6.8901753     9.538710    18.305073    19.422800     15.150553
42     5.8943453     9.898430    16.972713    19.651947     14.949874
43     1.2934214     2.840298     4.775581     4.280317     14.294275
44     1.4558783     2.503446     5.088395     4.634137     14.611388
45     3.6901672     9.297148     7.951982     9.286806     10.339839
46     1.4560846     2.542523     5.164001     4.253300     15.656581
47     7.2159262     8.841626    17.551924    19.928085     13.243657
48     2.3517125     6.489462    14.099052    14.070302     15.688309
49     4.3451605     9.877497    17.043055    18.629183     15.140188
50     0.9317478     2.829562     8.949985     8.753012     16.280022
51     6.3059006     9.236671    16.579908    19.956318     13.578638
52     1.2931409     2.784007     4.637456     4.573217     14.815842
53     3.9050906     8.698529    12.171005    14.970185     12.991460
54     1.0497535     2.887083     6.393522     5.675831     16.777159
55     5.6342335     8.110706    15.719603    19.330187     10.851563
56     1.8322314     2.236289     7.069078     7.625106     15.397491
57     2.7613165     6.434660    11.972925    12.793124     14.642884
58     2.4720845     3.907016     9.557635    10.109374     14.756696
59     2.3438802     6.254457     4.607714     5.278028     11.847061
60     6.7311563     9.982401    18.564695    19.524824     16.225517
61     1.2230753     2.658687     5.594224     4.219906     16.429888
62     4.1161962     9.220021     9.860440    12.424013     12.135124
63     1.1733199     2.721375    10.050296     9.317306     16.555250
64     2.1433094     3.007261     7.068172     8.172933     14.468101
65     8.8910666     9.171908    18.705048    18.905174     14.225714
66     1.4910083     4.539019     3.860881     3.932306     12.793352
67     1.1899371     2.752652     8.281857     8.151873     15.968338
68     5.7997522     9.923387    15.961509    20.034517     14.493691
69     4.2818489     9.884715    11.585449    18.467756     10.064379
70     1.7785209     2.230910     5.956362     6.086363     15.176054
71     4.5819464     9.424000    12.223347    16.553566     12.207571
72     3.3391292     7.663972     9.888658    12.273598     13.210464
73     4.6272135     9.813349    16.229500    19.459370     14.535102
74     4.3744206     9.655432    11.126178    16.917635     10.323145
75     2.2396839     4.264341     5.528427     5.995719     13.725663
76     2.7094035     9.318349    16.109858    17.538925     14.738901
77     5.1066794     8.190598    12.137335    18.719463      8.885968
78     2.4525976     7.327823    14.105403    14.602164     14.931720
79     3.2384617     8.811017     7.422620     7.891792     10.520598
80     3.1741235     7.880817    14.277733    16.239315     14.123322
81     2.5409074     5.342842     6.383720     7.672455     13.386035
82     4.6818967     9.628188    13.621945    19.020470     11.423682
83     4.7367692     9.603511    15.519748    19.949751     14.245599
84     4.4688201     9.162308    13.675659    17.933142     12.996178
85     3.3134067     7.608942    11.613931    13.496713     14.111835
86     6.1132193     8.457271    16.677158    19.732420     12.426081
87     2.1873510     3.678482    11.073653    10.904830     16.475346
88     7.3391905     9.877522    18.837149    19.480186     16.187263
89     2.0668864     2.699299     5.675470     5.377167     14.679996
90     4.7583370     8.735242    13.215721    19.027893     11.066181
91     5.7549348     7.094448    14.720095    17.881935      8.402155
92     4.3044181     9.527791     9.397928    13.258157     10.801931
93     3.1176846     9.267877    15.903204    18.128529     14.360680
94     8.7151575     9.384543    18.746689    19.316906     13.754063
95     8.0580444     9.677222    18.945532    19.246239     15.593541
96     2.4153540     2.793728    12.013740    11.800061     18.117397
97     4.9516716     8.068429    13.767962    18.866226     10.072131
98     4.9996495     9.447617    14.500510    19.359186     13.230801
99     1.8133308     2.417939     5.832313     6.468982     14.368323
100    5.7055979     7.612878    16.277016    18.794102      9.805455
101    2.6428590     7.691157     6.325460     6.664940     11.221939
102    6.2092814     7.433998    16.776394    19.644491     11.482943
103    1.6613088     2.720165     9.331095     8.557424     16.079695
104    1.3753322     2.195959     7.903357     7.922072     15.709354
105    1.7554719     2.929620     4.881440     4.259132     15.744514</code></pre>
<p>As you can see, the outcome has only the mean of the extracted values weighted by <code>coverage_fraction</code>, with only one row per polygon. Since the <span class="math inline">\(n\)</span>th row of the outcome is <span class="math inline">\(n\)</span>th polygon of the <code>sf</code>, it can be easily merged with the <code>sf</code> just like the previous no-summary case. Post-extraction process is just as easy as it was for the no-summary case.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="extraction-using-exactextractrexact-extract.html#cb65-1"></a>(</span>
<span id="cb65-2"><a href="extraction-using-exactextractrexact-extract.html#cb65-2"></a>mean_tmax_long &lt;-<span class="st"> </span>extacted_mean <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb65-3"><a href="extraction-using-exactextractrexact-extract.html#cb65-3"></a><span class="st">  </span><span class="co">#--- recover dates  ---#</span></span>
<span id="cb65-4"><a href="extraction-using-exactextractrexact-extract.html#cb65-4"></a><span class="st">  </span><span class="kw">setnames</span>(<span class="kw">names</span>(.), dates_ls) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb65-5"><a href="extraction-using-exactextractrexact-extract.html#cb65-5"></a><span class="st">  </span><span class="co">#--- create rowid ---#</span></span>
<span id="cb65-6"><a href="extraction-using-exactextractrexact-extract.html#cb65-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rowid =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb65-7"><a href="extraction-using-exactextractrexact-extract.html#cb65-7"></a><span class="st">  </span><span class="co">#--- wide to long ---#</span></span>
<span id="cb65-8"><a href="extraction-using-exactextractrexact-extract.html#cb65-8"></a><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>rowid, <span class="dt">names_to =</span> <span class="st">&quot;date&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;tmax&quot;</span>)</span>
<span id="cb65-9"><a href="extraction-using-exactextractrexact-extract.html#cb65-9"></a>)</span></code></pre></div>
<pre><code># A tibble: 1,050 x 3
   rowid date         tmax
   &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;
 1     1 2009-01-01  0.704
 2     1 2009-01-02  8.25 
 3     1 2009-01-03 13.2  
 4     1 2009-01-04 19.4  
 5     1 2009-01-05 -1.74 
 6     1 2009-01-06  1.24 
 7     1 2009-01-07  2.36 
 8     1 2009-01-08  7.33 
 9     1 2009-01-09  7.66 
10     1 2009-01-10 15.8  
# … with 1,040 more rows</code></pre>
<p>There are other options that may be of interest, such as “max”, “min.” You can see all the default options at h<a href="https://isciences.gitlab.io/exactextractr/index.html">the package website</a>.</p>
<hr />
<p>When we found the mean of tmax weighted by coverage fraction, each raster cell was assumed to cover the same area. This is not correct for rasters in geographic coordinates (latitude/longitude). To see this, let’s find the area of each cell using <code>raster::area()</code>.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="extraction-using-exactextractrexact-extract.html#cb67-1"></a>(</span>
<span id="cb67-2"><a href="extraction-using-exactextractrexact-extract.html#cb67-2"></a>raster_area_data &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">area</span>(tmax_m1_y09_KS_rb)</span>
<span id="cb67-3"><a href="extraction-using-exactextractrexact-extract.html#cb67-3"></a>)</span></code></pre></div>
<pre><code>class      : RasterLayer 
dimensions : 73, 179, 13067  (nrow, ncol, ncell)
resolution : 0.04166667, 0.04166667  (x, y)
extent     : -102.0625, -94.60417, 36.97917, 40.02083  (xmin, xmax, ymin, ymax)
crs        : +proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0 
source     : memory
names      : layer 
values     : 16.39299, 17.0875  (min, max)</code></pre>
<p>The output is a <code>RasterLayer</code>, where the area of the cells are stored as <code>values</code>. Figure <a href="extraction-using-exactextractrexact-extract.html#fig:prism-raster-area">1.7</a> shows the map of the PRISM raster cells in Kansas, color-differentiated by area.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="extraction-using-exactextractrexact-extract.html#cb69-1"></a><span class="kw">tm_shape</span>(raster_area_data) <span class="op">+</span></span>
<span id="cb69-2"><a href="extraction-using-exactextractrexact-extract.html#cb69-2"></a><span class="st">  </span><span class="kw">tm_raster</span>() <span class="op">+</span></span>
<span id="cb69-3"><a href="extraction-using-exactextractrexact-extract.html#cb69-3"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">FALSE</span>) </span></code></pre></div>
<div class="figure"><span id="fig:prism-raster-area"></span>
<img src="R_GIS_Book_files/figure-html/prism-raster-area-1.png" alt="Area of PRISM raster cells" width="672" />
<p class="caption">
Figure 1.7: Area of PRISM raster cells
</p>
</div>
<p>The area of a raster cell becomes smaller as the latitude increases. This is mainly due to the fact that 1 degree in longitude is longer in actual length on the earth surface at a lower latitude than at a higher latitude.<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a> The mean of extracted values weighted by coverage fraction ignores this fact and implicitly assumes the all the cells have the same area.</p>
<p>In order to get an area-weighted mean instead of a coverage-weighted mean, you can use the “weighted_mean” option as the third argument and also supply the <code>RasterLayer</code> of area (<code>raster_area_data</code>) like this:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="extraction-using-exactextractrexact-extract.html#cb70-1"></a>extacted_weighted_mean &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(tmax_m1_y09_KS_rb, KS_county_sf, <span class="st">&quot;weighted_mean&quot;</span>, <span class="dt">weights =</span> raster_area_data)   </span></code></pre></div>
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<p>Let’s compare the difference in the calculated means from the two methods for the first polygon.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="extraction-using-exactextractrexact-extract.html#cb72-1"></a>extacted_weighted_mean[<span class="dv">1</span>, ] <span class="op">-</span><span class="st"> </span>extacted_mean[<span class="dv">1</span>, ]</span></code></pre></div>
<pre><code>  weighted_mean.layer.1 weighted_mean.layer.2 weighted_mean.layer.3
1          0.0002688766          0.0001029968          9.536743e-05
  weighted_mean.layer.4 weighted_mean.layer.5 weighted_mean.layer.6
1         -0.0001659393          0.0001614094           0.000130415
  weighted_mean.layer.7 weighted_mean.layer.8 weighted_mean.layer.9
1          6.151199e-05          0.0003457069          0.0003004074
  weighted_mean.layer.10
1           2.765656e-05</code></pre>
<p>As you can see the error is minimal. So, the consequence of using coverage-weighted means should be negligible. Indeed, unless polygons span a wide range of latitudes, the error introduce by using the coverage-weighted mean instead of area-weighted mean should be negligible. For economists, it is hard to imagine working with such polygons. Moreover, most environmental data exhibits a high positive spatial correlation. This also helps alleviate errors from just using coverage-weighted mean.</p>
</div>
<div id="extraction-from-raster-data-with-discrete-values-and-post-extraction-processing" class="section level3" number="1.4.3">
<h3><span class="header-section-number">1.4.3</span> Extraction from raster data with discrete values and post-extraction processing</h3>
<p>A good example of raster data with discrete values are land use data like Cropland Data Layer by USDA NASS. For such data, we are not interested in finding the numerical mean of land use categories, which does not make any sense. Rather, we would be interested in a summary statistics like frequency. There is nothing special at the stage of data extraction for this kind of data. You just use <code>exact_extract()</code> the same way as we saw for the PRISM tmax data.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="extraction-using-exactextractrexact-extract.html#cb74-1"></a>cdl_KS_stack &lt;-<span class="st"> </span><span class="kw">stack</span>(<span class="st">&quot;./Data/CDL_2015_20.tif&quot;</span>, <span class="st">&quot;./Data/CDL_2016_20.tif&quot;</span>) </span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="extraction-using-exactextractrexact-extract.html#cb75-1"></a><span class="kw">plot</span>(cdl_KS_stack)</span></code></pre></div>
<div class="figure"><span id="fig:map-cdl-ks1"></span>
<img src="R_GIS_Book_files/figure-html/map-cdl-ks-1.png" alt="Map of CDL data for Kansas in 2015" width="672" />
<p class="caption">
Figure 1.8: Map of CDL data for Kansas in 2015
</p>
</div>
<div class="figure"><span id="fig:map-cdl-ks2"></span>
<img src="R_GIS_Book_files/figure-html/map-cdl-ks-2.png" alt="Map of CDL data for Kansas in 2015" width="672" />
<p class="caption">
Figure 1.9: Map of CDL data for Kansas in 2015
</p>
</div>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="extraction-using-exactextractrexact-extract.html#cb76-1"></a>extracted_cdl_KS &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(cdl_KS_stack, KS_county_sf)</span></code></pre></div>
<pre><code>
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |==                                                                    |   3%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  15%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |================                                                      |  23%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |=================                                                     |  25%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |===================                                                   |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  30%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |=================================                                     |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  54%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  58%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |=============================================                         |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |===============================================                       |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  77%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |==============================================================        |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |=================================================================     |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  95%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="extraction-using-exactextractrexact-extract.html#cb78-1"></a>extracted_cdl_KS[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">lapply</span>(head) </span></code></pre></div>
<pre><code>[[1]]
   CDL_2015_20 CDL_2016_20 coverage_fraction
12           5           1         0.7126102
13           5           1         0.7250234
14           5           1         0.6992073
15           5           1         0.6733912
16           5           1         0.6475750
17           5           1         0.6217588

[[2]]
     CDL_2015_20 CDL_2016_20 coverage_fraction
1238         176         176       0.002713649
1239         176         176       0.009977066
1240         176         176       0.017312184
1241         176         176       0.024647303
1242         121         121       0.031982422
1243           5          24       0.039317537

[[3]]
     CDL_2015_20 CDL_2016_20 coverage_fraction
1246           5           1       0.001770655
1247           5           1       0.009396468
1248           5           1       0.017485233
1249           5           1       0.025573997
1250           5           1       0.033662762
1251         121         121       0.041751526

[[4]]
   CDL_2015_20 CDL_2016_20 coverage_fraction
38         176         176        0.03100549
39         176         176        0.52686423
40         176         176        0.49798685
41         176         176        0.46910948
42         176         176        0.44023213
43         176         176        0.41135478

[[5]]
   CDL_2015_20 CDL_2016_20 coverage_fraction
42         176         176        0.02409048
43         176         176        0.08381898
44         176         176        0.06831746
45         176         176        0.05281594
46         176         176        0.03731442
47         176         176        0.02181290</code></pre>
<p>As you can see, the format of the extracted data is exactly the same as the tmax case we saw above. Let’s combine them into one <code>data.frame</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="extraction-using-exactextractrexact-extract.html#cb80-1"></a>extracted_cdl_KS_df &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(extracted_cdl_KS, <span class="dt">.id =</span> <span class="st">&quot;rowid&quot;</span>) </span>
<span id="cb80-2"><a href="extraction-using-exactextractrexact-extract.html#cb80-2"></a></span>
<span id="cb80-3"><a href="extraction-using-exactextractrexact-extract.html#cb80-3"></a><span class="kw">head</span>(extracted_cdl_KS_df)</span></code></pre></div>
<pre><code>  rowid CDL_2015_20 CDL_2016_20 coverage_fraction
1     1           5           1         0.7126102
2     1           5           1         0.7250234
3     1           5           1         0.6992073
4     1           5           1         0.6733912
5     1           5           1         0.6475750
6     1           5           1         0.6217588</code></pre>
<p>We can now use group operations using the dplyr functionality to get the frequency of each land use type value:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="extraction-using-exactextractrexact-extract.html#cb82-1"></a>extracted_cdl_KS_df <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb82-2"><a href="extraction-using-exactextractrexact-extract.html#cb82-2"></a><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="kw">c</span>(<span class="op">-</span>rowid, <span class="op">-</span>coverage_fraction), <span class="dt">names_to =</span> <span class="st">&quot;year&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb82-3"><a href="extraction-using-exactextractrexact-extract.html#cb82-3"></a><span class="st">  </span><span class="kw">group_by</span>(rowid, value, year) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb82-4"><a href="extraction-using-exactextractrexact-extract.html#cb82-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">count =</span> <span class="kw">n</span>())</span></code></pre></div>
<pre><code># A tibble: 6,296 x 4
# Groups:   rowid, value [3,427]
   rowid value year         count
   &lt;chr&gt; &lt;int&gt; &lt;chr&gt;        &lt;int&gt;
 1 1         1 CDL_2015_20 133397
 2 1         1 CDL_2016_20 159844
 3 1         4 CDL_2015_20   3846
 4 1         4 CDL_2016_20   3036
 5 1         5 CDL_2015_20 229788
 6 1         5 CDL_2016_20 244820
 7 1         6 CDL_2016_20      1
 8 1        24 CDL_2015_20  51825
 9 1        24 CDL_2016_20  16829
10 1        26 CDL_2015_20  53261
# … with 6,286 more rows</code></pre>
<p>Here is the <code>data.table</code> way.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="extraction-using-exactextractrexact-extract.html#cb84-1"></a>extracted_cdl_KS <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb84-2"><a href="extraction-using-exactextractrexact-extract.html#cb84-2"></a><span class="st">  </span><span class="co">#--- combine the data.frames into one ---#</span></span>
<span id="cb84-3"><a href="extraction-using-exactextractrexact-extract.html#cb84-3"></a><span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;rowid&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb84-4"><a href="extraction-using-exactextractrexact-extract.html#cb84-4"></a><span class="st">  </span><span class="co">#--- wide to long ---#</span></span>
<span id="cb84-5"><a href="extraction-using-exactextractrexact-extract.html#cb84-5"></a><span class="st">  </span><span class="kw">melt</span>(<span class="dt">id.vars =</span> <span class="kw">c</span>(<span class="st">&quot;rowid&quot;</span>, <span class="st">&quot;coverage_fraction&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb84-6"><a href="extraction-using-exactextractrexact-extract.html#cb84-6"></a><span class="st">  </span><span class="co">#--- get counts ---#</span></span>
<span id="cb84-7"><a href="extraction-using-exactextractrexact-extract.html#cb84-7"></a><span class="st">  </span>.[, .(<span class="dt">count =</span> .N) , by =<span class="st"> </span>.(rowid, variable, value)]  </span></code></pre></div>
<pre><code>      rowid    variable value  count
   1:     1 CDL_2015_20     5 229788
   2:     1 CDL_2015_20   141 143961
   3:     1 CDL_2015_20   176 660771
   4:     1 CDL_2015_20     1 133397
   5:     1 CDL_2015_20   121  66187
  ---                               
6292:   105 CDL_2016_20    24    203
6293:   105 CDL_2016_20    58     37
6294:   105 CDL_2016_20    74     22
6295:   105 CDL_2016_20   143     76
6296:   105 CDL_2016_20   142     31</code></pre>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="9">
<li id="fn9"><p>The opposite happens in the southern hemisphere.<a href="extraction-using-exactextractrexact-extract.html#fnref9" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="extraction-stars-polygons.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="speed-comparison.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"toc_depth": 3,
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
