<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1.3 Demonstration 3: Land Use and Weather | R as GIS for Economists</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="1.3 Demonstration 3: Land Use and Weather | R as GIS for Economists" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1.3 Demonstration 3: Land Use and Weather | R as GIS for Economists" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Taro Mieno" />


<meta name="date" content="2020-06-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="demonstration-2-precision-agriculture.html"/>
<link rel="next" href="demo4.html"/>
<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/PopupTable-0.0.1/popup.css" rel="stylesheet" />
<script src="libs/IA_cdl_2015-1/data_stars_IA_cdl_201574de52.txt"></script>
<script src="libs/joda-0.0.1/joda.js"></script>
<script src="libs/joda-0.0.1/addImageQuery-bindings.js"></script>
<script src="libs/IA_cdl_2016-1/data_stars_IA_cdl_20169e8ac2.txt"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R as GIS for Economists</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html"><i class="fa fa-check"></i>Why R as GIS for Economists?</a>
<ul>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#r-vs-python"><i class="fa fa-check"></i>R vs Python</a></li>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#r-vs-arcgis-or-qgis"><i class="fa fa-check"></i>R vs ArcGIS or QGIS</a></li>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#summary"><i class="fa fa-check"></i>Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="how-is-this-book-different-from-other-online-books-and-resources.html"><a href="how-is-this-book-different-from-other-online-books-and-resources.html"><i class="fa fa-check"></i>How is this book different from other online books and resources?</a></li>
<li class="chapter" data-level="" data-path="what-is-going-to-be-covered-in-this-book.html"><a href="what-is-going-to-be-covered-in-this-book.html"><i class="fa fa-check"></i>What is going to be covered in this book?</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html"><i class="fa fa-check"></i>Conventions of the book and some notes</a>
<ul>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#texts-in-gray-boxes"><i class="fa fa-check"></i>Texts in gray boxes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#colored-boxes"><i class="fa fa-check"></i>Colored Boxes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#parentheses-around-codes"><i class="fa fa-check"></i>Parentheses around codes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#footnotes"><i class="fa fa-check"></i>Footnotes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information.html"><a href="session-information.html"><i class="fa fa-check"></i>Session Information</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="demo.html"><a href="demo.html"><i class="fa fa-check"></i><b>1</b> R as GIS: Demonstrations</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start.html"><a href="before-you-start.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start.html"><a href="before-you-start.html#target-audience"><i class="fa fa-check"></i>Target Audience</a></li>
<li class="chapter" data-level="" data-path="before-you-start.html"><a href="before-you-start.html#direction-for-replication"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="1.1" data-path="Demo1.html"><a href="Demo1.html"><i class="fa fa-check"></i><b>1.1</b> Demonstration 1: The impact of groundwater pumping on depth to water table</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="Demo1.html"><a href="Demo1.html#project-overview"><i class="fa fa-check"></i><b>1.1.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.1.2" data-path="Demo1.html"><a href="Demo1.html#project-demonstration"><i class="fa fa-check"></i><b>1.1.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="demonstration-2-precision-agriculture.html"><a href="demonstration-2-precision-agriculture.html"><i class="fa fa-check"></i><b>1.2</b> Demonstration 2: Precision Agriculture</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="demonstration-2-precision-agriculture.html"><a href="demonstration-2-precision-agriculture.html#project-overview-1"><i class="fa fa-check"></i><b>1.2.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.2.2" data-path="demonstration-2-precision-agriculture.html"><a href="demonstration-2-precision-agriculture.html#project-demonstration-1"><i class="fa fa-check"></i><b>1.2.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="demonstration-3-land-use-and-weather.html"><a href="demonstration-3-land-use-and-weather.html"><i class="fa fa-check"></i><b>1.3</b> Demonstration 3: Land Use and Weather</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="demonstration-3-land-use-and-weather.html"><a href="demonstration-3-land-use-and-weather.html#project-overview-2"><i class="fa fa-check"></i><b>1.3.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.3.2" data-path="demonstration-3-land-use-and-weather.html"><a href="demonstration-3-land-use-and-weather.html#project-demonstration-2"><i class="fa fa-check"></i><b>1.3.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="demo4.html"><a href="demo4.html"><i class="fa fa-check"></i><b>1.4</b> Demonstration 4: The Impact of Railroad Presence on Corn Planted Acreage</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="demo4.html"><a href="demo4.html#project-overview-3"><i class="fa fa-check"></i><b>1.4.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.4.2" data-path="demo4.html"><a href="demo4.html#project-demonstration-3"><i class="fa fa-check"></i><b>1.4.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><a href="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><i class="fa fa-check"></i><b>1.5</b> Demonstration 5: Groundwater use for agricultural irrigation</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><a href="demonstration-5-groundwater-use-for-agricultural-irrigation.html#project-overview-4"><i class="fa fa-check"></i><b>1.5.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.5.2" data-path="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><a href="demonstration-5-groundwater-use-for-agricultural-irrigation.html#project-demonstration-4"><i class="fa fa-check"></i><b>1.5.2</b> Project Demonstration</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="vector-basics.html"><a href="vector-basics.html"><i class="fa fa-check"></i><b>2</b> Vector Data Handling with <code>sf</code></a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-1.html"><a href="before-you-start-1.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li><a href="before-you-start-1.html#sf-or-sp"><code>sf</code> or <code>sp</code>?</a></li>
<li class="chapter" data-level="" data-path="before-you-start-1.html"><a href="before-you-start-1.html#direction-for-replication-1"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="2.1" data-path="spatial-data-structure.html"><a href="spatial-data-structure.html"><i class="fa fa-check"></i><b>2.1</b> Spatial Data Structure</a></li>
<li class="chapter" data-level="2.2" data-path="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><a href="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><i class="fa fa-check"></i><b>2.2</b> Simple feature geometry, simple feature geometry list-column, and simple feature</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><a href="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html#simple-feature-geometry-sfg"><i class="fa fa-check"></i><b>2.2.1</b> Simple feature geometry (<code>sfg</code>)</a></li>
<li class="chapter" data-level="2.2.2" data-path="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><a href="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html#create-simple-feature-geometry-list-column-sfc-and-simple-feature-sf-from-scratch"><i class="fa fa-check"></i><b>2.2.2</b> Create simple feature geometry list-column (<code>sfc</code>) and simple feature (<code>sf</code>) from scratch</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html"><i class="fa fa-check"></i><b>2.3</b> Reading and writing vector data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html#reading-a-shapefile"><i class="fa fa-check"></i><b>2.3.1</b> Reading a shapefile</a></li>
<li class="chapter" data-level="2.3.2" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html#writing-to-a-shapefile"><i class="fa fa-check"></i><b>2.3.2</b> Writing to a shapefile</a></li>
<li class="chapter" data-level="2.3.3" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html#better-alternatives"><i class="fa fa-check"></i><b>2.3.3</b> Better alternatives</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="projection-with-a-different-coordinate-reference-systems.html"><a href="projection-with-a-different-coordinate-reference-systems.html"><i class="fa fa-check"></i><b>2.4</b> Projection with a different Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.5" data-path="interactive-view-of-an-sf-object.html"><a href="interactive-view-of-an-sf-object.html"><i class="fa fa-check"></i><b>2.5</b> Interactive view of an <code>sf</code> object</a></li>
<li class="chapter" data-level="2.6" data-path="turning-a-data-frame-of-points-into-an-sf.html"><a href="turning-a-data-frame-of-points-into-an-sf.html"><i class="fa fa-check"></i><b>2.6</b> Turning a data.frame of points into an <code>sf</code></a></li>
<li class="chapter" data-level="2.7" data-path="conv-sp.html"><a href="conv-sp.html"><i class="fa fa-check"></i><b>2.7</b> Conversion to and from sp</a></li>
<li class="chapter" data-level="2.8" data-path="non-spatial-transformation-of-sf.html"><a href="non-spatial-transformation-of-sf.html"><i class="fa fa-check"></i><b>2.8</b> Non-spatial transformation of sf</a></li>
<li class="chapter" data-level="2.9" data-path="non-interactive-geometrical-operations.html"><a href="non-interactive-geometrical-operations.html"><i class="fa fa-check"></i><b>2.9</b> Non-interactive geometrical operations</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="non-interactive-geometrical-operations.html"><a href="non-interactive-geometrical-operations.html#st_buffer"><i class="fa fa-check"></i><b>2.9.1</b> st_buffer</a></li>
<li class="chapter" data-level="2.9.2" data-path="non-interactive-geometrical-operations.html"><a href="non-interactive-geometrical-operations.html#st_area"><i class="fa fa-check"></i><b>2.9.2</b> st_area</a></li>
<li class="chapter" data-level="2.9.3" data-path="non-interactive-geometrical-operations.html"><a href="non-interactive-geometrical-operations.html#st_centroid"><i class="fa fa-check"></i><b>2.9.3</b> st_centroid</a></li>
<li class="chapter" data-level="2.9.4" data-path="non-interactive-geometrical-operations.html"><a href="non-interactive-geometrical-operations.html#st_length"><i class="fa fa-check"></i><b>2.9.4</b> st_length</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="int-vv.html"><a href="int-vv.html"><i class="fa fa-check"></i><b>3</b> Spatial Interactions of Vector Data: Subsetting and Joining</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-2.html"><a href="before-you-start-2.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-2.html"><a href="before-you-start-2.html#direction-for-replication-2"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="3.1" data-path="topo.html"><a href="topo.html"><i class="fa fa-check"></i><b>3.1</b> Topological relations</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="topo.html"><a href="topo.html#st_intersects"><i class="fa fa-check"></i><b>3.1.1</b> st_intersects()</a></li>
<li class="chapter" data-level="3.1.2" data-path="topo.html"><a href="topo.html#st_is_within_distance"><i class="fa fa-check"></i><b>3.1.2</b> st_is_within_distance()</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html"><i class="fa fa-check"></i><b>3.2</b> Spatial Subsetting (or Flagging)</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#polygons-source-vs-polygons-target"><i class="fa fa-check"></i><b>3.2.1</b> polygons (source) vs polygons (target)</a></li>
<li class="chapter" data-level="3.2.2" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#points-source-vs-polygons-target"><i class="fa fa-check"></i><b>3.2.2</b> points (source) vs polygons (target)</a></li>
<li class="chapter" data-level="3.2.3" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#lines_polygons"><i class="fa fa-check"></i><b>3.2.3</b> lines (source) vs polygons (target)</a></li>
<li class="chapter" data-level="3.2.4" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#polygons_points"><i class="fa fa-check"></i><b>3.2.4</b> polygons (source) vs points (target)</a></li>
<li class="chapter" data-level="3.2.5" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#subsetting-to-a-geograpchic-extent-bounding-box"><i class="fa fa-check"></i><b>3.2.5</b> Subsetting to a geograpchic extent (bounding box)</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sp-join.html"><a href="sp-join.html"><i class="fa fa-check"></i><b>3.3</b> Spatial Join</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="sp-join.html"><a href="sp-join.html#case-1-points-target-vs-polygons-source"><i class="fa fa-check"></i><b>3.3.1</b> Case 1: points (target) vs polygons (source)</a></li>
<li class="chapter" data-level="3.3.2" data-path="sp-join.html"><a href="sp-join.html#case-2-polygons-target-vs-points-source"><i class="fa fa-check"></i><b>3.3.2</b> Case 2: polygons (target) vs points (source)</a></li>
<li class="chapter" data-level="3.3.3" data-path="sp-join.html"><a href="sp-join.html#polygon-polygon"><i class="fa fa-check"></i><b>3.3.3</b> Case 3: polygons (target) vs polygons (source)</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="spatial-intersection-cropping-join.html"><a href="spatial-intersection-cropping-join.html"><i class="fa fa-check"></i><b>3.4</b> Spatial Intersection (cropping join)</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="spatial-intersection-cropping-join.html"><a href="spatial-intersection-cropping-join.html#st_intersection"><i class="fa fa-check"></i><b>3.4.1</b> <code>st_intersection()</code></a></li>
<li class="chapter" data-level="3.4.2" data-path="spatial-intersection-cropping-join.html"><a href="spatial-intersection-cropping-join.html#area-weighted-average"><i class="fa fa-check"></i><b>3.4.2</b> Area-weighted average</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="raster-basics.html"><a href="raster-basics.html"><i class="fa fa-check"></i><b>4</b> Raster Data Handling with <code>terra</code></a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-3.html"><a href="before-you-start-3.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-3.html"><a href="before-you-start-3.html#direction-for-replication-3"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="4.1" data-path="raster-data-object-classes.html"><a href="raster-data-object-classes.html"><i class="fa fa-check"></i><b>4.1</b> Raster data object classes</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="raster-data-object-classes.html"><a href="raster-data-object-classes.html#raster-package-rasterlayer-rasterstack-and-rasterbrick"><i class="fa fa-check"></i><b>4.1.1</b> <code>raster</code> package: <code>RasterLayer</code>, <code>RasterStack</code>, and <code>RasterBrick</code></a></li>
<li class="chapter" data-level="4.1.2" data-path="raster-data-object-classes.html"><a href="raster-data-object-classes.html#terra-package-spatraster"><i class="fa fa-check"></i><b>4.1.2</b> <code>terra</code> package: <code>SpatRaster</code></a></li>
<li class="chapter" data-level="4.1.3" data-path="raster-data-object-classes.html"><a href="raster-data-object-classes.html#converting-a-spatraster-object-to-a-raster-object."><i class="fa fa-check"></i><b>4.1.3</b> Converting a <code>SpatRaster</code> object to a <code>Raster</code><span class="math inline">\(^*\)</span> object.</a></li>
<li class="chapter" data-level="4.1.4" data-path="raster-data-object-classes.html"><a href="raster-data-object-classes.html#vector-data-in-the-terra-package"><i class="fa fa-check"></i><b>4.1.4</b> Vector data in the <code>terra</code> package</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="read-and-write-a-raster-data-file.html"><a href="read-and-write-a-raster-data-file.html"><i class="fa fa-check"></i><b>4.2</b> Read and write a raster data file</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="read-and-write-a-raster-data-file.html"><a href="read-and-write-a-raster-data-file.html#read-raster-files"><i class="fa fa-check"></i><b>4.2.1</b> Read raster file(s)</a></li>
<li class="chapter" data-level="4.2.2" data-path="read-and-write-a-raster-data-file.html"><a href="read-and-write-a-raster-data-file.html#write-raster-files"><i class="fa fa-check"></i><b>4.2.2</b> Write raster files</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="access-values.html"><a href="access-values.html"><i class="fa fa-check"></i><b>4.3</b> Access values</a></li>
<li class="chapter" data-level="4.4" data-path="quick-plot-and-interactive-map.html"><a href="quick-plot-and-interactive-map.html"><i class="fa fa-check"></i><b>4.4</b> Quick plot and interactive map</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="int-RV.html"><a href="int-RV.html"><i class="fa fa-check"></i><b>5</b> Spatial Interactions of Vector and Raster Data</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-4.html"><a href="before-you-start-4.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-4.html"><a href="before-you-start-4.html#direction-for-replication-4"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="5.1" data-path="raster-crop.html"><a href="raster-crop.html"><i class="fa fa-check"></i><b>5.1</b> Cropping (Spatial subsetting) to the Area of Interest</a></li>
<li class="chapter" data-level="5.2" data-path="extracting-values-from-raster-layers-for-vector-data.html"><a href="extracting-values-from-raster-layers-for-vector-data.html"><i class="fa fa-check"></i><b>5.2</b> Extracting Values from Raster Layers for Vector Data</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="extracting-values-from-raster-layers-for-vector-data.html"><a href="extracting-values-from-raster-layers-for-vector-data.html#points"><i class="fa fa-check"></i><b>5.2.1</b> Points</a></li>
<li class="chapter" data-level="5.2.2" data-path="extracting-values-from-raster-layers-for-vector-data.html"><a href="extracting-values-from-raster-layers-for-vector-data.html#polygons-terra-way"><i class="fa fa-check"></i><b>5.2.2</b> Polygons (<code>terra</code> way)</a></li>
<li class="chapter" data-level="5.2.3" data-path="extracting-values-from-raster-layers-for-vector-data.html"><a href="extracting-values-from-raster-layers-for-vector-data.html#polygons-exactextractr-way"><i class="fa fa-check"></i><b>5.2.3</b> Polygons (<code>exactextractr</code> way)</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="extraction-speed-comparison.html"><a href="extraction-speed-comparison.html"><i class="fa fa-check"></i><b>5.3</b> Extraction speed comparison</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="extraction-speed-comparison.html"><a href="extraction-speed-comparison.html#points-terraextract-and-rasterextract"><i class="fa fa-check"></i><b>5.3.1</b> Points: <code>terra::extract()</code> and <code>raster::extract()</code></a></li>
<li class="chapter" data-level="5.3.2" data-path="extraction-speed-comparison.html"><a href="extraction-speed-comparison.html#polygons-exact_extract-terraextract-and-rasterextract"><i class="fa fa-check"></i><b>5.3.2</b> Polygons: <code>exact_extract()</code>, <code>terra::extract()</code>, and <code>raster::extract()</code></a></li>
<li class="chapter" data-level="5.3.3" data-path="extraction-speed-comparison.html"><a href="extraction-speed-comparison.html#single-layer-vs-multi-layer"><i class="fa fa-check"></i><b>5.3.3</b> Single-layer vs multi-layer</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="EE.html"><a href="EE.html"><i class="fa fa-check"></i><b>6</b> Speed Things Up</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-5.html"><a href="before-you-start-5.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-5.html"><a href="before-you-start-5.html#direction-for-replication-5"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="6.1" data-path="single-raster-layer.html"><a href="single-raster-layer.html"><i class="fa fa-check"></i><b>6.1</b> Single raster layer</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="single-raster-layer.html"><a href="single-raster-layer.html#datasets"><i class="fa fa-check"></i><b>6.1.1</b> Datasets</a></li>
<li class="chapter" data-level="6.1.2" data-path="single-raster-layer.html"><a href="single-raster-layer.html#parallelization"><i class="fa fa-check"></i><b>6.1.2</b> Parallelization</a></li>
<li class="chapter" data-level="6.1.3" data-path="single-raster-layer.html"><a href="single-raster-layer.html#summary-1"><i class="fa fa-check"></i><b>6.1.3</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="many-multi-layer.html"><a href="many-multi-layer.html"><i class="fa fa-check"></i><b>6.2</b> Many multi-layer raster files</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="many-multi-layer.html"><a href="many-multi-layer.html#datasets-1"><i class="fa fa-check"></i><b>6.2.1</b> Datasets</a></li>
<li class="chapter" data-level="6.2.2" data-path="many-multi-layer.html"><a href="many-multi-layer.html#non-par-ext-multi"><i class="fa fa-check"></i><b>6.2.2</b> Non-parallelized extraction</a></li>
<li class="chapter" data-level="6.2.3" data-path="many-multi-layer.html"><a href="many-multi-layer.html#approach-1-parallelize-over-polygons-and-do-regular-loop-over-year-month"><i class="fa fa-check"></i><b>6.2.3</b> Approach 1: parallelize over polygons and do regular loop over year-month</a></li>
<li class="chapter" data-level="6.2.4" data-path="many-multi-layer.html"><a href="many-multi-layer.html#approach-2-parallelize-over-the-temporal-dimension-year-month"><i class="fa fa-check"></i><b>6.2.4</b> Approach 2: parallelize over the temporal dimension (year-month)</a></li>
<li class="chapter" data-level="6.2.5" data-path="many-multi-layer.html"><a href="many-multi-layer.html#memory-consideration"><i class="fa fa-check"></i><b>6.2.5</b> Memory consideration</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="aside-download-daily-prism-data-files-and-save-them-by-month-in-parallel.html"><a href="aside-download-daily-prism-data-files-and-save-them-by-month-in-parallel.html"><i class="fa fa-check"></i><b>6.3</b> (Aside): Download daily PRISM data files and save them by month in parallel</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="create-maps.html"><a href="create-maps.html"><i class="fa fa-check"></i><b>7</b> Creating Publication-quality Maps</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="par-comp.html"><a href="par-comp.html"><i class="fa fa-check"></i><b>A</b> Loop and Parallel Computing</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-6.html"><a href="before-you-start-6.html"><i class="fa fa-check"></i>Before you start</a>
<ul>
<li class="chapter" data-level="" data-path="before-you-start-6.html"><a href="before-you-start-6.html#direction-for-replication-6"><i class="fa fa-check"></i>Direction for replication</a></li>
<li class="chapter" data-level="" data-path="before-you-start-6.html"><a href="before-you-start-6.html#packages-to-install-and-load"><i class="fa fa-check"></i>Packages to install and load</a></li>
</ul></li>
<li class="chapter" data-level="A.1" data-path="repetitive-processes-and-looping.html"><a href="repetitive-processes-and-looping.html"><i class="fa fa-check"></i><b>A.1</b> Repetitive processes and looping</a>
<ul>
<li class="chapter" data-level="A.1.1" data-path="repetitive-processes-and-looping.html"><a href="repetitive-processes-and-looping.html#what-is-looping"><i class="fa fa-check"></i><b>A.1.1</b> What is looping?</a></li>
<li class="chapter" data-level="A.1.2" data-path="repetitive-processes-and-looping.html"><a href="repetitive-processes-and-looping.html#for-loop"><i class="fa fa-check"></i><b>A.1.2</b> For loop</a></li>
<li class="chapter" data-level="A.1.3" data-path="repetitive-processes-and-looping.html"><a href="repetitive-processes-and-looping.html#for-loop-using-the-lapply-function"><i class="fa fa-check"></i><b>A.1.3</b> For loop using the <code>lapply()</code> function</a></li>
<li class="chapter" data-level="A.1.4" data-path="repetitive-processes-and-looping.html"><a href="repetitive-processes-and-looping.html#looping-over-multiple-variables-using-lapply"><i class="fa fa-check"></i><b>A.1.4</b> Looping over multiple variables using lapply()</a></li>
<li class="chapter" data-level="A.1.5" data-path="repetitive-processes-and-looping.html"><a href="repetitive-processes-and-looping.html#do-you-really-need-to-loop"><i class="fa fa-check"></i><b>A.1.5</b> Do you really need to loop?</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="parcomp.html"><a href="parcomp.html"><i class="fa fa-check"></i><b>A.2</b> Parallelization of embarrassingly parallel processes</a>
<ul>
<li class="chapter" data-level="A.2.1" data-path="parcomp.html"><a href="parcomp.html#mac-or-linux-users"><i class="fa fa-check"></i><b>A.2.1</b> Mac or Linux users</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R as GIS for Economists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script>

<div id="demonstration-3-land-use-and-weather" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> Demonstration 3: Land Use and Weather</h2>
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview-2" class="section level3" number="1.3.1">
<h3><span class="header-section-number">1.3.1</span> Project Overview</h3>
<hr />
<p><strong>Objective</strong></p>
<ul>
<li>Understand the impact of past precipitation on crop choice in Iowa (IA).</li>
</ul>
<hr />
<p><strong>Datasets</strong></p>
<ul>
<li>IA county boundary</li>
<li>Regular grids over IA, created using <code>sf::st_make_grid()</code></li>
<li>PRISM daily precipitation data downloaded using <code>prism</code> package</li>
<li>Land use data from the Cropland Data Layer (CDL) for IA in 2015, downloaded using <code>cdlTools</code> package</li>
</ul>
<hr />
<p><strong>Econometric Model</strong></p>
<p>The econometric model we would like to estimate is:</p>
<p><span class="math display">\[
 CS_i = \alpha + \beta_1 PrN_{i} + \beta_2 PrC_{i} + v_i
\]</span>
where <span class="math inline">\(CS_i\)</span> is the area share of corn divided by that of soy in 2015 for grid <span class="math inline">\(i\)</span> (we will generate regularly-sized grids in the Demo section), <span class="math inline">\(PrN_i\)</span> is the total precipitation observed in April through May and September in 2014, <span class="math inline">\(PrC_i\)</span> is the total precipitation observed in June through August in 2014, and <span class="math inline">\(v_i\)</span> is the error term. To run the econometric model, we need to find crop share and weather variables observed at the grids. We first tackle the crop share variable, and then the precipitation variable.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>download Cropland Data Layer (CDL) data by USDA NASS
<ul>
<li>use <code>cdlTools::getCDL()</code></li>
</ul></li>
<li>download PRISM weather data
<ul>
<li>use <code>prism::get_prism_dailys()</code></li>
</ul></li>
<li>crop PRISM data to the geographic extent of IA
<ul>
<li>use <code>raster::crop()</code></li>
</ul></li>
<li>create regular grids within IA, which become the observation units of the econometric analysis
<ul>
<li>use <code>sf::st_make_grid()</code></li>
</ul></li>
<li>remove grids that share small area with IA
<ul>
<li>use <code>sf::st_intersection()</code> and <code>sf::st_area</code></li>
</ul></li>
<li>assign crop share and weather data to each of the generated IA grids (parallelized)
<ul>
<li>use <code>exactextractr::exact_extract()</code> and <code>future.apply::future_lapply()</code></li>
</ul></li>
<li>create maps
<ul>
<li>use the <code>tmap</code> package</li>
</ul></li>
</ul>
<hr />
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Run the following code to install or load (if already installed) the <code>pacman</code> package, and then install or load (if already installed) the listed package inside the <code>pacman::p_load()</code> function.</li>
</ul>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="demonstration-3-land-use-and-weather.html#cb46-1"></a><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(<span class="st">&quot;pacman&quot;</span>)) <span class="kw">install.packages</span>(<span class="st">&quot;pacman&quot;</span>)</span>
<span id="cb46-2"><a href="demonstration-3-land-use-and-weather.html#cb46-2"></a>pacman<span class="op">::</span><span class="kw">p_load</span>(</span>
<span id="cb46-3"><a href="demonstration-3-land-use-and-weather.html#cb46-3"></a>  sf, <span class="co"># vector data operations</span></span>
<span id="cb46-4"><a href="demonstration-3-land-use-and-weather.html#cb46-4"></a>  raster, <span class="co"># raster data operations</span></span>
<span id="cb46-5"><a href="demonstration-3-land-use-and-weather.html#cb46-5"></a>  exactextractr, <span class="co"># fast raster data extraction for polygons</span></span>
<span id="cb46-6"><a href="demonstration-3-land-use-and-weather.html#cb46-6"></a>  maps, <span class="co"># to get county boundary data</span></span>
<span id="cb46-7"><a href="demonstration-3-land-use-and-weather.html#cb46-7"></a>  data.table, <span class="co"># data wrangling</span></span>
<span id="cb46-8"><a href="demonstration-3-land-use-and-weather.html#cb46-8"></a>  dplyr, <span class="co"># data wrangling</span></span>
<span id="cb46-9"><a href="demonstration-3-land-use-and-weather.html#cb46-9"></a>  lubridate, <span class="co"># Date object handling</span></span>
<span id="cb46-10"><a href="demonstration-3-land-use-and-weather.html#cb46-10"></a>  tmap, <span class="co"># for map creation</span></span>
<span id="cb46-11"><a href="demonstration-3-land-use-and-weather.html#cb46-11"></a>  stargazer, <span class="co"># regression table generation</span></span>
<span id="cb46-12"><a href="demonstration-3-land-use-and-weather.html#cb46-12"></a>  future.apply, <span class="co"># parallel computation</span></span>
<span id="cb46-13"><a href="demonstration-3-land-use-and-weather.html#cb46-13"></a>  cdlTools, <span class="co"># download CDL data</span></span>
<span id="cb46-14"><a href="demonstration-3-land-use-and-weather.html#cb46-14"></a>  rgdal, <span class="co"># required for cdlTools</span></span>
<span id="cb46-15"><a href="demonstration-3-land-use-and-weather.html#cb46-15"></a>  prism, <span class="co"># download PRISM data</span></span>
<span id="cb46-16"><a href="demonstration-3-land-use-and-weather.html#cb46-16"></a>  stringr <span class="co"># string manipulation</span></span>
<span id="cb46-17"><a href="demonstration-3-land-use-and-weather.html#cb46-17"></a>)  </span></code></pre></div>
</div>
<div id="project-demonstration-2" class="section level3" number="1.3.2">
<h3><span class="header-section-number">1.3.2</span> Project Demonstration</h3>
<p>The geographic focus of this project is Iowas. Let’s get Iowa state border (see Figure <a href="demonstration-3-land-use-and-weather.html#fig:IA-map">1.8</a> for its map).</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="demonstration-3-land-use-and-weather.html#cb47-1"></a><span class="co">#--- IA state boundary ---#</span></span>
<span id="cb47-2"><a href="demonstration-3-land-use-and-weather.html#cb47-2"></a>IA_boundary &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(maps<span class="op">::</span><span class="kw">map</span>(<span class="st">&quot;state&quot;</span>, <span class="st">&quot;iowa&quot;</span>, <span class="dt">plot =</span> <span class="ot">FALSE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>)) </span></code></pre></div>
<div class="figure"><span id="fig:IA-map"></span>
<img src="R_GIS_Book_files/figure-html/IA-map-1.png" alt="Iowa state boundary" width="672" />
<p class="caption">
Figure 1.8: Iowa state boundary
</p>
</div>
<p>The unit of analysis is artificial grids that we create over Iowa. The grids are regularly-sized rectangles except around the edge of the Iowa state border<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>. So, let’s create grids and remove those that do not overlap much with Iowa.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="demonstration-3-land-use-and-weather.html#cb48-1"></a><span class="co">#--- create regular grids (40 cells by 40 columns) over IA ---#</span></span>
<span id="cb48-2"><a href="demonstration-3-land-use-and-weather.html#cb48-2"></a>IA_grids &lt;-<span class="st"> </span>IA_boundary <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-3"><a href="demonstration-3-land-use-and-weather.html#cb48-3"></a><span class="st">  </span><span class="co">#--- create grids ---#</span></span>
<span id="cb48-4"><a href="demonstration-3-land-use-and-weather.html#cb48-4"></a><span class="st">  </span><span class="kw">st_make_grid</span>(, <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">40</span>, <span class="dv">40</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-5"><a href="demonstration-3-land-use-and-weather.html#cb48-5"></a><span class="st">  </span><span class="co">#--- convert to sf ---#</span></span>
<span id="cb48-6"><a href="demonstration-3-land-use-and-weather.html#cb48-6"></a><span class="st">  </span><span class="kw">st_as_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-7"><a href="demonstration-3-land-use-and-weather.html#cb48-7"></a><span class="st">  </span><span class="co">#--- find the intersections of IA grids and IA polygon ---#</span></span>
<span id="cb48-8"><a href="demonstration-3-land-use-and-weather.html#cb48-8"></a><span class="st">  </span><span class="kw">st_intersection</span>(., IA_boundary) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-9"><a href="demonstration-3-land-use-and-weather.html#cb48-9"></a><span class="st">  </span><span class="co">#--- calculate the area of each grid ---#</span></span>
<span id="cb48-10"><a href="demonstration-3-land-use-and-weather.html#cb48-10"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb48-11"><a href="demonstration-3-land-use-and-weather.html#cb48-11"></a>    <span class="dt">area =</span> <span class="kw">as.numeric</span>(<span class="kw">st_area</span>(.)),</span>
<span id="cb48-12"><a href="demonstration-3-land-use-and-weather.html#cb48-12"></a>    <span class="dt">area_ratio =</span> area<span class="op">/</span><span class="kw">max</span>(area)</span>
<span id="cb48-13"><a href="demonstration-3-land-use-and-weather.html#cb48-13"></a>  ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-14"><a href="demonstration-3-land-use-and-weather.html#cb48-14"></a><span class="st">  </span><span class="co">#--- keep only if the intersected area is large enough ---#</span></span>
<span id="cb48-15"><a href="demonstration-3-land-use-and-weather.html#cb48-15"></a><span class="st">  </span><span class="kw">filter</span>(area_ratio <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-16"><a href="demonstration-3-land-use-and-weather.html#cb48-16"></a><span class="st">  </span><span class="co">#--- assign grid id for future merge ---#</span></span>
<span id="cb48-17"><a href="demonstration-3-land-use-and-weather.html#cb48-17"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">grid_id =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.))</span></code></pre></div>
<p>Here is what the generated grids look like (Figure <a href="demonstration-3-land-use-and-weather.html#fig:Demo4-IA-grids-map">1.9</a>):</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="demonstration-3-land-use-and-weather.html#cb49-1"></a><span class="co">#--- plot the grids over the IA state border ---#</span></span>
<span id="cb49-2"><a href="demonstration-3-land-use-and-weather.html#cb49-2"></a><span class="kw">tm_shape</span>(IA_boundary) <span class="op">+</span></span>
<span id="cb49-3"><a href="demonstration-3-land-use-and-weather.html#cb49-3"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span></span>
<span id="cb49-4"><a href="demonstration-3-land-use-and-weather.html#cb49-4"></a><span class="kw">tm_shape</span>(IA_grids) <span class="op">+</span></span>
<span id="cb49-5"><a href="demonstration-3-land-use-and-weather.html#cb49-5"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha =</span> <span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb49-6"><a href="demonstration-3-land-use-and-weather.html#cb49-6"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<div class="figure"><span id="fig:Demo4-IA-grids-map"></span>
<img src="R_GIS_Book_files/figure-html/Demo4-IA-grids-map-1.png" alt="Map of regular grids generated over IA" width="672" />
<p class="caption">
Figure 1.9: Map of regular grids generated over IA
</p>
</div>
<hr />
<p>Let’s work on crop share data. You can download CDL data using the <code>getCDL()</code> function from the <code>cdlTools</code> package.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="demonstration-3-land-use-and-weather.html#cb50-1"></a><span class="co">#--- download the CDL data for IA in 2015 ---#</span></span>
<span id="cb50-2"><a href="demonstration-3-land-use-and-weather.html#cb50-2"></a>(</span>
<span id="cb50-3"><a href="demonstration-3-land-use-and-weather.html#cb50-3"></a>IA_cdl_<span class="dv">2015</span> &lt;-<span class="st"> </span><span class="kw">getCDL</span>(<span class="st">&quot;Iowa&quot;</span>, <span class="dv">2015</span>)<span class="op">$</span>IA2015</span>
<span id="cb50-4"><a href="demonstration-3-land-use-and-weather.html#cb50-4"></a>)</span></code></pre></div>
<p>The cells (30 meter by 30 meter) of the imported raster layer take a value ranging from 0 to 255. Corn and soybean are represented by 1 and 5, respectively (Figure <a href="demonstration-3-land-use-and-weather.html#fig:overlap-cdl-grid">1.10</a>).</p>
<p>Figure <a href="demonstration-3-land-use-and-weather.html#fig:overlap-cdl-grid">1.10</a> shows the map of one of the IA grids and the CDL cells it overlaps with.</p>
<div class="figure"><span id="fig:overlap-cdl-grid"></span>
<img src="R_GIS_Book_files/figure-html/overlap-cdl-grid-1.png" alt="Spatial overlap of a IA grid and CDL layer" width="672" />
<p class="caption">
Figure 1.10: Spatial overlap of a IA grid and CDL layer
</p>
</div>
<p>We would like to extract all the cell values within the blue border.</p>
<p>We use <code>exactextractr::exact_extract()</code> to identify which cells of the CDL raster layer fall within each of the IA grids and extract land use type values. We then find the share of corn and soybean for each of the grids.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="demonstration-3-land-use-and-weather.html#cb51-1"></a><span class="co">#--- reproject grids to the CRS of the CDL data ---#</span></span>
<span id="cb51-2"><a href="demonstration-3-land-use-and-weather.html#cb51-2"></a>IA_grids_rp_cdl &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(IA_cdl_<span class="dv">2015</span>))</span>
<span id="cb51-3"><a href="demonstration-3-land-use-and-weather.html#cb51-3"></a></span>
<span id="cb51-4"><a href="demonstration-3-land-use-and-weather.html#cb51-4"></a><span class="co">#--- extract crop type values and find frequencies ---#</span></span>
<span id="cb51-5"><a href="demonstration-3-land-use-and-weather.html#cb51-5"></a>cdl_extracted &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(IA_cdl_<span class="dv">2015</span>, IA_grids_rp_cdl) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-6"><a href="demonstration-3-land-use-and-weather.html#cb51-6"></a><span class="st">  </span><span class="kw">lapply</span>(., <span class="cf">function</span> (x) <span class="kw">data.table</span>(x)[,.N, <span class="dt">by =</span> value]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-7"><a href="demonstration-3-land-use-and-weather.html#cb51-7"></a><span class="st">  </span><span class="co">#--- combine the list of data.tables into one data.table ---#</span></span>
<span id="cb51-8"><a href="demonstration-3-land-use-and-weather.html#cb51-8"></a><span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-9"><a href="demonstration-3-land-use-and-weather.html#cb51-9"></a><span class="st">  </span><span class="co">#--- find the share of each land use type ---#</span></span>
<span id="cb51-10"><a href="demonstration-3-land-use-and-weather.html#cb51-10"></a><span class="st">  </span>.[, share <span class="op">:</span><span class="er">=</span><span class="st"> </span>N<span class="op">/</span><span class="kw">sum</span>(N), by =<span class="st"> </span>.id] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-11"><a href="demonstration-3-land-use-and-weather.html#cb51-11"></a><span class="st">  </span>.[, N <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-12"><a href="demonstration-3-land-use-and-weather.html#cb51-12"></a><span class="st">  </span><span class="co">#--- keep only the share of corn and soy ---#</span></span>
<span id="cb51-13"><a href="demonstration-3-land-use-and-weather.html#cb51-13"></a><span class="st">  </span>.[value <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), ]  </span></code></pre></div>
<p>We then find the corn to soy ratio for each of the IA grids.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="demonstration-3-land-use-and-weather.html#cb52-1"></a><span class="co">#--- find corn/soy ratio ---#</span></span>
<span id="cb52-2"><a href="demonstration-3-land-use-and-weather.html#cb52-2"></a>corn_soy &lt;-<span class="st"> </span>cdl_extracted <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb52-3"><a href="demonstration-3-land-use-and-weather.html#cb52-3"></a><span class="st">  </span><span class="co">#--- long to wide ---#</span></span>
<span id="cb52-4"><a href="demonstration-3-land-use-and-weather.html#cb52-4"></a><span class="st">  </span><span class="kw">dcast</span>(.id <span class="op">~</span><span class="st"> </span>value, <span class="dt">value.var =</span> <span class="st">&quot;share&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb52-5"><a href="demonstration-3-land-use-and-weather.html#cb52-5"></a><span class="st">  </span><span class="co">#--- change variable names ---#</span></span>
<span id="cb52-6"><a href="demonstration-3-land-use-and-weather.html#cb52-6"></a><span class="st">  </span><span class="kw">setnames</span>(<span class="kw">c</span>(<span class="st">&quot;.id&quot;</span>, <span class="st">&quot;1&quot;</span>, <span class="st">&quot;5&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;grid_id&quot;</span>, <span class="st">&quot;corn_share&quot;</span>, <span class="st">&quot;soy_share&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb52-7"><a href="demonstration-3-land-use-and-weather.html#cb52-7"></a><span class="st">  </span><span class="co">#--- corn share divided by soy share ---#</span></span>
<span id="cb52-8"><a href="demonstration-3-land-use-and-weather.html#cb52-8"></a><span class="st">  </span>.[, c_s_ratio <span class="op">:</span><span class="er">=</span><span class="st"> </span>corn_share <span class="op">/</span><span class="st"> </span>soy_share]</span></code></pre></div>
<hr />
<p>We are still missing daily precipitation data at the moment. We have decided to use daily weather data from PRISM. Daily PRISM data is a raster data with the cell size of 4 km by 4 km. Figure <a href="demonstration-3-land-use-and-weather.html#fig:Demo4-show-prism-data">1.11</a> presents precipitation data downloaded for April 1, 2010. It covers the entire contiguous U.S.</p>
<div class="figure"><span id="fig:Demo4-show-prism-data"></span>
<img src="R_GIS_Book_files/figure-html/Demo4-show-prism-data-1.png" alt="Map of PRISM raster data layer" width="672" />
<p class="caption">
Figure 1.11: Map of PRISM raster data layer
</p>
</div>
<p>Let’s now download PRISM data<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>. This can be done using the <code>get_prism_dailys()</code> function from the <code>prism</code> package.<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a></p>
<!-- not to be seen -->
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="demonstration-3-land-use-and-weather.html#cb53-1"></a><span class="kw">options</span>(<span class="dt">prism.path =</span> <span class="st">&quot;./Data/PRISM&quot;</span>)</span>
<span id="cb53-2"><a href="demonstration-3-land-use-and-weather.html#cb53-2"></a></span>
<span id="cb53-3"><a href="demonstration-3-land-use-and-weather.html#cb53-3"></a><span class="kw">get_prism_dailys</span>(</span>
<span id="cb53-4"><a href="demonstration-3-land-use-and-weather.html#cb53-4"></a>  <span class="dt">type =</span> <span class="st">&quot;ppt&quot;</span>, </span>
<span id="cb53-5"><a href="demonstration-3-land-use-and-weather.html#cb53-5"></a>  <span class="dt">minDate =</span> <span class="st">&quot;2014-04-01&quot;</span>, </span>
<span id="cb53-6"><a href="demonstration-3-land-use-and-weather.html#cb53-6"></a>  <span class="dt">maxDate =</span> <span class="st">&quot;2014-09-30&quot;</span>, </span>
<span id="cb53-7"><a href="demonstration-3-land-use-and-weather.html#cb53-7"></a>  <span class="dt">keepZip =</span> <span class="ot">FALSE</span> </span>
<span id="cb53-8"><a href="demonstration-3-land-use-and-weather.html#cb53-8"></a>)</span></code></pre></div>
<p>When we use <code>get_prism_dailys()</code> to download data<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>, it creates one folder for each day. So, I have about 180 folders inside the folder I designated as the download destination above with the <code>options()</code> function.</p>
<!-- The name of the folder is expressive about what the data inside it is about. For example, the precipitation data for April 1st, 2010 is stored in the folder called "PRISM_ppt_stable_4kmD2_20100401_bil." Inside it, you will see bunch of files with exactly the same prefix, but with different extensions.   -->
<hr />
<p>We now try to extract precipitation value by day for each of the IA grids by geographically overlaying IA grids onto the PRISM data layer and identify which PRISM cells each of the IA grid encompass. Figure <a href="demonstration-3-land-use-and-weather.html#fig:Demo4-prism-crop">1.12</a> shows how the first IA grid overlaps with the PRISM cells<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="demonstration-3-land-use-and-weather.html#cb54-1"></a><span class="co">#--- read a PRISM dataset ---#</span></span>
<span id="cb54-2"><a href="demonstration-3-land-use-and-weather.html#cb54-2"></a>prism_whole &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil&quot;</span>) </span>
<span id="cb54-3"><a href="demonstration-3-land-use-and-weather.html#cb54-3"></a></span>
<span id="cb54-4"><a href="demonstration-3-land-use-and-weather.html#cb54-4"></a><span class="co">#--- align the CRS ---#</span></span>
<span id="cb54-5"><a href="demonstration-3-land-use-and-weather.html#cb54-5"></a>IA_grids_rp_prism &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(prism_whole))</span>
<span id="cb54-6"><a href="demonstration-3-land-use-and-weather.html#cb54-6"></a></span>
<span id="cb54-7"><a href="demonstration-3-land-use-and-weather.html#cb54-7"></a><span class="co">#--- crop the PRISM data for the 1st IA grid ---#</span></span>
<span id="cb54-8"><a href="demonstration-3-land-use-and-weather.html#cb54-8"></a>PRISM_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">crop</span>(prism_whole, <span class="kw">st_buffer</span>(IA_grids_rp_prism[<span class="dv">1</span>, ], <span class="dt">dist =</span> <span class="fl">0.05</span>))</span>
<span id="cb54-9"><a href="demonstration-3-land-use-and-weather.html#cb54-9"></a></span>
<span id="cb54-10"><a href="demonstration-3-land-use-and-weather.html#cb54-10"></a><span class="co">#--- map them ---#</span></span>
<span id="cb54-11"><a href="demonstration-3-land-use-and-weather.html#cb54-11"></a><span class="kw">tm_shape</span>(PRISM_<span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb54-12"><a href="demonstration-3-land-use-and-weather.html#cb54-12"></a><span class="st">  </span><span class="kw">tm_raster</span>() <span class="op">+</span></span>
<span id="cb54-13"><a href="demonstration-3-land-use-and-weather.html#cb54-13"></a><span class="kw">tm_shape</span>(IA_grids_rp_prism[<span class="dv">1</span>, ]) <span class="op">+</span></span>
<span id="cb54-14"><a href="demonstration-3-land-use-and-weather.html#cb54-14"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha =</span> <span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb54-15"><a href="demonstration-3-land-use-and-weather.html#cb54-15"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">NA</span>)</span></code></pre></div>
<div class="figure"><span id="fig:Demo4-prism-crop"></span>
<img src="R_GIS_Book_files/figure-html/Demo4-prism-crop-1.png" alt="Spatial overlap of an IA grid over PRISM cells" width="672" />
<p class="caption">
Figure 1.12: Spatial overlap of an IA grid over PRISM cells
</p>
</div>
<p>As you can see, some PRISM grids are fully inside the analysis grid, while others are partially inside it. So, when assigning precipitation values to grids, we will use the coverage-weighted mean of precipitations<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>.</p>
<p>Unlike the CDL layer, we have 183 raster layers to process. Fortunately, we can process many raster files at the same time very quickly by first “stacking” many raster files first and then applying the <code>exact_extract()</code> function. Using <code>future_lapply()</code>, we let <span class="math inline">\(6\)</span> cores take care of this task with each processing 31 files, except one of them handling only 28 files.<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a>
We first get all the paths to the PRISM files.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="demonstration-3-land-use-and-weather.html#cb55-1"></a><span class="co">#--- get all the dates ---#</span></span>
<span id="cb55-2"><a href="demonstration-3-land-use-and-weather.html#cb55-2"></a>dates_ls &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2014-04-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2014-09-30&quot;</span>), <span class="st">&quot;days&quot;</span>) </span>
<span id="cb55-3"><a href="demonstration-3-land-use-and-weather.html#cb55-3"></a></span>
<span id="cb55-4"><a href="demonstration-3-land-use-and-weather.html#cb55-4"></a><span class="co">#--- remove hyphen ---#</span></span>
<span id="cb55-5"><a href="demonstration-3-land-use-and-weather.html#cb55-5"></a>dates_ls_no_hyphen &lt;-<span class="st"> </span><span class="kw">str_remove_all</span>(dates_ls, <span class="st">&quot;-&quot;</span>)</span>
<span id="cb55-6"><a href="demonstration-3-land-use-and-weather.html#cb55-6"></a></span>
<span id="cb55-7"><a href="demonstration-3-land-use-and-weather.html#cb55-7"></a><span class="co">#--- get all the prism file names ---#</span></span>
<span id="cb55-8"><a href="demonstration-3-land-use-and-weather.html#cb55-8"></a>folder_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;PRISM_ppt_stable_4kmD2_&quot;</span>, dates_ls_no_hyphen, <span class="st">&quot;_bil&quot;</span>) </span>
<span id="cb55-9"><a href="demonstration-3-land-use-and-weather.html#cb55-9"></a>file_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;PRISM_ppt_stable_4kmD2_&quot;</span>, dates_ls_no_hyphen, <span class="st">&quot;_bil.bil&quot;</span>) </span>
<span id="cb55-10"><a href="demonstration-3-land-use-and-weather.html#cb55-10"></a>file_paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;./Data/PRISM/&quot;</span>, folder_name, <span class="st">&quot;/&quot;</span>, file_name)</span>
<span id="cb55-11"><a href="demonstration-3-land-use-and-weather.html#cb55-11"></a></span>
<span id="cb55-12"><a href="demonstration-3-land-use-and-weather.html#cb55-12"></a><span class="co">#--- take a look ---#</span></span>
<span id="cb55-13"><a href="demonstration-3-land-use-and-weather.html#cb55-13"></a><span class="kw">head</span>(file_paths)</span></code></pre></div>
<pre><code>[1] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil&quot;
[2] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140402_bil/PRISM_ppt_stable_4kmD2_20140402_bil.bil&quot;
[3] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140403_bil/PRISM_ppt_stable_4kmD2_20140403_bil.bil&quot;
[4] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140404_bil/PRISM_ppt_stable_4kmD2_20140404_bil.bil&quot;
[5] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140405_bil/PRISM_ppt_stable_4kmD2_20140405_bil.bil&quot;
[6] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140406_bil/PRISM_ppt_stable_4kmD2_20140406_bil.bil&quot;</code></pre>
<p>We now prepare for parallelized extractions and then implement them using <code>future_apply()</code> (you can have a look at Chapter <a href="par-comp.html#par-comp">A</a> to familiarize yourself with parallel computation using the <code>future.apply</code> package).</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="demonstration-3-land-use-and-weather.html#cb57-1"></a><span class="co">#--- define the number of cores to use ---#</span></span>
<span id="cb57-2"><a href="demonstration-3-land-use-and-weather.html#cb57-2"></a>num_core &lt;-<span class="st"> </span><span class="dv">6</span></span>
<span id="cb57-3"><a href="demonstration-3-land-use-and-weather.html#cb57-3"></a></span>
<span id="cb57-4"><a href="demonstration-3-land-use-and-weather.html#cb57-4"></a><span class="co">#--- prepare some parameters for parallelization ---#</span></span>
<span id="cb57-5"><a href="demonstration-3-land-use-and-weather.html#cb57-5"></a>file_len &lt;-<span class="st"> </span><span class="kw">length</span>(file_paths)</span>
<span id="cb57-6"><a href="demonstration-3-land-use-and-weather.html#cb57-6"></a>files_per_core &lt;-<span class="st"> </span><span class="kw">ceiling</span>(file_len<span class="op">/</span>num_core)</span>
<span id="cb57-7"><a href="demonstration-3-land-use-and-weather.html#cb57-7"></a></span>
<span id="cb57-8"><a href="demonstration-3-land-use-and-weather.html#cb57-8"></a><span class="co">#--- prepare for parallel processing ---#</span></span>
<span id="cb57-9"><a href="demonstration-3-land-use-and-weather.html#cb57-9"></a><span class="kw">plan</span>(multiprocess, <span class="dt">workers =</span> num_core)</span>
<span id="cb57-10"><a href="demonstration-3-land-use-and-weather.html#cb57-10"></a></span>
<span id="cb57-11"><a href="demonstration-3-land-use-and-weather.html#cb57-11"></a><span class="co">#--- reproject IA grids to the CRS of PRISM data ---#</span></span>
<span id="cb57-12"><a href="demonstration-3-land-use-and-weather.html#cb57-12"></a>IA_grids_reprojected &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(prism_whole))</span></code></pre></div>
<p>Here is the function that we run in parallel over 6 cores.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="demonstration-3-land-use-and-weather.html#cb58-1"></a><span class="co">#--- define the function to extract PRISM values by block of files ---#</span></span>
<span id="cb58-2"><a href="demonstration-3-land-use-and-weather.html#cb58-2"></a>extract_by_block &lt;-<span class="st"> </span><span class="cf">function</span>(i, files_per_core) {</span>
<span id="cb58-3"><a href="demonstration-3-land-use-and-weather.html#cb58-3"></a></span>
<span id="cb58-4"><a href="demonstration-3-land-use-and-weather.html#cb58-4"></a>  <span class="co">#--- files processed by core  ---#</span></span>
<span id="cb58-5"><a href="demonstration-3-land-use-and-weather.html#cb58-5"></a>  start_file_index &lt;-<span class="st"> </span>(i<span class="dv">-1</span>) <span class="op">*</span><span class="st"> </span>files_per_core <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb58-6"><a href="demonstration-3-land-use-and-weather.html#cb58-6"></a></span>
<span id="cb58-7"><a href="demonstration-3-land-use-and-weather.html#cb58-7"></a>  <span class="co">#--- indexes for files to process ---#</span></span>
<span id="cb58-8"><a href="demonstration-3-land-use-and-weather.html#cb58-8"></a>  file_index &lt;-<span class="st"> </span><span class="kw">seq</span>(</span>
<span id="cb58-9"><a href="demonstration-3-land-use-and-weather.html#cb58-9"></a>    <span class="dt">from =</span> start_file_index,</span>
<span id="cb58-10"><a href="demonstration-3-land-use-and-weather.html#cb58-10"></a>    <span class="dt">to =</span> <span class="kw">min</span>((start_file_index <span class="op">+</span><span class="st"> </span>files_per_core), file_len),</span>
<span id="cb58-11"><a href="demonstration-3-land-use-and-weather.html#cb58-11"></a>    <span class="dt">by =</span> <span class="dv">1</span></span>
<span id="cb58-12"><a href="demonstration-3-land-use-and-weather.html#cb58-12"></a>  )</span>
<span id="cb58-13"><a href="demonstration-3-land-use-and-weather.html#cb58-13"></a></span>
<span id="cb58-14"><a href="demonstration-3-land-use-and-weather.html#cb58-14"></a>  <span class="co">#--- extract values ---# </span></span>
<span id="cb58-15"><a href="demonstration-3-land-use-and-weather.html#cb58-15"></a>  data_temp &lt;-<span class="st"> </span>file_paths[file_index] <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># get file names</span></span>
<span id="cb58-16"><a href="demonstration-3-land-use-and-weather.html#cb58-16"></a><span class="st">    </span><span class="co">#--- stack files ---#</span></span>
<span id="cb58-17"><a href="demonstration-3-land-use-and-weather.html#cb58-17"></a><span class="st">    </span><span class="kw">stack</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-18"><a href="demonstration-3-land-use-and-weather.html#cb58-18"></a><span class="st">    </span><span class="co">#--- extract ---#</span></span>
<span id="cb58-19"><a href="demonstration-3-land-use-and-weather.html#cb58-19"></a><span class="st">    </span><span class="kw">exact_extract</span>(., IA_grids_reprojected) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-20"><a href="demonstration-3-land-use-and-weather.html#cb58-20"></a><span class="st">    </span><span class="co">#--- combine into one data set ---#</span></span>
<span id="cb58-21"><a href="demonstration-3-land-use-and-weather.html#cb58-21"></a><span class="st">    </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;ID&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-22"><a href="demonstration-3-land-use-and-weather.html#cb58-22"></a><span class="st">    </span><span class="co">#--- wide to long ---#</span></span>
<span id="cb58-23"><a href="demonstration-3-land-use-and-weather.html#cb58-23"></a><span class="st">    </span><span class="kw">melt</span>(<span class="dt">id.var =</span> <span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;coverage_fraction&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-24"><a href="demonstration-3-land-use-and-weather.html#cb58-24"></a><span class="st">    </span><span class="co">#--- calculate &quot;area&quot;-weighted mean ---#</span></span>
<span id="cb58-25"><a href="demonstration-3-land-use-and-weather.html#cb58-25"></a><span class="st">    </span>.[, .(<span class="dt">value =</span> <span class="kw">sum</span>(value <span class="op">*</span><span class="st"> </span>coverage_fraction)<span class="op">/</span><span class="kw">sum</span>(coverage_fraction)), by =<span class="st"> </span>.(ID, variable)]</span>
<span id="cb58-26"><a href="demonstration-3-land-use-and-weather.html#cb58-26"></a></span>
<span id="cb58-27"><a href="demonstration-3-land-use-and-weather.html#cb58-27"></a>  <span class="kw">return</span>(data_temp)</span>
<span id="cb58-28"><a href="demonstration-3-land-use-and-weather.html#cb58-28"></a>}</span></code></pre></div>
<p>Now, let’s run the function in parallel and calculate precipitation by period.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="demonstration-3-land-use-and-weather.html#cb59-1"></a><span class="co">#--- run the function ---#</span></span>
<span id="cb59-2"><a href="demonstration-3-land-use-and-weather.html#cb59-2"></a>precip_by_period &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(<span class="dv">1</span><span class="op">:</span>num_core, <span class="cf">function</span>(x) <span class="kw">extract_by_block</span>(x, files_per_core)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbindlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-3"><a href="demonstration-3-land-use-and-weather.html#cb59-3"></a><span class="st">  </span><span class="co">#--- recover the date ---#</span></span>
<span id="cb59-4"><a href="demonstration-3-land-use-and-weather.html#cb59-4"></a><span class="st">  </span>.[, variable <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">str_extract</span>(variable, <span class="st">&quot;[0-9]{8}&quot;</span>), <span class="st">&quot;%Y%m%d&quot;</span>)] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-5"><a href="demonstration-3-land-use-and-weather.html#cb59-5"></a><span class="st">  </span><span class="co">#--- change the variable name to date ---#</span></span>
<span id="cb59-6"><a href="demonstration-3-land-use-and-weather.html#cb59-6"></a><span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-7"><a href="demonstration-3-land-use-and-weather.html#cb59-7"></a><span class="st">  </span><span class="co">#--- define critical period ---#</span></span>
<span id="cb59-8"><a href="demonstration-3-land-use-and-weather.html#cb59-8"></a><span class="st">  </span>.[,critical <span class="op">:</span><span class="er">=</span><span class="st"> &quot;non_critical&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-9"><a href="demonstration-3-land-use-and-weather.html#cb59-9"></a><span class="st">  </span>.[<span class="kw">month</span>(date) <span class="op">%in%</span><span class="st"> </span><span class="dv">6</span><span class="op">:</span><span class="dv">8</span>, critical <span class="op">:</span><span class="er">=</span><span class="st"> &quot;critical&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb59-10"><a href="demonstration-3-land-use-and-weather.html#cb59-10"></a><span class="st">  </span><span class="co">#--- total precipitation by critical dummy  ---#</span></span>
<span id="cb59-11"><a href="demonstration-3-land-use-and-weather.html#cb59-11"></a><span class="st">  </span>.[, .(<span class="dt">precip=</span><span class="kw">sum</span>(value)), by =<span class="st"> </span>.(ID, critical)] <span class="op">%&gt;%</span></span>
<span id="cb59-12"><a href="demonstration-3-land-use-and-weather.html#cb59-12"></a><span class="st">  </span><span class="co">#--- wide to long ---#</span></span>
<span id="cb59-13"><a href="demonstration-3-land-use-and-weather.html#cb59-13"></a><span class="st">  </span><span class="kw">dcast</span>(ID <span class="op">~</span><span class="st"> </span>critical, <span class="dt">value.var =</span> <span class="st">&quot;precip&quot;</span>)</span></code></pre></div>
<p>We now have grid-level crop share and precipitation data.</p>
<hr />
<p>Let’s merge them and run regression.<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="demonstration-3-land-use-and-weather.html#cb60-1"></a><span class="co">#--- crop share ---#</span></span>
<span id="cb60-2"><a href="demonstration-3-land-use-and-weather.html#cb60-2"></a>reg_data &lt;-<span class="st"> </span>corn_soy[precip_by_period, on =<span class="st"> </span><span class="kw">c</span>(<span class="dt">grid_id =</span> <span class="st">&quot;ID&quot;</span>)]</span>
<span id="cb60-3"><a href="demonstration-3-land-use-and-weather.html#cb60-3"></a></span>
<span id="cb60-4"><a href="demonstration-3-land-use-and-weather.html#cb60-4"></a><span class="co">#--- OLS ---#</span></span>
<span id="cb60-5"><a href="demonstration-3-land-use-and-weather.html#cb60-5"></a>reg_results &lt;-<span class="st"> </span><span class="kw">lm</span>(c_s_ratio <span class="op">~</span><span class="st"> </span>critical <span class="op">+</span><span class="st"> </span>non_critical, <span class="dt">data =</span> reg_data)</span></code></pre></div>
<p>Here is the regression results table.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="demonstration-3-land-use-and-weather.html#cb61-1"></a><span class="co">#--- regression table ---#</span></span>
<span id="cb61-2"><a href="demonstration-3-land-use-and-weather.html#cb61-2"></a><span class="kw">stargazer</span>(reg_results, <span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</span></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
c_s_ratio
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
critical
</td>
<td>
-0.002<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
non_critical
</td>
<td>
-0.0003
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
2.701<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.161)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
1,218
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.058
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.056
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
0.743 (df = 1215)
</td>
</tr>
<tr>
<td style="text-align:left">
F Statistic
</td>
<td>
37.234<sup>***</sup> (df = 2; 1215)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
<p>Again, do not read into the results as the econometric model is terrible.</p>
<hr />
</div>
</div>
<div class="footnotes">
<hr />
<ol start="17">
<li id="fn17"><p>We by no means are saying that this is the right geographical unit of analysis. This is just about demonstrating how R can be used for analysis done at the higher spatial resolution than county.<a href="demonstration-3-land-use-and-weather.html#fnref17" class="footnote-back">↩︎</a></p></li>
<li id="fn18"><p>You do not have to run this code to download the data. It is included in the data folder for replication (<a href="https://www.dropbox.com/sh/cyx9clgmshwc8eo/AAApv03Qpx84IGKCyF5v2rJ6a?dl=0">here</a>).<a href="demonstration-3-land-use-and-weather.html#fnref18" class="footnote-back">↩︎</a></p></li>
<li id="fn19"><p><a href="https://github.com/ropensci/prism">prism github page</a><a href="demonstration-3-land-use-and-weather.html#fnref19" class="footnote-back">↩︎</a></p></li>
<li id="fn20"><p>For this project, I could have just used monthly PRISM data, which can be downloaded using the <code>get_prism_monthlys()</code> function. But, in many applications, daily data is necessary, so I wanted to illustrate how to download and process them.<a href="demonstration-3-land-use-and-weather.html#fnref20" class="footnote-back">↩︎</a></p></li>
<li id="fn21"><p>Do not use <code>st_buffer()</code> for spatial objects in geographic coordinates (latitude, longitude) if you intend to use the created buffers for any serious IA (it is difficult to get the right distance parameter anyway.). Significant distortion will be introduced to the buffer due to the fact that one degree in latitude and longitude means different distances at the latitude of IA. Here, I am just creating a buffer to extract PRISM cells to display on the map.<a href="demonstration-3-land-use-and-weather.html#fnref21" class="footnote-back">↩︎</a></p></li>
<li id="fn22"><p>In practice, this may not be advisable. The coverage fraction calculation by <code>exact_extract()</code> is done using latitude and longitude. Therefore, the relative magnitude of the fraction numbers incorrectly reflects the actual relative magnitude of the overlapped area. When the spatial resolution of the sources grids (grids from which you extract values) is much smaller relative to that of the target grids (grids to which you assign values to), then a simple average would be very similar to a coverage-weighted mean. For example, CDL consists of 30m by 30m grids, and more than <span class="math inline">\(1,000\)</span> grids are inside one analysis grid.<a href="demonstration-3-land-use-and-weather.html#fnref22" class="footnote-back">↩︎</a></p></li>
<li id="fn23"><p>Parallelization of extracting values from many raster layers for polygons are discussed in much more detail in Chapter <a href="EE.html#EE">6</a>. When I tried stacking all 183 files into one stack and applying <code>exact_extract</code>, it did not finish the job after over five minutes. So, I terminated the process in the middle. The parallelized version gets the job done in about <span class="math inline">\(30\)</span> seconds on my desktop.<a href="demonstration-3-land-use-and-weather.html#fnref23" class="footnote-back">↩︎</a></p></li>
<li id="fn24"><p>We can match on <code>grid_id</code> from <code>corn_soy</code> and <code>ID</code> from “precip_by_period” because <code>grid_id</code> is identical with the row number and ID variables were created so that the ID value of <span class="math inline">\(i\)</span> corresponds to <span class="math inline">\(i\)</span> th row of <code>IA_grids</code>.<a href="demonstration-3-land-use-and-weather.html#fnref24" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="demonstration-2-precision-agriculture.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="demo4.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
