<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 1 R as GIS: Demonstrations | R as GIS for Economists</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 R as GIS: Demonstrations | R as GIS for Economists" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 1 R as GIS: Demonstrations | R as GIS for Economists" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Taro Mieno" />


<meta name="date" content="2020-05-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="preface.html"/>
<link rel="next" href="vector-basics.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R as GIS for Economists</a></li>

<li class="divider"></li>
</ul></li>
<li class="chapter" data-level="1" data-path="demo.html"><a href="demo.html"><i class="fa fa-check"></i><b>1</b> R as GIS: Demonstrations</a><ul>
<li class="chapter" data-level="" data-path="demo.html"><a href="demo.html#before-you-start"><i class="fa fa-check"></i>Before you start</a><ul>
<li class="chapter" data-level="" data-path="demo.html"><a href="demo.html#target-audience"><i class="fa fa-check"></i>Target Audience</a></li>
<li class="chapter" data-level="" data-path="demo.html"><a href="demo.html#direction-for-replication"><i class="fa fa-check"></i>Direction for replication</a></li>
</ul></li>
<li class="chapter" data-level="1.1" data-path="demo.html"><a href="demo.html#Demo1"><i class="fa fa-check"></i><b>1.1</b> Demonstration 1: The impact of groundwater pumping on depth to water table</a><ul>
<li class="chapter" data-level="1.1.1" data-path="demo.html"><a href="demo.html#project-overview"><i class="fa fa-check"></i><b>1.1.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.1.2" data-path="demo.html"><a href="demo.html#project-demonstration"><i class="fa fa-check"></i><b>1.1.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="demo.html"><a href="demo.html#demonstration-2-precision-agriculture"><i class="fa fa-check"></i><b>1.2</b> Demonstration 2: Precision Agriculture</a><ul>
<li class="chapter" data-level="1.2.1" data-path="demo.html"><a href="demo.html#project-overview-1"><i class="fa fa-check"></i><b>1.2.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.2.2" data-path="demo.html"><a href="demo.html#project-demonstration-1"><i class="fa fa-check"></i><b>1.2.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="demo.html"><a href="demo.html#demonstration-3-land-use-and-weather"><i class="fa fa-check"></i><b>1.3</b> Demonstration 3: Land Use and Weather</a><ul>
<li class="chapter" data-level="1.3.1" data-path="demo.html"><a href="demo.html#project-overview-2"><i class="fa fa-check"></i><b>1.3.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.3.2" data-path="demo.html"><a href="demo.html#project-demonstration-2"><i class="fa fa-check"></i><b>1.3.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="demo.html"><a href="demo.html#demo4"><i class="fa fa-check"></i><b>1.4</b> Demonstration 4: The Impact of Railroad Presence on Corn Planted Acreage</a><ul>
<li class="chapter" data-level="1.4.1" data-path="demo.html"><a href="demo.html#project-overview-3"><i class="fa fa-check"></i><b>1.4.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.4.2" data-path="demo.html"><a href="demo.html#project-demonstration-3"><i class="fa fa-check"></i><b>1.4.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="demo.html"><a href="demo.html#demonstration-5-groundwater-use-for-agricultural-irrigation"><i class="fa fa-check"></i><b>1.5</b> Demonstration 5: Groundwater use for agricultural irrigation</a><ul>
<li class="chapter" data-level="1.5.1" data-path="demo.html"><a href="demo.html#project-overview-4"><i class="fa fa-check"></i><b>1.5.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.5.2" data-path="demo.html"><a href="demo.html#project-demonstration-4"><i class="fa fa-check"></i><b>1.5.2</b> Project Demonstration</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="vector-basics.html"><a href="vector-basics.html"><i class="fa fa-check"></i><b>2</b> Handle vector data using the sf package</a><ul>
<li class="chapter" data-level="" data-path="vector-basics.html"><a href="vector-basics.html#before-you-start-1"><i class="fa fa-check"></i>Before you start</a><ul>
<li><a href="vector-basics.html#sf-or-sp"><code>sf</code> or <code>sp</code>?</a></li>
</ul></li>
<li class="chapter" data-level="2.1" data-path="vector-basics.html"><a href="vector-basics.html#spatial-data-structure"><i class="fa fa-check"></i><b>2.1</b> Spatial Data Structure</a></li>
<li class="chapter" data-level="2.2" data-path="vector-basics.html"><a href="vector-basics.html#simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature"><i class="fa fa-check"></i><b>2.2</b> Simple feature geometry, simple feature geometry list-column, and simple feature</a><ul>
<li class="chapter" data-level="2.2.1" data-path="vector-basics.html"><a href="vector-basics.html#simple-feature-geometry-sfg"><i class="fa fa-check"></i><b>2.2.1</b> Simple feature geometry (<code>sfg</code>)</a></li>
<li class="chapter" data-level="2.2.2" data-path="vector-basics.html"><a href="vector-basics.html#create-simple-feature-geometry-list-column-sfc-and-simple-feature-sf-from-scratch"><i class="fa fa-check"></i><b>2.2.2</b> Create simple feature geometry list-column (<code>sfc</code>) and simple feature (<code>sf</code>) from scratch</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="vector-basics.html"><a href="vector-basics.html#reading-and-writing-vector-data"><i class="fa fa-check"></i><b>2.3</b> Reading and writing vector data</a><ul>
<li class="chapter" data-level="2.3.1" data-path="vector-basics.html"><a href="vector-basics.html#reading-a-shapefile"><i class="fa fa-check"></i><b>2.3.1</b> Reading a shapefile</a></li>
<li class="chapter" data-level="2.3.2" data-path="vector-basics.html"><a href="vector-basics.html#writing-to-a-shapefile"><i class="fa fa-check"></i><b>2.3.2</b> Writing to a shapefile</a></li>
<li class="chapter" data-level="2.3.3" data-path="vector-basics.html"><a href="vector-basics.html#better-alternatives"><i class="fa fa-check"></i><b>2.3.3</b> Better alternatives</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="vector-basics.html"><a href="vector-basics.html#projection-with-a-different-coordinate-reference-systems"><i class="fa fa-check"></i><b>2.4</b> Projection with a different Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.5" data-path="vector-basics.html"><a href="vector-basics.html#non-spatial-transformation-of-sf"><i class="fa fa-check"></i><b>2.5</b> Non-spatial transformation of sf</a></li>
<li class="chapter" data-level="2.6" data-path="vector-basics.html"><a href="vector-basics.html#turning-a-data.frame-of-points-into-an-sf"><i class="fa fa-check"></i><b>2.6</b> Turning a data.frame of points into an <code>sf</code></a></li>
<li class="chapter" data-level="2.7" data-path="vector-basics.html"><a href="vector-basics.html#conversion-to-and-from-sp"><i class="fa fa-check"></i><b>2.7</b> Conversion to and from sp</a></li>
<li class="chapter" data-level="2.8" data-path="vector-basics.html"><a href="vector-basics.html#geometrical-operations"><i class="fa fa-check"></i><b>2.8</b> Geometrical operations</a><ul>
<li class="chapter" data-level="2.8.1" data-path="vector-basics.html"><a href="vector-basics.html#st_buffer"><i class="fa fa-check"></i><b>2.8.1</b> st_buffer</a></li>
<li class="chapter" data-level="2.8.2" data-path="vector-basics.html"><a href="vector-basics.html#st_area"><i class="fa fa-check"></i><b>2.8.2</b> st_area</a></li>
<li class="chapter" data-level="2.8.3" data-path="vector-basics.html"><a href="vector-basics.html#st_centroid"><i class="fa fa-check"></i><b>2.8.3</b> st_centroid</a></li>
<li class="chapter" data-level="2.8.4" data-path="vector-basics.html"><a href="vector-basics.html#st_length"><i class="fa fa-check"></i><b>2.8.4</b> st_length</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html"><i class="fa fa-check"></i><b>3</b> Spatial Interactions of Vector Data: Subsetting and Joining</a><ul>
<li class="chapter" data-level="3.1" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#topological-relations"><i class="fa fa-check"></i><b>3.1</b> Topological relations</a><ul>
<li class="chapter" data-level="3.1.1" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#st_intersects"><i class="fa fa-check"></i><b>3.1.1</b> st_intersects()</a></li>
<li class="chapter" data-level="3.1.2" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#st_intersection"><i class="fa fa-check"></i><b>3.1.2</b> st_intersection()</a></li>
<li class="chapter" data-level="3.1.3" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#st_is_within_distance"><i class="fa fa-check"></i><b>3.1.3</b> st_is_within_distance()</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#spatial-subsetting-or-flagging"><i class="fa fa-check"></i><b>3.2</b> Spatial Subsetting (or Flagging)</a><ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#polygons-vs-polygons"><i class="fa fa-check"></i><b>3.2.1</b> polygons vs polygons</a></li>
<li class="chapter" data-level="3.2.2" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#points-vs-polygons"><i class="fa fa-check"></i><b>3.2.2</b> points vs polygons</a></li>
<li class="chapter" data-level="3.2.3" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#lines-vs-polygons"><i class="fa fa-check"></i><b>3.2.3</b> lines vs polygons</a></li>
<li class="chapter" data-level="3.2.4" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#flagging-instead-of-subsetting"><i class="fa fa-check"></i><b>3.2.4</b> Flagging instead of subsetting</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#spatial-join"><i class="fa fa-check"></i><b>3.3</b> Spatial Join</a><ul>
<li class="chapter" data-level="3.3.1" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#case-1-points-target-vs-polygons-source"><i class="fa fa-check"></i><b>3.3.1</b> Case 1: points (target) vs polygons (source)</a></li>
<li class="chapter" data-level="3.3.2" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#case-2-polygons-target-vs-points-source"><i class="fa fa-check"></i><b>3.3.2</b> Case 2: polygons (target) vs points (source)</a></li>
<li class="chapter" data-level="3.3.3" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html#polygon-polygon"><i class="fa fa-check"></i><b>3.3.3</b> Case 3: polygons (target) vs polygons (source)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R as GIS for Economists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script>
<div id="demo" class="section level1">
<h1><span class="header-section-number">Chapter 1</span> R as GIS: Demonstrations</h1>
<div id="before-you-start" class="section level2 unnumbered">
<h2>Before you start</h2>
<p>The primary objective of this chapter is to showcase the power of R as GIS through demonstrations using mock-up econometric research projects<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>. Each project consists of a project overview (objective, datasets used, econometric model, and GIS tasks involved) and demonstration. This is really not a place you learn the nuts and bolts of how R does spatial operations. Indeed, we intentionally do not explain all the details of how the R codes work. We reiterate that the main purpose of the demonstrations is to get you a better idea of how R can be used to process spatial data to help your research projects involving spatial datasets. Finally, note that these <em>mock-up</em> projects use extremely simple econometric models that completely lacks careful thoughts you would need in real research projects. So, don’t waste your time judging the econometric models, and just focus on GIS tasks. If you are not familiar with html documents generated by <code>rmarkdown</code>, you might benefit from reading the conventions of the book in the Preface.</p>
<div id="target-audience" class="section level3 unnumbered">
<h3>Target Audience</h3>
<p>The target audience of this chapter is those who are not very familiar with R as GIS. Knowledge of R certainly helps. But, I tried to write in a way that R beginners can still understand the power of R as GIS<a href="#fn10" class="footnote-ref" id="fnref10"><sup>10</sup></a>. Do not get bogged down by all the complex-looking R codes. Just focus on the narratives and figures to get a sense of what R can do.</p>
</div>
<div id="direction-for-replication" class="section level3 unnumbered">
<h3>Direction for replication</h3>
<p>Running the codes in this chapter involves reading datasets from a disk. All the datasets that will be imported are available <a href="https://www.dropbox.com/sh/cyx9clgmshwc8eo/AAApv03Qpx84IGKCyF5v2rJ6a?dl=0">here</a>. In this chapter, the path to files is set relative to my own working directory (which is hidden). To run the codes without having to mess with paths to the files, follow these steps:<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a></p>
<ul>
<li>set a folder (any folder) as the working directory using <code>setwd()</code><br />
</li>
<li>create a folder called “Data” inside the folder designated as the working directory<br />
</li>
<li>download the pertinent datasets from <a href="https://www.dropbox.com/sh/cyx9clgmshwc8eo/AAApv03Qpx84IGKCyF5v2rJ6a?dl=0">here</a> and put them in the “Data” folder</li>
<li>run <em>Chap_1_Demonstration.R</em> which is included in the datasets folder you have downloaded</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&quot;Data/Chap_1_Demonstration.R&quot;</span>)</a></code></pre></div>
<p>Note that the data folder includes 183-day worth of PRISM precipitation data for Demonstration 3, which are quite large in size (slightly less than 1 GB). If you are not replicating Demonstration 3, you can either choose not to download them or discard them if you have downloaded them already.</p>
</div>
</div>
<div id="Demo1" class="section level2">
<h2><span class="header-section-number">1.1</span> Demonstration 1: The impact of groundwater pumping on depth to water table</h2>
<!-- this is for making stargazer table nicer -->
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Project Overview</h3>
<hr />
<p><strong>Objective:</strong></p>
<ul>
<li>Understand the impact of groundwater pumping on groundwater level.</li>
</ul>
<hr />
<p><strong>Datasets</strong></p>
<ul>
<li>Groundwater pumping by irrigation wells in Chase, Dundy, and Perkins Counties in the southwest corner of Nebraska</li>
<li>Groundwater levels observed at USGS monitoring wells located in the three counties and retrieved from the National Water Information System (NWIS) maintained by USGS using the <code>dataRetrieval</code> package.</li>
</ul>
<hr />
<p><strong>Econometric Model</strong></p>
<p>In order to achieve the project objective, we will estimate the following model:</p>
<p><span class="math display">\[
 y_{i,t} - y_{i,t-1} = \alpha + \beta gw_{i,t-1} + v
\]</span></p>
<p>where <span class="math inline">\(y_{i,t}\)</span> is the depth to groundwater table<a href="#fn12" class="footnote-ref" id="fnref12"><sup>12</sup></a> in March<a href="#fn13" class="footnote-ref" id="fnref13"><sup>13</sup></a> in year <span class="math inline">\(t\)</span> at USGS monitoring well <span class="math inline">\(i\)</span>, and <span class="math inline">\(gw_{i,t-1}\)</span> is the total amount of groundwater pumping that happened within the 2-mile radius of the monitoring well <span class="math inline">\(i\)</span>.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>read an ESRI shape file as an <code>sf</code> (spatial) object
<ul>
<li>use <code>sf::st_read()</code></li>
</ul></li>
<li>download depth to water table data using the <code>dataRetrieval</code> package developed by USGS
<ul>
<li>use <code>dataRetrieval::readNWISdata()</code> and <code>dataRetrieval::readNWISsite()</code></li>
</ul></li>
<li>create a buffer around USGS monitoring wells
<ul>
<li>use <code>sf::st_buffer()</code></li>
</ul></li>
<li>convert a regular <code>data.frame</code> (non-spatial) with geographic coordinates into an <code>sf</code> (spatial) objects
<ul>
<li>use <code>sf::st_as_sf()</code> and <code>sf::st_set_crs()</code></li>
</ul></li>
<li>reproject an <code>sf</code> object to another CRS
<ul>
<li>use <code>sf::st_transform()</code></li>
</ul></li>
<li>identify irrigation wells located inside the buffers and calculate total pumping
<ul>
<li>use <code>sf::st_join()</code></li>
</ul></li>
</ul>
<hr />
<p><strong>packages</strong></p>
<ul>
<li>Load (install first if you have not) the following packages if you intend to replicate the demonstration.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">library</span>(stargazer)</a></code></pre></div>
<p>There are other packages that will be loaded during the demonstration.</p>
</div>
<div id="project-demonstration" class="section level3">
<h3><span class="header-section-number">1.1.2</span> Project Demonstration</h3>
<p>The geographic focus of the project is the southwest corner of Nebraska consisting of Chase, Dundy, and Perkins County (see Figure <a href="demo.html#fig:NE-county">1.1</a> for their locations within Nebraska). Let’s read a shape file of the three counties represented as polygons. We will use it later to spatially filter groundwater level data downloaded from NWIS.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">three_counties &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;./Data&quot;</span>, <span class="dt">layer =</span> <span class="st">&quot;urnrd&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">  </span><span class="co">#--- project to WGS84/UTM 14N ---#</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">32614</span>)</a></code></pre></div>
<pre><code>Reading layer `urnrd&#39; from data source `/Users/tmieno2/Dropbox/TeachingUNL/RGIS_Econ/Data&#39; using driver `ESRI Shapefile&#39;
Simple feature collection with 3 features and 1 field
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: -102.0518 ymin: 40.00257 xmax: -101.248 ymax: 41.00395
CRS:            4269</code></pre>
<div class="figure"><span id="fig:NE-county"></span>
<img src="Demonstration_files/figure-html/NE-county-1.png" alt="The location of Chase, Dundy, and Perkins County in Nebraska" width="672" />
<p class="caption">
Figure 1.1: The location of Chase, Dundy, and Perkins County in Nebraska
</p>
</div>
<hr />
<p>We have already collected groundwater pumping data, so let’s import it.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co">#--- groundwater pumping data ---#</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">(</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">urnrd_gw &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./Data/urnrd_gw_pumping.rds&quot;</span>)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">)</a></code></pre></div>
<pre><code>       well_id year  vol_af      lon     lat
    1:    1706 2007 182.566 245322.3 4542717
    2:    2116 2007  46.328 245620.9 4541125
    3:    2583 2007  38.380 245660.9 4542523
    4:    2597 2007  70.133 244816.2 4541143
    5:    3143 2007 135.870 243614.0 4541579
   ---                                      
18668:    2006 2012 148.713 284782.5 4432317
18669:    2538 2012 115.567 284462.6 4432331
18670:    2834 2012  15.766 283338.0 4431341
18671:    2834 2012 381.622 283740.4 4431329
18672:    4983 2012      NA 284636.0 4432725</code></pre>
<p><code>well_id</code> is the unique irrigation well identifier, and <code>vol_af</code> is the amount of groundwater pumped in acre-feet. This dataset is just a regular <code>data.frame</code> with coordinates. We need to convert this dataset into a object of class <code>sf</code> so that we can later identify irrigation wells located within a 2-mile radius of USGS monitoring wells (see Figure <a href="demo.html#fig:sp-dist-wells">1.2</a> for the spatial distribution of the irrigation wells).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">urnrd_gw_sf &lt;-<span class="st"> </span>urnrd_gw <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="co">#--- convert to sf ---#</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="co">#--- set CRS WGS UTM 14 (you need to know the CRS of the coordinates to do this) ---# </span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw">st_set_crs</span>(<span class="dv">32614</span>) </a>
<a class="sourceLine" id="cb14-6" data-line-number="6"></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#--- now sf ---#</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">urnrd_gw_sf</a></code></pre></div>
<pre><code>Simple feature collection with 18672 features and 3 fields
geometry type:  POINT
dimension:      XY
bbox:           xmin: 239959 ymin: 4431329 xmax: 310414.4 ymax: 4543146
CRS:            EPSG:32614
First 10 features:
   well_id year  vol_af                 geometry
1     1706 2007 182.566 POINT (245322.3 4542717)
2     2116 2007  46.328 POINT (245620.9 4541125)
3     2583 2007  38.380 POINT (245660.9 4542523)
4     2597 2007  70.133 POINT (244816.2 4541143)
5     3143 2007 135.870   POINT (243614 4541579)
6     5017 2007 196.799 POINT (243539.9 4543146)
7     1706 2008 171.250 POINT (245322.3 4542717)
8     2116 2008 171.650 POINT (245620.9 4541125)
9     2583 2008  46.100 POINT (245660.9 4542523)
10    2597 2008 124.830 POINT (244816.2 4541143)</code></pre>
<div class="figure"><span id="fig:sp-dist-wells"></span>
<img src="Demonstration_files/figure-html/sp-dist-wells-1.png" alt="Spatial distribution of irrigation wells" width="672" />
<p class="caption">
Figure 1.2: Spatial distribution of irrigation wells
</p>
</div>
<hr />
<p>Here are the rest of the steps we will take to obtain a regression-ready dataset for our analysis.</p>
<ol style="list-style-type: decimal">
<li>download groundwater level data observed at USGS monitoring wells from National Water Information System (NWIS) using the <code>dataRetrieval</code> package</li>
<li>identify the irrigation wells located within the 2-mile radius of the USGS wells and calculate the total groundwater pumping that occurred around each of the USGS wells by year</li>
<li>merge the groundwater pumping data to the groundwater level data</li>
</ol>
<hr />
<p>Let’s download groundwater level data from NWIS first. The following code downloads groundwater level data for Nebraska from Jan 1, 1990, through Jan 1, 2016.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">#--- load the dataRetrieval package ---#</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">library</span>(dataRetrieval)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co">#--- download groundwater level data ---#</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">NE_gwl &lt;-<span class="st"> </span><span class="kw">readNWISdata</span>(</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">    <span class="dt">stateCd=</span><span class="st">&quot;Nebraska&quot;</span>, </a>
<a class="sourceLine" id="cb16-7" data-line-number="7">    <span class="dt">startDate =</span> <span class="st">&quot;1990-01-01&quot;</span>, </a>
<a class="sourceLine" id="cb16-8" data-line-number="8">    <span class="dt">endDate =</span> <span class="st">&quot;2016-01-01&quot;</span>, </a>
<a class="sourceLine" id="cb16-9" data-line-number="9">    <span class="dt">service =</span> <span class="st">&quot;gwlevels&quot;</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(site_no, lev_dt, lev_va) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">date =</span> lev_dt, <span class="dt">dwt =</span> lev_va) </a>
<a class="sourceLine" id="cb16-13" data-line-number="13"></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="co">#--- take a look ---#</span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="kw">head</span>(NE_gwl, <span class="dv">10</span>)</a></code></pre></div>
<pre><code>           site_no       date   dwt
1  400008097545301 2000-11-08 17.40
2  400008097545301 2008-10-09 13.99
3  400008097545301 2009-04-09 11.32
4  400008097545301 2009-10-06 15.54
5  400008097545301 2010-04-12 11.15
6  400008100050501 1990-03-15 24.80
7  400008100050501 1990-10-04 27.20
8  400008100050501 1991-03-08 24.20
9  400008100050501 1991-10-07 26.90
10 400008100050501 1992-03-02 24.70</code></pre>
<p><code>site_no</code> is the unique monitoring well identifier, <code>date</code> is the date of groundwater level monitoring, and <code>dwt</code> is depth to water table.</p>
<p>We calculate the average groundwater level in March by USGS monitoring well (right before the irrigation season starts):<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co">#--- Average depth to water table in March ---#</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">NE_gwl_march &lt;-<span class="st"> </span>NE_gwl <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">    <span class="dt">date =</span> <span class="kw">as.Date</span>(date),</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">    <span class="dt">month =</span> <span class="kw">month</span>(date),</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">    <span class="dt">year =</span> <span class="kw">year</span>(date),</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="st">  </span><span class="co">#--- select observation in March ---#</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2007</span>, month <span class="op">==</span><span class="st"> </span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="st">  </span><span class="co">#--- gwl average in March ---#</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(site_no, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">dwt  =</span> <span class="kw">mean</span>(dwt))</a>
<a class="sourceLine" id="cb18-13" data-line-number="13"></a>
<a class="sourceLine" id="cb18-14" data-line-number="14"><span class="co">#--- take a look ---#</span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="kw">head</span>(NE_gwl_march, <span class="dv">10</span>)</a></code></pre></div>
<pre><code># A tibble: 10 x 3
# Groups:   site_no [2]
   site_no          year   dwt
   &lt;chr&gt;           &lt;dbl&gt; &lt;dbl&gt;
 1 400032101022901  2008 118. 
 2 400032101022901  2009 117. 
 3 400032101022901  2010 118. 
 4 400032101022901  2011 118. 
 5 400032101022901  2012 118. 
 6 400032101022901  2013 118. 
 7 400032101022901  2014 116. 
 8 400032101022901  2015 117. 
 9 400038099244601  2007  24.3
10 400038099244601  2008  21.7</code></pre>
<p>Since <code>NE_gwl</code> is missing geographic coordinates for the monitoring wells, we will download them using the <code>readNWISsite()</code> function and select only the monitoring wells that are inside the three counties.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co">#--- get the list of site ids ---#  </span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">NE_site_ls &lt;-<span class="st"> </span>NE_gwl<span class="op">$</span>site_no <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co">#--- get the locations of the site ids ---#  </span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">sites_info &lt;-<span class="st"> </span><span class="kw">readNWISsite</span>(<span class="dt">siteNumbers =</span> NE_site_ls) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(site_no, dec_lat_va, dec_long_va) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="st">  </span><span class="co">#--- turn the data into an sf object ---#</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;dec_long_va&quot;</span>, <span class="st">&quot;dec_lat_va&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="st">  </span><span class="co">#--- NAD 83 ---#</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="st">  </span><span class="kw">st_set_crs</span>(<span class="dv">4269</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="st">  </span><span class="co">#--- project to WGS UTM 14 ---#</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">32614</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="st">  </span><span class="co">#--- keep only those located inside the three counties ---#</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="st">  </span>.[three_counties, ]</a></code></pre></div>
<hr />
<p>We now identify irrigation wells that are located within the 2-mile radius of the monitoring wells<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a>. We first create polygons of 2-mile radius circles around the monitoring wells (see Figure <a href="demo.html#fig:buffer-map">1.3</a>).</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">buffers &lt;-<span class="st"> </span><span class="kw">st_buffer</span>(sites_info, <span class="dt">dist =</span> <span class="dv">2</span><span class="op">*</span><span class="fl">1609.34</span>) <span class="co"># in meter</span></a></code></pre></div>
<div class="figure"><span id="fig:buffer-map"></span>
<img src="Demonstration_files/figure-html/buffer-map-1.png" alt="2-mile buffers around USGS monitoring wells" width="672" />
<p class="caption">
Figure 1.3: 2-mile buffers around USGS monitoring wells
</p>
</div>
<p>We now identify which irrigation wells are inside each of the buffers and get the associated groundwater pumping values. The <code>st_join()</code> function from the <code>sf</code> package will do the trick.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="co">#--- find irrigation wells inside the buffer and calculate total pumping  ---#</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2">pumping_neaby &lt;-<span class="st"> </span><span class="kw">st_join</span>(buffers, urnrd_gw_sf)</a></code></pre></div>
<p>Let’s take a look at a USGS monitoring well (<code>site_no</code> = <span class="math inline">\(400012101323401\)</span>).</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">filter</span>(pumping_neaby, site_no <span class="op">==</span><span class="st"> </span><span class="dv">400012101323401</span>, year <span class="op">==</span><span class="st"> </span><span class="dv">2010</span>)</a></code></pre></div>
<pre><code>Simple feature collection with 7 features and 4 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: 279690.7 ymin: 4428006 xmax: 286128 ymax: 4434444
CRS:            EPSG:32614
          site_no well_id year  vol_af                       geometry
1 400012101323401    6331 2010      NA POLYGON ((286128 4431225, 2...
2 400012101323401    1883 2010 180.189 POLYGON ((286128 4431225, 2...
3 400012101323401    2006 2010  79.201 POLYGON ((286128 4431225, 2...
4 400012101323401    2538 2010  68.205 POLYGON ((286128 4431225, 2...
5 400012101323401    2834 2010      NA POLYGON ((286128 4431225, 2...
6 400012101323401    2834 2010 122.981 POLYGON ((286128 4431225, 2...
7 400012101323401    4983 2010      NA POLYGON ((286128 4431225, 2...</code></pre>
<p>As you can see, this well has seven irrigation wells within its 2-mile radius in 2010.</p>
<p>Now, we will get total nearby pumping by monitoring well and year.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">total_pumping_nearby &lt;-<span class="st"> </span>pumping_neaby <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="st">  </span><span class="co">#--- calculate total pumping by monitoring well ---#</span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(site_no, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">nearby_pumping =</span> <span class="kw">sum</span>(vol_af, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="st">  </span><span class="co">#--- NA means 0 pumping ---#  </span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">    <span class="dt">nearby_pumping =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(nearby_pumping), <span class="dv">0</span>, nearby_pumping)</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb25-10" data-line-number="10">)</a></code></pre></div>
<pre><code>Simple feature collection with 2396 features and 3 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: 237904.5 ymin: 4428006 xmax: 313476.5 ymax: 4545687
CRS:            EPSG:32614
# A tibble: 2,396 x 4
# Groups:   site_no [401]
   site_no      year nearby_pumping                                     geometry
 * &lt;chr&gt;       &lt;int&gt;          &lt;dbl&gt;                                &lt;POLYGON [m]&gt;
 1 4000121013…  2007           571. ((286128 4431225, 286123.6 4431057, 286110.…
 2 4000121013…  2008           772. ((286128 4431225, 286123.6 4431057, 286110.…
 3 4000121013…  2009           500. ((286128 4431225, 286123.6 4431057, 286110.…
 4 4000121013…  2010           451. ((286128 4431225, 286123.6 4431057, 286110.…
 5 4000121013…  2011           545. ((286128 4431225, 286123.6 4431057, 286110.…
 6 4000121013…  2012          1028. ((286128 4431225, 286123.6 4431057, 286110.…
 7 4001301013…  2007           485. ((278847.4 4433844, 278843 4433675, 278829.…
 8 4001301013…  2008           515. ((278847.4 4433844, 278843 4433675, 278829.…
 9 4001301013…  2009           351. ((278847.4 4433844, 278843 4433675, 278829.…
10 4001301013…  2010           374. ((278847.4 4433844, 278843 4433675, 278829.…
# … with 2,386 more rows</code></pre>
<hr />
<p>We now merge nearby pumping data to the groundwater level data, and transform the data to obtain the dataset ready for regression analysis.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co">#--- regression-ready data ---#</span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2">reg_data &lt;-<span class="st"> </span>NE_gwl_march <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="st">  </span><span class="co">#--- pick monitoring wells that are inside the three counties ---#</span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(site_no <span class="op">%in%</span><span class="st"> </span><span class="kw">unique</span>(sites_info<span class="op">$</span>site_no)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="st">  </span><span class="co">#--- merge with the nearby pumping data ---#</span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(., total_pumping_nearby, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;site_no&quot;</span>, <span class="st">&quot;year&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-7" data-line-number="7"><span class="st">  </span><span class="co">#--- lead depth to water table ---#</span></a>
<a class="sourceLine" id="cb27-8" data-line-number="8"><span class="st">  </span><span class="kw">arrange</span>(site_no, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(site_no) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb27-11" data-line-number="11">    <span class="co">#--- lead depth ---#</span></a>
<a class="sourceLine" id="cb27-12" data-line-number="12">    <span class="dt">dwt_lead1 =</span> dplyr<span class="op">::</span><span class="kw">lead</span>(dwt, <span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">default =</span> <span class="ot">NA</span>, <span class="dt">order_by =</span> year),</a>
<a class="sourceLine" id="cb27-13" data-line-number="13">    <span class="co">#--- first order difference in dwt  ---#</span></a>
<a class="sourceLine" id="cb27-14" data-line-number="14">    <span class="dt">dwt_dif  =</span> dwt_lead1 <span class="op">-</span><span class="st"> </span>dwt</a>
<a class="sourceLine" id="cb27-15" data-line-number="15">  )  </a>
<a class="sourceLine" id="cb27-16" data-line-number="16"></a>
<a class="sourceLine" id="cb27-17" data-line-number="17"><span class="co">#--- take a look ---#</span></a>
<a class="sourceLine" id="cb27-18" data-line-number="18">dplyr<span class="op">::</span><span class="kw">select</span>(reg_data, site_no, year, dwt_dif, nearby_pumping)</a></code></pre></div>
<pre><code># A tibble: 2,022 x 4
# Groups:   site_no [230]
   site_no          year dwt_dif nearby_pumping
   &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;
 1 400130101374401  2011   NA              358.
 2 400134101483501  2007    2.87          2038.
 3 400134101483501  2008    0.78          2320.
 4 400134101483501  2009   -2.45          2096.
 5 400134101483501  2010    3.97          2432.
 6 400134101483501  2011    1.84          2634.
 7 400134101483501  2012   -1.35           985.
 8 400134101483501  2013   44.8             NA 
 9 400134101483501  2014  -26.7             NA 
10 400134101483501  2015   NA               NA 
# … with 2,012 more rows</code></pre>
<hr />
<p>Finally, we estimate the model using the <code>lfe</code> package.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co">#--- load the lfe package for regression with fixed effects ---#</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="kw">library</span>(lfe)</a>
<a class="sourceLine" id="cb29-3" data-line-number="3"></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="co">#--- OLS with site_no and year FEs (error clustered by site_no) ---#</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5">reg_dwt &lt;-<span class="st"> </span><span class="kw">felm</span>(dwt_dif <span class="op">~</span><span class="st"> </span>nearby_pumping <span class="op">|</span><span class="st"> </span>site_no <span class="op">+</span><span class="st"> </span>year <span class="op">|</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>site_no, <span class="dt">data =</span> reg_data)</a></code></pre></div>
<p>Here is the regression result.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">stargazer</span>(reg_dwt, <span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</a></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
dwt_dif
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
nearby_pumping
</td>
<td>
0.001<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0001)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
1,342
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.409
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.286
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
1.493 (df = 1111)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
</div>
</div>
<div id="demonstration-2-precision-agriculture" class="section level2">
<h2><span class="header-section-number">1.2</span> Demonstration 2: Precision Agriculture</h2>
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview-1" class="section level3">
<h3><span class="header-section-number">1.2.1</span> Project Overview</h3>
<hr />
<p><strong>Objectives:</strong></p>
<ul>
<li>Understand the impact of nitrogen on corn yield</li>
<li>Understand how electric conductivity (EC) affects the marginal impact of nitrogen on corn</li>
</ul>
<hr />
<p><strong>Datasets:</strong></p>
<ul>
<li>The experimental design of an on-farm randomized nitrogen trail on an 80-acre field</li>
<li>Data generated by the experiment
<ul>
<li>As-applied nitrogen rate</li>
<li>Yield measures</li>
</ul></li>
<li>Electric conductivity</li>
</ul>
<hr />
<p><strong>Econometric Model:</strong></p>
<p>Here is the econometric model, we would like to estimate:</p>
<p><span class="math display">\[
yield_i = \beta_0 + \beta_1 N_i + \beta_2 N_i^2 + \beta_3 N_i \cdot EC_i + \beta_4 N_i^2 \cdot EC_i + v_i
\]</span></p>
<p>where <span class="math inline">\(yield_i\)</span>, <span class="math inline">\(N_i\)</span>, <span class="math inline">\(EC_i\)</span>, and <span class="math inline">\(v_i\)</span> are corn yield, nitrogen rate, EC, and error term at subplot <span class="math inline">\(i\)</span>. Subplots which are obtained by dividing experimental plots into six of equal-area compartments.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>read spatial data in various formats: R data set (rds), shape file, and GeoPackage file
<ul>
<li>use <code>sf::st_read()</code></li>
</ul></li>
<li>create maps using the <code>ggplot2</code> package
<ul>
<li>use <code>ggplot2::geom_sf()</code></li>
</ul></li>
<li>create subplots within experimental plots
<ul>
<li>use-defined function that makes use of <code>st_geometry()</code></li>
</ul></li>
<li>identify corn yield, as-applied nitrogen, and electric conductivity (EC) data points within each of the experimental plots and find their averages
<ul>
<li>use <code>sf::st_join()</code> and <code>sf::aggregate()</code></li>
</ul></li>
</ul>
<hr />
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Source (run) <em>Chap_1_Demonstration.R</em> to define <code>theme_map</code> and <code>gen_subplots()</code></li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">source</span>(<span class="st">&quot;Codes/Chap_1_Demonstration.R&quot;</span>)</a></code></pre></div>
<ul>
<li>Load (install first if you have not) the following packages (There are other packages that will be loaded during the demonstration).</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="kw">library</span>(stargazer)</a></code></pre></div>
</div>
<div id="project-demonstration-1" class="section level3">
<h3><span class="header-section-number">1.2.2</span> Project Demonstration</h3>
<p>We have already run a whole-field randomized nitrogen experiment on a 80-acre field. Let’s import the trial design data</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co">#--- read the trial design data ---#</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">trial_design_<span class="dv">16</span> &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./Data/trial_design.rds&quot;</span>)</a></code></pre></div>
<p>Figure <a href="demo.html#fig:trial-fig">1.4</a> is the map of the trial design generated using <code>ggplot2</code> package.<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co">#--- map of trial design ---#</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="kw">ggplot</span>(<span class="dt">data =</span> trial_design_<span class="dv">16</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">factor</span>(NRATE))) <span class="op">+</span></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">name =</span> <span class="st">&quot;N&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"><span class="st">  </span>theme_for_map</a></code></pre></div>
<div class="figure"><span id="fig:trial-fig"></span>
<img src="Demonstration_files/figure-html/trial-fig-1.png" alt="The Experimental Design of the Randomize Nitrogen Trial" width="672" />
<p class="caption">
Figure 1.4: The Experimental Design of the Randomize Nitrogen Trial
</p>
</div>
<hr />
<p>We have collected yield, as-applied NH3, and EC data. Let’s read in these datasets:<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co">#--- read yield data (sf data saved as rds) ---#</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">yield &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./Data/yield.rds&quot;</span>)</a>
<a class="sourceLine" id="cb35-3" data-line-number="3"></a>
<a class="sourceLine" id="cb35-4" data-line-number="4"><span class="co">#--- read NH3 data (GeoPackage data) ---#</span></a>
<a class="sourceLine" id="cb35-5" data-line-number="5">NH3_data &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="st">&quot;Data/NH3.gpkg&quot;</span>)</a>
<a class="sourceLine" id="cb35-6" data-line-number="6"></a>
<a class="sourceLine" id="cb35-7" data-line-number="7"><span class="co">#--- read ec data (shape file) ---#</span></a>
<a class="sourceLine" id="cb35-8" data-line-number="8">ec &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn=</span><span class="st">&quot;Data&quot;</span>, <span class="st">&quot;ec&quot;</span>)</a></code></pre></div>
<p>Figure <a href="demo.html#fig:Demo2-show-the-map">1.5</a> shows the spatial distribution of the three variables. A map of each variable was made first, and then they are combined into one figure using the <code>patchwork</code> package<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co">#--- yield map ---#</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2">g_yield &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> trial_design_<span class="dv">16</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> yield, <span class="kw">aes</span>(<span class="dt">color =</span> yield), <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_color_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Yield&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="st">  </span>theme_for_map</a>
<a class="sourceLine" id="cb36-7" data-line-number="7"></a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="co">#--- NH3 map ---#</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9">g_NH3 &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> trial_design_<span class="dv">16</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> NH3_data, <span class="kw">aes</span>(<span class="dt">color =</span> aa_NH3), <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-12" data-line-number="12"><span class="st">  </span><span class="kw">scale_color_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;NH3&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="st">  </span>theme_for_map</a>
<a class="sourceLine" id="cb36-14" data-line-number="14"></a>
<a class="sourceLine" id="cb36-15" data-line-number="15"><span class="co">#--- NH3 map ---#</span></a>
<a class="sourceLine" id="cb36-16" data-line-number="16">g_ec &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb36-17" data-line-number="17"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> trial_design_<span class="dv">16</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-18" data-line-number="18"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> ec, <span class="kw">aes</span>(<span class="dt">color =</span> ec), <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-19" data-line-number="19"><span class="st">  </span><span class="kw">scale_color_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;EC&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-20" data-line-number="20"><span class="st">  </span>theme_for_map</a>
<a class="sourceLine" id="cb36-21" data-line-number="21"></a>
<a class="sourceLine" id="cb36-22" data-line-number="22"><span class="co">#--- stack the figures vertically and display  ---#</span></a>
<a class="sourceLine" id="cb36-23" data-line-number="23"><span class="kw">library</span>(patchwork)</a>
<a class="sourceLine" id="cb36-24" data-line-number="24">g_yield<span class="op">/</span>g_NH3<span class="op">/</span>g_ec</a></code></pre></div>
<div class="figure"><span id="fig:Demo2-show-the-map"></span>
<img src="Demonstration_files/figure-html/Demo2-show-the-map-1.png" alt="Spatial distribution of yield, NH3, and EC" width="672" />
<p class="caption">
Figure 1.5: Spatial distribution of yield, NH3, and EC
</p>
</div>
<hr />
<p>Instead of using plot as the observation unit, we would like to create subplots inside each of the plots and make them the unit of analysis because it would avoid masking the within-plot spatial heterogeneity of EC. Here, we divide each plot into six subplots<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="co">#--- generate subplots ---#</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">subplots &lt;-<span class="st"> </span><span class="kw">lapply</span>(</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">  <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(trial_design_<span class="dv">16</span>), </a>
<a class="sourceLine" id="cb37-4" data-line-number="4">  <span class="cf">function</span>(x) <span class="kw">gen_subplots</span>(trial_design_<span class="dv">16</span>[x, ], <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb37-5" data-line-number="5">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-6" data-line-number="6"><span class="st">  </span><span class="kw">do.call</span>(<span class="st">&#39;rbind&#39;</span>, .) </a></code></pre></div>
<p>Figure <a href="demo.html#fig:map-subgrid">1.6</a> is a map of the subplots generated.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="co">#--- here is what subplots look like ---#</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="kw">ggplot</span>(subplots) <span class="op">+</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_sf</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="st">  </span>theme_for_map</a></code></pre></div>
<div class="figure"><span id="fig:map-subgrid"></span>
<img src="Demonstration_files/figure-html/map-subgrid-1.png" alt="Map of the subplots" width="672" />
<p class="caption">
Figure 1.6: Map of the subplots
</p>
</div>
<hr />
<p>We now identify the mean value of corn yield, nitrogen rate, and EC for each of the subplots using <code>sf::aggregate()</code> and <code>sf::st_join()</code>.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb39-2" data-line-number="2">reg_data &lt;-<span class="st"> </span>subplots <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb39-3" data-line-number="3"><span class="st">  </span><span class="co">#--- yield ---#</span></a>
<a class="sourceLine" id="cb39-4" data-line-number="4"><span class="st">  </span><span class="kw">st_join</span>(., <span class="kw">aggregate</span>(yield, ., mean), <span class="dt">join =</span> st_equals) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-5" data-line-number="5"><span class="st">  </span><span class="co">#--- nitrogen ---#</span></a>
<a class="sourceLine" id="cb39-6" data-line-number="6"><span class="st">  </span><span class="kw">st_join</span>(., <span class="kw">aggregate</span>(NH3_data, ., mean), <span class="dt">join =</span> st_equals) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-7" data-line-number="7"><span class="st">  </span><span class="co">#--- EC ---#</span></a>
<a class="sourceLine" id="cb39-8" data-line-number="8"><span class="st">  </span><span class="kw">st_join</span>(., <span class="kw">aggregate</span>(ec, ., mean), <span class="dt">join =</span> st_equals)</a>
<a class="sourceLine" id="cb39-9" data-line-number="9">)</a></code></pre></div>
<pre><code>Simple feature collection with 816 features and 3 fields
geometry type:  POLYGON
dimension:      XY
bbox:           xmin: 560121.3 ymin: 4533410 xmax: 560758.9 ymax: 4533734
CRS:            EPSG:26914
First 10 features:
      yield   aa_NH3       ec                       geometry
1  220.1789 194.5155 28.33750 POLYGON ((560121.3 4533428,...
2  218.9671 194.4291 29.37667 POLYGON ((560134.5 4533428,...
3  220.3286 195.2903 30.73600 POLYGON ((560147.7 4533428,...
4  215.3121 196.7649 32.24000 POLYGON ((560160.9 4533429,...
5  216.9709 195.2199 36.27000 POLYGON ((560174.1 4533429,...
6  227.8761 184.6362 31.21000 POLYGON ((560187.3 4533429,...
7  226.0991 179.2143 31.99250 POLYGON ((560200.5 4533430,...
8  225.3973 179.0916 31.56500 POLYGON ((560213.7 4533430,...
9  221.1820 178.9585 33.01000 POLYGON ((560227 4533430, 5...
10 219.4659 179.0057 41.89750 POLYGON ((560240.2 4533430,...</code></pre>
<p>Here are the visualization of the subplot-level data (Figure <a href="demo.html#fig:Demo2-subplot-fig">1.7</a>):</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">(<span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> reg_data, <span class="kw">aes</span>(<span class="dt">fill =</span> yield), <span class="dt">color =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Yield&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-4" data-line-number="4"><span class="st">  </span>theme_for_map)<span class="op">/</span></a>
<a class="sourceLine" id="cb41-5" data-line-number="5">(<span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb41-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> reg_data, <span class="kw">aes</span>(<span class="dt">fill =</span> aa_NH3), <span class="dt">color =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;NH3&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-8" data-line-number="8"><span class="st">  </span>theme_for_map)<span class="op">/</span></a>
<a class="sourceLine" id="cb41-9" data-line-number="9">(<span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb41-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> reg_data, <span class="kw">aes</span>(<span class="dt">fill =</span> ec), <span class="dt">color =</span> <span class="ot">NA</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;EC&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;OrRd&quot;</span>, <span class="dt">direction =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb41-12" data-line-number="12"><span class="st">  </span>theme_for_map)</a></code></pre></div>
<div class="figure"><span id="fig:Demo2-subplot-fig"></span>
<img src="Demonstration_files/figure-html/Demo2-subplot-fig-1.png" alt="Spatial distribution of subplot-level yield, NH3, and EC" width="672" />
<p class="caption">
Figure 1.7: Spatial distribution of subplot-level yield, NH3, and EC
</p>
</div>
<hr />
<p>Let’s estimate the model and see the results:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="kw">lm</span>(yield <span class="op">~</span><span class="st"> </span>aa_NH3 <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(aa_NH3<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(aa_NH3<span class="op">*</span>ec) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(aa_NH3<span class="op">^</span><span class="dv">2</span><span class="op">*</span>ec), <span class="dt">data =</span> reg_data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="st">  </span><span class="kw">stargazer</span>(<span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</a></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
yield
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
aa_NH3
</td>
<td>
-1.223
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.308)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
I(aa_NH32)
</td>
<td>
0.004
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
I(aa_NH3 * ec)
</td>
<td>
0.002
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
I(aa_NH32 * ec)
</td>
<td>
-0.00001
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.00002)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
327.993<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(125.638)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
784
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.010
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.005
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
5.712 (df = 779)
</td>
</tr>
<tr>
<td style="text-align:left">
F Statistic
</td>
<td>
2.023<sup>*</sup> (df = 4; 779)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
</div>
</div>
<div id="demonstration-3-land-use-and-weather" class="section level2">
<h2><span class="header-section-number">1.3</span> Demonstration 3: Land Use and Weather</h2>
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview-2" class="section level3">
<h3><span class="header-section-number">1.3.1</span> Project Overview</h3>
<hr />
<p><strong>Objective</strong></p>
<p>Understand the impact of past precipitation on crop choice in Iowa (IA).</p>
<hr />
<p><strong>Datasets</strong></p>
<ul>
<li>IA county boundary</li>
<li>Regular grids over IA, created using <code>sf::st_make_grid()</code></li>
<li>PRISM daily precipitation data downloaded using <code>prism</code> package</li>
<li>Land use data from the Cropland Data Layer (CDL) for IA in 2015, downloaded using <code>cdlTools</code> package</li>
</ul>
<hr />
<p><strong>Econometric Model</strong></p>
<p>The econometric model we would like to estimate is:</p>
<p><span class="math display">\[
 CS_i = \alpha + \beta_1 PrN_{i} + \beta_2 PrC_{i} + v_i
\]</span>
where <span class="math inline">\(CS_i\)</span> is the area share of corn divided by that of soy in 2015 for grid <span class="math inline">\(i\)</span> (we will generate regularly-sized grids in the Demo section), <span class="math inline">\(PrN_i\)</span> is the total precipitation observed in April through May and September in 2014, <span class="math inline">\(PrC_i\)</span> is the total precipitation observed in June through August in 2014, and <span class="math inline">\(v_i\)</span> is the error term. To run the econometric model, we need to find crop share and weather variables observed at the grids. We first tackle the crop share variable, and then the precipitation variable.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>download Cropland Data Layer (CDL) data by USDA NASS
<ul>
<li>use <code>cdlTools::getCDL()</code></li>
</ul></li>
<li>download PRISM weather data
<ul>
<li>use <code>prism::get_prism_dailys()</code></li>
</ul></li>
<li>crop PRISM data to the geographic extent of IA
<ul>
<li>use <code>raster::crop()</code></li>
</ul></li>
<li>create regular grids within IA, which become the observation units of the econometric analysis
<ul>
<li>use <code>sf::st_make_grid()</code></li>
</ul></li>
<li>remove grids that share small area with IA
<ul>
<li>use <code>sf::st_intersection()</code> and <code>sf::st_area</code></li>
</ul></li>
<li>assign crop share and weather data to each of the generated IA grids (parallelized)
<ul>
<li>use <code>exactextractr::exact_extract()</code> and <code>future.apply::future_lapply()</code></li>
</ul></li>
<li>create maps
<ul>
<li>use <code>tmap</code> package</li>
</ul></li>
</ul>
<hr />
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Load (install first if you have not) the following packages (There are other packages that will be loaded during the demonstration).</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb43-5" data-line-number="5"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb43-6" data-line-number="6"><span class="kw">library</span>(tmap)</a>
<a class="sourceLine" id="cb43-7" data-line-number="7"><span class="kw">library</span>(future.apply)</a>
<a class="sourceLine" id="cb43-8" data-line-number="8"><span class="kw">library</span>(stargazer)</a></code></pre></div>
</div>
<div id="project-demonstration-2" class="section level3">
<h3><span class="header-section-number">1.3.2</span> Project Demonstration</h3>
<p>The geographic focus of this project is IA. Let’s get IAs state border (see Figure <a href="demo.html#fig:IA-map">1.8</a> for its map).</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;maps&quot;</span>)</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="co">#--- IA state boundary ---#</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4">IA_boundary &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="st">&quot;state&quot;</span>, <span class="st">&quot;iowa&quot;</span>, <span class="dt">plot =</span> <span class="ot">FALSE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>)) </a></code></pre></div>
<div class="figure"><span id="fig:IA-map"></span>
<img src="Demonstration_files/figure-html/IA-map-1.png" alt="IA state boundary" width="672" />
<p class="caption">
Figure 1.8: IA state boundary
</p>
</div>
<p>The unit of analysis is artificial grids that we create over IA. The grids are regularly-sized rectangles except around the edge of the IA state border<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>. So, let’s create grids and remove those that do not overlap much with IA.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="co">#--- create regular grids (40 cells by 40 columns) over IA ---#</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2">IA_grids &lt;-<span class="st"> </span>IA_boundary <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="st">  </span><span class="co">#--- create grids ---#</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="st">  </span><span class="kw">st_make_grid</span>(, <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">40</span>, <span class="dv">40</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="st">  </span><span class="co">#--- convert to sf ---#</span></a>
<a class="sourceLine" id="cb45-6" data-line-number="6"><span class="st">  </span><span class="kw">st_as_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-7" data-line-number="7"><span class="st">  </span><span class="co">#--- find the intersections of IA grids and IA polygon ---#</span></a>
<a class="sourceLine" id="cb45-8" data-line-number="8"><span class="st">  </span><span class="kw">st_intersection</span>(., IA_boundary) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-9" data-line-number="9"><span class="st">  </span><span class="co">#--- calculate the area of each grid ---#</span></a>
<a class="sourceLine" id="cb45-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb45-11" data-line-number="11">    <span class="dt">area =</span> <span class="kw">as.numeric</span>(<span class="kw">st_area</span>(.)),</a>
<a class="sourceLine" id="cb45-12" data-line-number="12">    <span class="dt">area_ratio =</span> area<span class="op">/</span><span class="kw">max</span>(area)</a>
<a class="sourceLine" id="cb45-13" data-line-number="13">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-14" data-line-number="14"><span class="st">  </span><span class="co">#--- keep only if the intersected area is large enough ---#</span></a>
<a class="sourceLine" id="cb45-15" data-line-number="15"><span class="st">  </span><span class="kw">filter</span>(area_ratio <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-16" data-line-number="16"><span class="st">  </span><span class="co">#--- assign grid id for future merge ---#</span></a>
<a class="sourceLine" id="cb45-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">grid_id =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.))</a></code></pre></div>
<p>Here is what the generated grids look like (Figure <a href="demo.html#fig:Demo4-IA-grids-map">1.9</a>):</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co">#--- plot the grids over the IA state border ---#</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="kw">tm_shape</span>(IA_boundary) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-4" data-line-number="4"><span class="kw">tm_shape</span>(IA_grids) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-6" data-line-number="6"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<div class="figure"><span id="fig:Demo4-IA-grids-map"></span>
<img src="Demonstration_files/figure-html/Demo4-IA-grids-map-1.png" alt="Map of regular grids generated over IA" width="672" />
<p class="caption">
Figure 1.9: Map of regular grids generated over IA
</p>
</div>
<hr />
<p>Let’s work on crop share data. You can download CDL data using the <code>getCDL()</code> function from the <code>cdlTools</code> package.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="co">#--- load the cdlTools package ---#</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="kw">library</span>(cdlTools)</a>
<a class="sourceLine" id="cb47-3" data-line-number="3"></a>
<a class="sourceLine" id="cb47-4" data-line-number="4"><span class="co">#--- download the CDL data for IA in 2015 ---#</span></a>
<a class="sourceLine" id="cb47-5" data-line-number="5">(</a>
<a class="sourceLine" id="cb47-6" data-line-number="6">IA_cdl_<span class="dv">2015</span> &lt;-<span class="st"> </span><span class="kw">getCDL</span>(<span class="st">&quot;Iowa&quot;</span>, <span class="dv">2015</span>)<span class="op">$</span>IA2015</a>
<a class="sourceLine" id="cb47-7" data-line-number="7">)</a></code></pre></div>
<pre><code>class      : RasterLayer 
dimensions : 11671, 17795, 207685445  (nrow, ncol, ncell)
resolution : 30, 30  (x, y)
extent     : -52095, 481755, 1938165, 2288295  (xmin, xmax, ymin, ymax)
crs        : +proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
source     : /private/var/folders/t4/5gnqprbn38nftyxkyk5hdwmd8hnypy/T/RtmpUSOffv/CDL_2015_19.tif 
names      : CDL_2015_19 
values     : 0, 255  (min, max)</code></pre>
<p>The cells (30 meter by 30 meter) of the imported raster layer take a value ranging from 0 to 255. Corn and soybean are represented by 1 and 5, respectively (visualization of the CDL data is on the right).</p>
<p>Figure <a href="demo.html#fig:overlap-cdl-grid">1.10</a> shows the map of one of the IA grids and the CDL cells it overlaps with.</p>
<div class="figure"><span id="fig:overlap-cdl-grid"></span>
<img src="Demonstration_files/figure-html/overlap-cdl-grid-1.png" alt="Spatial overlap of a IA grid and CDL layer" width="672" />
<p class="caption">
Figure 1.10: Spatial overlap of a IA grid and CDL layer
</p>
</div>
<p>We would like to extract all the cell values within the blue border.</p>
<p>We use <code>exactextractr::exact_extract()</code> to identify which cells of the CDL raster layer fall within each of the IA grids and extract land use type values. We then find the share of corn and soybean for each of the grids.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1"><span class="co">#--- reproject grids to the CRS of the CDL data ---#</span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2">IA_grids_rp_cdl &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(IA_cdl_<span class="dv">2015</span>))</a>
<a class="sourceLine" id="cb49-3" data-line-number="3"></a>
<a class="sourceLine" id="cb49-4" data-line-number="4"><span class="co">#--- load the exactextractr package for fast rater value extractions for polygons ---#</span></a>
<a class="sourceLine" id="cb49-5" data-line-number="5"><span class="kw">library</span>(exactextractr)</a>
<a class="sourceLine" id="cb49-6" data-line-number="6"></a>
<a class="sourceLine" id="cb49-7" data-line-number="7"><span class="co">#--- extract crop type values and find frequencies ---#</span></a>
<a class="sourceLine" id="cb49-8" data-line-number="8">cdl_extracted &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(IA_cdl_<span class="dv">2015</span>, IA_grids_rp_cdl) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-9" data-line-number="9"><span class="st">  </span><span class="kw">lapply</span>(., <span class="cf">function</span> (x) <span class="kw">data.table</span>(x)[,.N, <span class="dt">by =</span> value]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-10" data-line-number="10"><span class="st">  </span><span class="co">#--- combine the list of data.tables into one data.table ---#</span></a>
<a class="sourceLine" id="cb49-11" data-line-number="11"><span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-12" data-line-number="12"><span class="st">  </span><span class="co">#--- find the share of each land use type ---#</span></a>
<a class="sourceLine" id="cb49-13" data-line-number="13"><span class="st">  </span>.[, share <span class="op">:</span><span class="er">=</span><span class="st"> </span>N<span class="op">/</span><span class="kw">sum</span>(N), by =<span class="st"> </span>.id] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-14" data-line-number="14"><span class="st">  </span>.[, N <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-15" data-line-number="15"><span class="st">  </span><span class="co">#--- keep only the share of corn and soy ---#</span></a>
<a class="sourceLine" id="cb49-16" data-line-number="16"><span class="st">  </span>.[value <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), ]  </a></code></pre></div>
<p>We then find the corn to soy ratio for each of the IA grids.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="co">#--- find corn/soy ratio ---#</span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2">corn_soy &lt;-<span class="st"> </span>cdl_extracted <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="st">  </span><span class="co">#--- long to wide ---#</span></a>
<a class="sourceLine" id="cb50-4" data-line-number="4"><span class="st">  </span><span class="kw">dcast</span>(.id <span class="op">~</span><span class="st"> </span>value, <span class="dt">value.var =</span> <span class="st">&quot;share&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="st">  </span><span class="co">#--- change variable names ---#</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="st">  </span><span class="kw">setnames</span>(<span class="kw">c</span>(<span class="st">&quot;.id&quot;</span>, <span class="st">&quot;1&quot;</span>, <span class="st">&quot;5&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;grid_id&quot;</span>, <span class="st">&quot;corn_share&quot;</span>, <span class="st">&quot;soy_share&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="st">  </span><span class="co">#--- corn share divided by soy share ---#</span></a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="st">  </span>.[, c_s_ratio <span class="op">:</span><span class="er">=</span><span class="st"> </span>corn_share <span class="op">/</span><span class="st"> </span>soy_share]</a></code></pre></div>
<hr />
<p>We are still missing daily precipitation data at the moment. We have decided to use daily weather data from PRISM. Daily PRISM data is a raster data with the cell size of 4 km by 4 km. Figure <a href="demo.html#fig:Demo4-show-prism-data">1.11</a> the right presents precipitation data downloaded for April 1, 2010. It covers the entire contiguous U.S.</p>
<div class="figure"><span id="fig:Demo4-show-prism-data"></span>
<img src="Demonstration_files/figure-html/Demo4-show-prism-data-1.png" alt="Map of PRISM raster data layer" width="672" />
<p class="caption">
Figure 1.11: Map of PRISM raster data layer
</p>
</div>
<p>Let’s now download PRISM data<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>. This can be done using the <code>get_prism_dailys()</code> function from the <code>prism</code> package.<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a></p>
<!-- not to be seen -->
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="kw">options</span>(<span class="dt">prism.path =</span> <span class="st">&quot;./Data/PRISM&quot;</span>)</a>
<a class="sourceLine" id="cb51-2" data-line-number="2"></a>
<a class="sourceLine" id="cb51-3" data-line-number="3"><span class="kw">get_prism_dailys</span>(</a>
<a class="sourceLine" id="cb51-4" data-line-number="4">  <span class="dt">type =</span> <span class="st">&quot;ppt&quot;</span>, </a>
<a class="sourceLine" id="cb51-5" data-line-number="5">  <span class="dt">minDate =</span> <span class="st">&quot;2014-04-01&quot;</span>, </a>
<a class="sourceLine" id="cb51-6" data-line-number="6">  <span class="dt">maxDate =</span> <span class="st">&quot;2014-09-30&quot;</span>, </a>
<a class="sourceLine" id="cb51-7" data-line-number="7">  <span class="dt">keepZip =</span> <span class="ot">FALSE</span> </a>
<a class="sourceLine" id="cb51-8" data-line-number="8">)</a></code></pre></div>
<p>When we use <code>get_prism_dailys()</code> to download data<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a>, it creates one folder for each day. So, I have about 180 folders inside the folder I designated as the download destination above with the <code>options()</code> function.</p>
<!-- The name of the folder is expressive about what the data inside it is about. For example, the precipitation data for April 1st, 2010 is stored in the folder called "PRISM_ppt_stable_4kmD2_20100401_bil." Inside it, you will see bunch of files with exactly the same prefix, but with different extensions.   -->
<hr />
<p>We now try to extract precipitation value by day for each of the IA grids by geographically overlaying IA grids onto the PRISM data layer and identify which PRISM cells each of the IA grid encompass. Figure <a href="demo.html#fig:Demo4-prism-crop">1.12</a> shows how the first IA grid overlaps with the PRISM cells<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a>.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="co">#--- read a PRISM dataset ---#</span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2">prism_whole &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil&quot;</span>) </a>
<a class="sourceLine" id="cb52-3" data-line-number="3"></a>
<a class="sourceLine" id="cb52-4" data-line-number="4"><span class="co">#--- align the CRS ---#</span></a>
<a class="sourceLine" id="cb52-5" data-line-number="5">IA_grids_rp_prism &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(prism_whole))</a>
<a class="sourceLine" id="cb52-6" data-line-number="6"></a>
<a class="sourceLine" id="cb52-7" data-line-number="7"><span class="co">#--- crop the PRISM data for the 1st IA grid ---#</span></a>
<a class="sourceLine" id="cb52-8" data-line-number="8">PRISM_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">crop</span>(prism_whole, <span class="kw">st_buffer</span>(IA_grids_rp_prism[<span class="dv">1</span>, ], <span class="dt">dist =</span> <span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb52-9" data-line-number="9"></a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="co">#--- map them ---#</span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="kw">tm_shape</span>(PRISM_<span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-12" data-line-number="12"><span class="st">  </span><span class="kw">tm_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13"><span class="kw">tm_shape</span>(IA_grids_rp_prism[<span class="dv">1</span>, ]) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">NA</span>)</a></code></pre></div>
<div class="figure"><span id="fig:Demo4-prism-crop"></span>
<img src="Demonstration_files/figure-html/Demo4-prism-crop-1.png" alt="Spatial overlap of an IA grid over PRISM cells" width="672" />
<p class="caption">
Figure 1.12: Spatial overlap of an IA grid over PRISM cells
</p>
</div>
<p>As you can see, some PRISM grids are fully inside the analysis grid, while others are partially inside it. So, when assigning precipitation values to grids, we will use the coverage-weighted mean of precipitations<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a>.</p>
<p>Unlike the CDL layer, we have 183 raster layers to process. Fortunately, we can process many raster files at the same time very quickly by first “stacking” many raster files first and then applying the <code>exact_extract()</code> function. Using <code>future_lapply()</code>, we let <span class="math inline">\(6\)</span> cores take care of this task with each processing 31 files, except one of them handling only 28 files.<a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a>
We first get all the paths to the PRISM files.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="co">#--- get all the dates ---#</span></a>
<a class="sourceLine" id="cb53-2" data-line-number="2">dates_ls &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2014-04-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2014-09-30&quot;</span>), <span class="st">&quot;days&quot;</span>) </a>
<a class="sourceLine" id="cb53-3" data-line-number="3"></a>
<a class="sourceLine" id="cb53-4" data-line-number="4"><span class="co">#--- remove hyphen ---#</span></a>
<a class="sourceLine" id="cb53-5" data-line-number="5">dates_ls_no_hyphen &lt;-<span class="st"> </span><span class="kw">str_remove_all</span>(dates_ls, <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb53-6" data-line-number="6"></a>
<a class="sourceLine" id="cb53-7" data-line-number="7"><span class="co">#--- get all the prism file names ---#</span></a>
<a class="sourceLine" id="cb53-8" data-line-number="8">folder_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;PRISM_ppt_stable_4kmD2_&quot;</span>, dates_ls_no_hyphen, <span class="st">&quot;_bil&quot;</span>) </a>
<a class="sourceLine" id="cb53-9" data-line-number="9">file_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;PRISM_ppt_stable_4kmD2_&quot;</span>, dates_ls_no_hyphen, <span class="st">&quot;_bil.bil&quot;</span>) </a>
<a class="sourceLine" id="cb53-10" data-line-number="10">file_paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;./Data/PRISM/&quot;</span>, folder_name, <span class="st">&quot;/&quot;</span>, file_name)</a>
<a class="sourceLine" id="cb53-11" data-line-number="11"></a>
<a class="sourceLine" id="cb53-12" data-line-number="12"><span class="co">#--- take a look ---#</span></a>
<a class="sourceLine" id="cb53-13" data-line-number="13"><span class="kw">head</span>(file_paths)</a></code></pre></div>
<pre><code>[1] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil&quot;
[2] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140402_bil/PRISM_ppt_stable_4kmD2_20140402_bil.bil&quot;
[3] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140403_bil/PRISM_ppt_stable_4kmD2_20140403_bil.bil&quot;
[4] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140404_bil/PRISM_ppt_stable_4kmD2_20140404_bil.bil&quot;
[5] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140405_bil/PRISM_ppt_stable_4kmD2_20140405_bil.bil&quot;
[6] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140406_bil/PRISM_ppt_stable_4kmD2_20140406_bil.bil&quot;</code></pre>
<p>We now prepare for parallelized extractions and then implement them using <code>future_apply()</code>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="co">#--- define the number of cores to use ---#</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2">num_core &lt;-<span class="st"> </span><span class="dv">6</span></a>
<a class="sourceLine" id="cb55-3" data-line-number="3"></a>
<a class="sourceLine" id="cb55-4" data-line-number="4"><span class="co">#--- prepare some parameters for parallelization ---#</span></a>
<a class="sourceLine" id="cb55-5" data-line-number="5">file_len &lt;-<span class="st"> </span><span class="kw">length</span>(file_paths)</a>
<a class="sourceLine" id="cb55-6" data-line-number="6">files_per_core &lt;-<span class="st"> </span><span class="kw">ceiling</span>(file_len<span class="op">/</span>num_core)</a>
<a class="sourceLine" id="cb55-7" data-line-number="7"></a>
<a class="sourceLine" id="cb55-8" data-line-number="8"><span class="co">#--- prepare for parallel processing ---#</span></a>
<a class="sourceLine" id="cb55-9" data-line-number="9"><span class="kw">plan</span>(multiprocess, <span class="dt">workers =</span> num_core)</a>
<a class="sourceLine" id="cb55-10" data-line-number="10"></a>
<a class="sourceLine" id="cb55-11" data-line-number="11"><span class="co">#--- reproject IA grids to the CRS of PRISM data ---#</span></a>
<a class="sourceLine" id="cb55-12" data-line-number="12">IA_grids_reprojected &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(prism_whole))</a></code></pre></div>
<p>Here is the function that we run in parallel over 6 cores.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="co">#--- define the function to extract PRISM values by block of files ---#</span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2">extract_by_block &lt;-<span class="st"> </span><span class="cf">function</span>(i, files_per_core) {</a>
<a class="sourceLine" id="cb56-3" data-line-number="3"></a>
<a class="sourceLine" id="cb56-4" data-line-number="4">  <span class="co">#--- files processed by core  ---#</span></a>
<a class="sourceLine" id="cb56-5" data-line-number="5">  start_file_index &lt;-<span class="st"> </span>(i<span class="dv">-1</span>) <span class="op">*</span><span class="st"> </span>files_per_core <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb56-6" data-line-number="6"></a>
<a class="sourceLine" id="cb56-7" data-line-number="7">  <span class="co">#--- indexes for files to process ---#</span></a>
<a class="sourceLine" id="cb56-8" data-line-number="8">  file_index &lt;-<span class="st"> </span><span class="kw">seq</span>(</a>
<a class="sourceLine" id="cb56-9" data-line-number="9">    <span class="dt">from =</span> start_file_index,</a>
<a class="sourceLine" id="cb56-10" data-line-number="10">    <span class="dt">to =</span> <span class="kw">min</span>((start_file_index <span class="op">+</span><span class="st"> </span>files_per_core), file_len),</a>
<a class="sourceLine" id="cb56-11" data-line-number="11">    <span class="dt">by =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb56-12" data-line-number="12">  )</a>
<a class="sourceLine" id="cb56-13" data-line-number="13"></a>
<a class="sourceLine" id="cb56-14" data-line-number="14">  <span class="co">#--- extract values ---# </span></a>
<a class="sourceLine" id="cb56-15" data-line-number="15">  data_temp &lt;-<span class="st"> </span>file_paths[file_index] <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># get file names</span></a>
<a class="sourceLine" id="cb56-16" data-line-number="16"><span class="st">    </span><span class="co">#--- stack files ---#</span></a>
<a class="sourceLine" id="cb56-17" data-line-number="17"><span class="st">    </span><span class="kw">stack</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-18" data-line-number="18"><span class="st">    </span><span class="co">#--- extract ---#</span></a>
<a class="sourceLine" id="cb56-19" data-line-number="19"><span class="st">    </span><span class="kw">exact_extract</span>(., IA_grids_reprojected) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-20" data-line-number="20"><span class="st">    </span><span class="co">#--- combine into one data set ---#</span></a>
<a class="sourceLine" id="cb56-21" data-line-number="21"><span class="st">    </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;ID&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-22" data-line-number="22"><span class="st">    </span><span class="co">#--- wide to long ---#</span></a>
<a class="sourceLine" id="cb56-23" data-line-number="23"><span class="st">    </span><span class="kw">melt</span>(<span class="dt">id.var =</span> <span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;coverage_fraction&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-24" data-line-number="24"><span class="st">    </span><span class="co">#--- calculate &quot;area&quot;-weighted mean ---#</span></a>
<a class="sourceLine" id="cb56-25" data-line-number="25"><span class="st">    </span>.[, .(<span class="dt">value =</span> <span class="kw">sum</span>(value <span class="op">*</span><span class="st"> </span>coverage_fraction)<span class="op">/</span><span class="kw">sum</span>(coverage_fraction)), by =<span class="st"> </span>.(ID, variable)]</a>
<a class="sourceLine" id="cb56-26" data-line-number="26"></a>
<a class="sourceLine" id="cb56-27" data-line-number="27">  <span class="kw">return</span>(data_temp)</a>
<a class="sourceLine" id="cb56-28" data-line-number="28">}</a></code></pre></div>
<p>Now, let’s run the function in parallel and calculate precipitation by period.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="co">#--- run the function ---#</span></a>
<a class="sourceLine" id="cb57-2" data-line-number="2">precip_by_period &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(<span class="dv">1</span><span class="op">:</span>num_core, <span class="cf">function</span>(x) <span class="kw">extract_by_block</span>(x, files_per_core)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbindlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-3" data-line-number="3"><span class="st">  </span><span class="co">#--- recover the date ---#</span></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="st">  </span>.[, variable <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">str_extract</span>(variable, <span class="st">&quot;[0-9]{8}&quot;</span>), <span class="st">&quot;%Y%m%d&quot;</span>)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="st">  </span><span class="co">#--- change the variable name to date ---#</span></a>
<a class="sourceLine" id="cb57-6" data-line-number="6"><span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-7" data-line-number="7"><span class="st">  </span><span class="co">#--- define critical period ---#</span></a>
<a class="sourceLine" id="cb57-8" data-line-number="8"><span class="st">  </span>.[,critical <span class="op">:</span><span class="er">=</span><span class="st"> &quot;non_critical&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-9" data-line-number="9"><span class="st">  </span>.[<span class="kw">month</span>(date) <span class="op">%in%</span><span class="st"> </span><span class="dv">6</span><span class="op">:</span><span class="dv">8</span>, critical <span class="op">:</span><span class="er">=</span><span class="st"> &quot;critical&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-10" data-line-number="10"><span class="st">  </span><span class="co">#--- total precipitation by critical dummy  ---#</span></a>
<a class="sourceLine" id="cb57-11" data-line-number="11"><span class="st">  </span>.[, .(<span class="dt">precip=</span><span class="kw">sum</span>(value)), by =<span class="st"> </span>.(ID, critical)] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-12" data-line-number="12"><span class="st">  </span><span class="co">#--- wide to long ---#</span></a>
<a class="sourceLine" id="cb57-13" data-line-number="13"><span class="st">  </span><span class="kw">dcast</span>(ID <span class="op">~</span><span class="st"> </span>critical, <span class="dt">value.var =</span> <span class="st">&quot;precip&quot;</span>)</a></code></pre></div>
<p>We now have grid-level crop share and precipitation data.</p>
<hr />
<p>Let’s merge them and run regression.<a href="#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="co">#--- crop share ---#</span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2">reg_data &lt;-<span class="st"> </span>corn_soy[precip_by_period, on =<span class="st"> </span><span class="kw">c</span>(<span class="dt">grid_id =</span> <span class="st">&quot;ID&quot;</span>)]</a>
<a class="sourceLine" id="cb58-3" data-line-number="3"></a>
<a class="sourceLine" id="cb58-4" data-line-number="4"><span class="co">#--- OLS ---#</span></a>
<a class="sourceLine" id="cb58-5" data-line-number="5">reg_results &lt;-<span class="st"> </span><span class="kw">lm</span>(c_s_ratio <span class="op">~</span><span class="st"> </span>critical <span class="op">+</span><span class="st"> </span>non_critical, <span class="dt">data =</span> reg_data)</a></code></pre></div>
<p>Here is the regression results table.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1"><span class="co">#--- regression table ---#</span></a>
<a class="sourceLine" id="cb59-2" data-line-number="2"><span class="kw">stargazer</span>(reg_results, <span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</a></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
c_s_ratio
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
critical
</td>
<td>
-0.002<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
non_critical
</td>
<td>
-0.0003
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
2.701<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.161)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
1,218
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.058
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.056
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
0.743 (df = 1215)
</td>
</tr>
<tr>
<td style="text-align:left">
F Statistic
</td>
<td>
37.234<sup>***</sup> (df = 2; 1215)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
<p>Again, do not read into the results as the econometric model is terrible.</p>
</div>
</div>
<div id="demo4" class="section level2">
<h2><span class="header-section-number">1.4</span> Demonstration 4: The Impact of Railroad Presence on Corn Planted Acreage</h2>
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview-3" class="section level3">
<h3><span class="header-section-number">1.4.1</span> Project Overview</h3>
<hr />
<p><strong>Objective</strong></p>
<ul>
<li>Understand the impact of railroad on corn planted acreage in Illinois</li>
</ul>
<hr />
<p><strong>Datasets</strong></p>
<ul>
<li>USDA corn planted acreage for Illinois downloaded from the USDA NationalAgricultural Statistics Service (NASS) QuickStats service using <code>tidyUSDA</code> package</li>
<li>US railroads (line data) downloaded from <a href="https://catalog.data.gov/dataset/tiger-line-shapefile-2015-nation-u-s-rails-national-shapefile">here</a></li>
</ul>
<hr />
<p><strong>Econometric Model</strong></p>
<p>We will estimate the following model:</p>
<p><span class="math display">\[
  y_i = \beta_0 + \beta_1 RL_i + v_i
\]</span></p>
<p>where <span class="math inline">\(y_i\)</span> is corn planted acreage in county <span class="math inline">\(i\)</span> in Illinois, <span class="math inline">\(RL_i\)</span> is the total length of railroad, and <span class="math inline">\(v_i\)</span> is the error term.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>Download USDA corn planted acreage by county as a spatial dataset (<code>sf</code> object)
<ul>
<li>use <code>tidyUSDA::getQuickStat()</code></li>
</ul></li>
<li>Import US railroad shape file as a spatial dataset (<code>sf</code> object)
<ul>
<li>use <code>sf:st_read()</code></li>
</ul></li>
<li>Spatially subset (crop) the railroad data to the geographic boundary of Illinois
<ul>
<li>use <code>sf_1[sf_2, ]</code></li>
</ul></li>
<li>Find railroads for each county (cross-county railroad will be chopped into pieces for them to fit within a single county)
<ul>
<li>use <code>sf::st_intersection()</code><br />
</li>
</ul></li>
<li>Calculate the travel distance of each railroad piece
<ul>
<li>use <code>sf::st_length()</code></li>
</ul></li>
</ul>
<hr />
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Load (install first if you have not) the following packages (There are other packages that will be loaded during the demonstration).</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb60-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb60-4" data-line-number="4"><span class="kw">library</span>(stargazer)</a></code></pre></div>
</div>
<div id="project-demonstration-3" class="section level3">
<h3><span class="header-section-number">1.4.2</span> Project Demonstration</h3>
<p>We first download corn planted acreage data for 2018 from USDA NASS QuickStat service using <code>tidyUSDA</code> package<a href="#fn28" class="footnote-ref" id="fnref28"><sup>28</sup></a>.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1"><span class="kw">library</span>(keyring)</a>
<a class="sourceLine" id="cb61-2" data-line-number="2"><span class="kw">library</span>(tidyUSDA)</a>
<a class="sourceLine" id="cb61-3" data-line-number="3"></a>
<a class="sourceLine" id="cb61-4" data-line-number="4">(</a>
<a class="sourceLine" id="cb61-5" data-line-number="5">IL_corn_planted &lt;-<span class="st"> </span><span class="kw">getQuickstat</span>(</a>
<a class="sourceLine" id="cb61-6" data-line-number="6">    <span class="dt">key =</span> <span class="kw">key_get</span>(<span class="st">&quot;usda_nass_qs_api&quot;</span>) ,</a>
<a class="sourceLine" id="cb61-7" data-line-number="7">    <span class="dt">program =</span> <span class="st">&quot;SURVEY&quot;</span>,</a>
<a class="sourceLine" id="cb61-8" data-line-number="8">    <span class="dt">data_item =</span> <span class="st">&quot;CORN - ACRES PLANTED&quot;</span>,</a>
<a class="sourceLine" id="cb61-9" data-line-number="9">    <span class="dt">geographic_level =</span> <span class="st">&quot;COUNTY&quot;</span>,</a>
<a class="sourceLine" id="cb61-10" data-line-number="10">    <span class="dt">state =</span> <span class="st">&quot;ILLINOIS&quot;</span>,</a>
<a class="sourceLine" id="cb61-11" data-line-number="11">    <span class="dt">year =</span> <span class="st">&quot;2018&quot;</span>,</a>
<a class="sourceLine" id="cb61-12" data-line-number="12">    <span class="dt">geometry =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb61-13" data-line-number="13">  )  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-14" data-line-number="14"><span class="st">  </span><span class="co">#--- keep only some of the variables ---#</span></a>
<a class="sourceLine" id="cb61-15" data-line-number="15"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(year, NAME, county_code, short_desc, Value)</a>
<a class="sourceLine" id="cb61-16" data-line-number="16">)</a></code></pre></div>
<pre><code>Simple feature collection with 90 features and 5 fields (with 6 geometries empty)
geometry type:  MULTIPOLYGON
dimension:      XY
bbox:           xmin: -91.51308 ymin: 36.9703 xmax: -87.4952 ymax: 42.50848
CRS:            +proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs
First 10 features:
   year        NAME county_code           short_desc  Value
1  2018      Bureau         011 CORN - ACRES PLANTED 264000
2  2018     Carroll         015 CORN - ACRES PLANTED 134000
3  2018       Henry         073 CORN - ACRES PLANTED 226500
4  2018  Jo Daviess         085 CORN - ACRES PLANTED  98500
5  2018         Lee         103 CORN - ACRES PLANTED 236500
6  2018      Mercer         131 CORN - ACRES PLANTED 141000
7  2018        Ogle         141 CORN - ACRES PLANTED 217000
8  2018      Putnam         155 CORN - ACRES PLANTED  32300
9  2018 Rock Island         161 CORN - ACRES PLANTED  68400
10 2018  Stephenson         177 CORN - ACRES PLANTED 166500
                         geometry
1  MULTIPOLYGON (((-89.8569 41...
2  MULTIPOLYGON (((-90.16133 4...
3  MULTIPOLYGON (((-90.43227 4...
4  MULTIPOLYGON (((-90.50668 4...
5  MULTIPOLYGON (((-89.63118 4...
6  MULTIPOLYGON (((-90.99255 4...
7  MULTIPOLYGON (((-89.68598 4...
8  MULTIPOLYGON (((-89.33303 4...
9  MULTIPOLYGON (((-90.33573 4...
10 MULTIPOLYGON (((-89.9205 42...</code></pre>
<p>A nice thing about this function is that the data is downloaded as an <code>sf</code> object with county geometry with <code>geometry = TRUE</code>. So, you can immediately plot it (Figure <a href="demo.html#fig:map-il-corn-acreage">1.13</a>) and use it for later spatial interactions without having to merge the downloaded data to an independent county boundary data.<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1"><span class="kw">ggplot</span>(IL_corn_planted) <span class="op">+</span></a>
<a class="sourceLine" id="cb63-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> Value<span class="op">/</span><span class="dv">1000</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb63-3" data-line-number="3"><span class="st">  </span><span class="kw">scale_fill_distiller</span>(<span class="dt">name =</span> <span class="st">&quot;Planted Acreage (1000 acres)&quot;</span>, <span class="dt">palette =</span> <span class="st">&quot;YlOrRd&quot;</span>, <span class="dt">trans =</span> <span class="st">&quot;reverse&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb63-4" data-line-number="4"><span class="st">  </span><span class="kw">theme</span>(</a>
<a class="sourceLine" id="cb63-5" data-line-number="5">    <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span></a>
<a class="sourceLine" id="cb63-6" data-line-number="6">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb63-7" data-line-number="7"><span class="st">  </span>theme_for_map</a></code></pre></div>
<div class="figure"><span id="fig:map-il-corn-acreage"></span>
<img src="Demonstration_files/figure-html/map-il-corn-acreage-1.png" alt="Map of Con Planted Acreage in Illinois in 2018" width="672" />
<p class="caption">
Figure 1.13: Map of Con Planted Acreage in Illinois in 2018
</p>
</div>
<hr />
<p>Let’s import the U.S. railroad data and reproject to the CRS of <code>IL_corn_planted</code>:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">rail_roads &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&quot;./Data/&quot;</span>, <span class="dt">layer =</span> <span class="st">&quot;tl_2015_us_rails&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-2" data-line-number="2"><span class="st">  </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(IL_corn_planted))</a></code></pre></div>
<pre><code>Reading layer `tl_2015_us_rails&#39; from data source `/Users/tmieno2/Dropbox/TeachingUNL/RGIS_Econ/Data&#39; using driver `ESRI Shapefile&#39;
Simple feature collection with 180958 features and 3 fields
geometry type:  MULTILINESTRING
dimension:      XY
bbox:           xmin: -165.4011 ymin: 17.95174 xmax: -65.74931 ymax: 65.00006
CRS:            4269</code></pre>
<p>Here is what it looks like:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="kw">ggplot</span>(rail_roads) <span class="op">+</span></a>
<a class="sourceLine" id="cb66-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_sf</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb66-3" data-line-number="3"><span class="st">  </span>theme_for_map</a></code></pre></div>
<div class="figure"><span id="fig:Demo5-rail-plot"></span>
<img src="Demonstration_files/figure-html/Demo5-rail-plot-1.png" alt="Map of Railroads" width="672" />
<p class="caption">
Figure 1.14: Map of Railroads
</p>
</div>
<p>We now crop it to the Illinois state border (Figure <a href="demo.html#fig:Demo5-rail-IL-plot">1.15</a>) using <code>sf_1[sf_2, ]</code>:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1">rail_roads_IL &lt;-<span class="st"> </span>rail_roads[IL_corn_planted, ]</a></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb68-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> rail_roads_IL) <span class="op">+</span></a>
<a class="sourceLine" id="cb68-3" data-line-number="3"><span class="st">  </span>theme_for_map</a></code></pre></div>
<div class="figure"><span id="fig:Demo5-rail-IL-plot"></span>
<img src="Demonstration_files/figure-html/Demo5-rail-IL-plot-1.png" alt="Map of railroads in Illinois" width="672" />
<p class="caption">
Figure 1.15: Map of railroads in Illinois
</p>
</div>
<p>Let’s now find railroads for each county, where cross-county railroads will be chopped into pieces so each piece fits completely within a single county, using <code>st_intersection()</code>.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">rails_IL_segmented &lt;-<span class="st"> </span><span class="kw">st_intersection</span>(rail_roads_IL, IL_corn_planted) </a></code></pre></div>
<p>Here are the railroads for Richland County:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> dplyr<span class="op">::</span><span class="kw">filter</span>(IL_corn_planted, NAME <span class="op">==</span><span class="st"> &quot;Richland&quot;</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb70-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> dplyr<span class="op">::</span><span class="kw">filter</span>(rails_IL_segmented, NAME <span class="op">==</span><span class="st"> &quot;Richland&quot;</span>), <span class="kw">aes</span>( <span class="dt">color =</span> LINEARID )) <span class="op">+</span></a>
<a class="sourceLine" id="cb70-4" data-line-number="4"><span class="st">  </span><span class="kw">theme</span>(</a>
<a class="sourceLine" id="cb70-5" data-line-number="5">    <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span></a>
<a class="sourceLine" id="cb70-6" data-line-number="6">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb70-7" data-line-number="7"><span class="st">  </span>theme_for_map</a></code></pre></div>
<p><img src="Demonstration_files/figure-html/map_seg_rail-1.png" width="672" /></p>
<p>We now calculate the travel distance (Great-circle distance) of each railroad piece using <code>st_length()</code> and then sum them up by county to find total railroad length by county.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb71-2" data-line-number="2">rail_length_county &lt;-<span class="st"> </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb71-3" data-line-number="3">    rails_IL_segmented, </a>
<a class="sourceLine" id="cb71-4" data-line-number="4">    <span class="dt">length_in_m =</span> <span class="kw">as.numeric</span>(<span class="kw">st_length</span>(rails_IL_segmented)),</a>
<a class="sourceLine" id="cb71-5" data-line-number="5">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-6" data-line-number="6"><span class="st">  </span><span class="co">#--- group by county ID ---#</span></a>
<a class="sourceLine" id="cb71-7" data-line-number="7"><span class="st">  </span><span class="kw">group_by</span>(county_code) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-8" data-line-number="8"><span class="st">  </span><span class="co">#--- sum rail length by county ---#</span></a>
<a class="sourceLine" id="cb71-9" data-line-number="9"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">length_in_m =</span> <span class="kw">sum</span>(length_in_m)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb71-10" data-line-number="10"><span class="st">  </span><span class="co">#--- geometry no longer needed ---#</span></a>
<a class="sourceLine" id="cb71-11" data-line-number="11"><span class="st">  </span><span class="kw">st_drop_geometry</span>()</a>
<a class="sourceLine" id="cb71-12" data-line-number="12">)</a></code></pre></div>
<pre><code># A tibble: 82 x 2
   county_code length_in_m
 * &lt;chr&gt;             &lt;dbl&gt;
 1 001              77221.
 2 003              77290.
 3 007              36764.
 4 011             255441.
 5 015             161726.
 6 017              30585.
 7 019             389226.
 8 021             155794.
 9 023              78587.
10 025              92030.
# … with 72 more rows</code></pre>
<hr />
<p>We merge the railroad length data to the corn planted acreage data and estimate the model.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">reg_data &lt;-<span class="st"> </span><span class="kw">left_join</span>(IL_corn_planted, rail_length_county, <span class="dt">by =</span> <span class="st">&quot;county_code&quot;</span>) </a></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="kw">lm</span>(Value <span class="op">~</span><span class="st"> </span>length_in_m, <span class="dt">data =</span> reg_data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2"><span class="st">  </span><span class="kw">stargazer</span>(<span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</a></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
Value
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
length_in_m
</td>
<td>
0.092<sup>*</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.047)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
108,154.800<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(11,418.900)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
82
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.046
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.034
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
69,040.680 (df = 80)
</td>
</tr>
<tr>
<td style="text-align:left">
F Statistic
</td>
<td>
3.866<sup>*</sup> (df = 1; 80)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
</div>
</div>
<div id="demonstration-5-groundwater-use-for-agricultural-irrigation" class="section level2">
<h2><span class="header-section-number">1.5</span> Demonstration 5: Groundwater use for agricultural irrigation</h2>
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview-4" class="section level3">
<h3><span class="header-section-number">1.5.1</span> Project Overview</h3>
<hr />
<p><strong>Objective</strong>
+ Understand the impact of monthly precipitation on groundwater use for agricultural irrigation</p>
<hr />
<p><strong>Datasets</strong></p>
<ul>
<li>Annual groundwater pumping by irrigation wells in Kansas for 2010 and 2011 (originally obtained from the Water Information Management &amp; Analysis System (WIMAS) database)</li>
<li>Daymet<a href="#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a> daily precipitation and maximum temperature downloaded using <code>daymetr</code> package</li>
</ul>
<hr />
<p><strong>Econometric Model</strong></p>
<p>The econometric model we would like to estimate is:</p>
<p><span class="math display">\[
   y_{i,t}  = \alpha +  P_{i,t} \beta + T_{i,t} \gamma + \phi_i + \eta_t + v_{i,t}
\]</span></p>
<p>where <span class="math inline">\(y\)</span> is the total groundwater extracted in year <span class="math inline">\(t\)</span>, <span class="math inline">\(P_{i,t}\)</span> and <span class="math inline">\(T_{i,t}\)</span> is the collection of monthly total precipitation and mean maximum temperature April through September in year <span class="math inline">\(t\)</span>, respectively, <span class="math inline">\(\phi_i\)</span> is the well fixed effect, <span class="math inline">\(\eta_t\)</span> is the year fixed effect, and <span class="math inline">\(v_{i,t}\)</span> is the error term.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>download Daymet precipitation and maximum temperature data for each well from within R in parallel
<ul>
<li>use <code>daymetr::download_daymet()</code> and <code>future.apply::future_lapply()</code></li>
</ul></li>
</ul>
<hr />
</div>
<div id="project-demonstration-4" class="section level3">
<h3><span class="header-section-number">1.5.2</span> Project Demonstration</h3>
<p>We have already collected annual groundwater pumping data by irrigation wells in 2010 and 2011 in Kansas from the Water Information Management &amp; Analysis System (WIMAS) database. Let’s read in the groundwater use data.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="co">#--- read in the data ---#</span></a>
<a class="sourceLine" id="cb75-2" data-line-number="2">(</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">gw_KS_sf &lt;-<span class="st"> </span><span class="kw">readRDS</span>( <span class="st">&quot;./Data/gw_KS_sf.rds&quot;</span>) </a>
<a class="sourceLine" id="cb75-4" data-line-number="4">)</a></code></pre></div>
<pre><code>Simple feature collection with 56225 features and 3 fields
geometry type:  POINT
dimension:      XY
bbox:           xmin: -102.0495 ymin: 36.99561 xmax: -94.70746 ymax: 40.00191
CRS:            EPSG:4269
First 10 features:
   well_id year   af_used                   geometry
1        1 2010  67.00000 POINT (-100.4423 37.52046)
2        1 2011 171.00000 POINT (-100.4423 37.52046)
3        3 2010  30.93438 POINT (-100.7118 39.91526)
4        3 2011  12.00000 POINT (-100.7118 39.91526)
5        7 2010   0.00000 POINT (-101.8995 38.78077)
6        7 2011   0.00000 POINT (-101.8995 38.78077)
7       11 2010 154.00000 POINT (-101.7114 39.55035)
8       11 2011 160.00000 POINT (-101.7114 39.55035)
9       12 2010  28.17239 POINT (-95.97031 39.16121)
10      12 2011  89.53479 POINT (-95.97031 39.16121)</code></pre>
<p>We have 28553 wells in total, and each well has records of groundwater pumping (<code>af_used</code>) for years 2010 and 2011. Here is the spatial distribution of the wells.</p>
<p><img src="Demonstration_files/figure-html/Demo5_map-1.png" width="672" /></p>
<!-- 
#=========================================
# Daymet data download and processing 
#=========================================
-->
<hr />
<p>We now need to get monthly precipitation and maximum temperature data. We have decided that we use <a href="https://daymet.ornl.gov/">Daymet</a> weather data. Here we use the <code>download_daymet()</code> function from the <code>daymetr</code> package<a href="#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a> that allows us to download all the weather variables for a specified geographic location and time period<a href="#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a>. We write a wrapper function that downloads Daymet data and then processes it to find monthly total precipitation and mean maximum temperature<a href="#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a>. We then loop over the 56225 wells, which is parallelized using the <code>future_apply()</code> function<a href="#fn34" class="footnote-ref" id="fnref34"><sup>34</sup></a> from the <code>future.apply</code> package. This process takes about an hour on my Mac with parallelization on 7 cores. The data is available in the data repository for this course (named as “all_daymet.rds”).</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="kw">library</span>(daymetr)</a>
<a class="sourceLine" id="cb77-2" data-line-number="2"><span class="kw">library</span>(future.apply)</a>
<a class="sourceLine" id="cb77-3" data-line-number="3"></a>
<a class="sourceLine" id="cb77-4" data-line-number="4"><span class="co">#--- get the geographic coordinates of the wells ---#</span></a>
<a class="sourceLine" id="cb77-5" data-line-number="5">well_locations &lt;-<span class="st"> </span>gw_KS_sf <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-6" data-line-number="6"><span class="st">  </span><span class="kw">unique</span>(<span class="dt">by =</span> <span class="st">&quot;well_id&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-7" data-line-number="7"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(well_id) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-8" data-line-number="8"><span class="st">  </span><span class="kw">cbind</span>(., <span class="kw">st_coordinates</span>(.))</a>
<a class="sourceLine" id="cb77-9" data-line-number="9"></a>
<a class="sourceLine" id="cb77-10" data-line-number="10"><span class="co">#--- define a function that downloads Daymet data by well and process it ---#</span></a>
<a class="sourceLine" id="cb77-11" data-line-number="11">get_daymet &lt;-<span class="st"> </span><span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb77-12" data-line-number="12"></a>
<a class="sourceLine" id="cb77-13" data-line-number="13">  temp_site &lt;-<span class="st"> </span>well_locations[i, ]<span class="op">$</span>well_id</a>
<a class="sourceLine" id="cb77-14" data-line-number="14">  temp_long &lt;-<span class="st"> </span>well_locations[i, ]<span class="op">$</span>X</a>
<a class="sourceLine" id="cb77-15" data-line-number="15">  temp_lat &lt;-<span class="st"> </span>well_locations[i, ]<span class="op">$</span>Y</a>
<a class="sourceLine" id="cb77-16" data-line-number="16"></a>
<a class="sourceLine" id="cb77-17" data-line-number="17">  data_temp &lt;-<span class="st"> </span><span class="kw">download_daymet</span>(</a>
<a class="sourceLine" id="cb77-18" data-line-number="18">      <span class="dt">site =</span> temp_site,</a>
<a class="sourceLine" id="cb77-19" data-line-number="19">      <span class="dt">lat =</span> temp_lat,</a>
<a class="sourceLine" id="cb77-20" data-line-number="20">      <span class="dt">lon =</span> temp_long,</a>
<a class="sourceLine" id="cb77-21" data-line-number="21">      <span class="dt">start =</span> <span class="dv">2010</span>,</a>
<a class="sourceLine" id="cb77-22" data-line-number="22">      <span class="dt">end =</span> <span class="dv">2011</span>,</a>
<a class="sourceLine" id="cb77-23" data-line-number="23">      <span class="co">#--- if TRUE, tidy data is returned ---#</span></a>
<a class="sourceLine" id="cb77-24" data-line-number="24">      <span class="dt">simplify =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb77-25" data-line-number="25">      <span class="co">#--- if TRUE, the downloaded data can be assigned to an R object ---#</span></a>
<a class="sourceLine" id="cb77-26" data-line-number="26">      <span class="dt">internal =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb77-27" data-line-number="27">    ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-28" data-line-number="28"><span class="st">    </span><span class="kw">data.table</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-29" data-line-number="29"><span class="st">    </span><span class="co">#--- keep only precip and tmax ---#</span></a>
<a class="sourceLine" id="cb77-30" data-line-number="30"><span class="st">    </span>.[measurement <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prcp..mm.day.&quot;</span>, <span class="st">&quot;tmax..deg.c.&quot;</span>), ] <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb77-31" data-line-number="31"><span class="st">    </span><span class="co">#--- recover calender date from Julian day ---#</span></a>
<a class="sourceLine" id="cb77-32" data-line-number="32"><span class="st">    </span>.[, date <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">paste</span>(year, yday, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>), <span class="st">&quot;%Y-%j&quot;</span>)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-33" data-line-number="33"><span class="st">    </span><span class="co">#--- get month ---#</span></a>
<a class="sourceLine" id="cb77-34" data-line-number="34"><span class="st">    </span>.[, month <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">month</span>(date)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-35" data-line-number="35"><span class="st">    </span><span class="co">#--- keep only April through September ---#</span></a>
<a class="sourceLine" id="cb77-36" data-line-number="36"><span class="st">    </span>.[month <span class="op">%in%</span><span class="st"> </span><span class="dv">4</span><span class="op">:</span><span class="dv">9</span>,] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-37" data-line-number="37"><span class="st">    </span>.[, .(site, year, month, date, measurement, value)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-38" data-line-number="38"><span class="st">    </span><span class="co">#--- long to wide ---#</span></a>
<a class="sourceLine" id="cb77-39" data-line-number="39"><span class="st">    </span><span class="kw">dcast</span>(site <span class="op">+</span><span class="st"> </span>year <span class="op">+</span><span class="st"> </span>month <span class="op">+</span><span class="st"> </span>date<span class="op">~</span><span class="st"> </span>measurement, <span class="dt">value.var =</span> <span class="st">&quot;value&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-40" data-line-number="40"><span class="st">    </span><span class="co">#--- change variable names ---#</span></a>
<a class="sourceLine" id="cb77-41" data-line-number="41"><span class="st">    </span><span class="kw">setnames</span>(<span class="kw">c</span>(<span class="st">&quot;prcp..mm.day.&quot;</span>, <span class="st">&quot;tmax..deg.c.&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;prcp&quot;</span>, <span class="st">&quot;tmax&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-42" data-line-number="42"><span class="st">    </span><span class="co">#--- find the total precip and mean tmax by month-year ---#</span></a>
<a class="sourceLine" id="cb77-43" data-line-number="43"><span class="st">    </span>.[, .(<span class="dt">prcp =</span> <span class="kw">sum</span>(prcp), <span class="dt">tmax =</span> <span class="kw">mean</span>(tmax)) , by =<span class="st"> </span>.(month, year)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-44" data-line-number="44"><span class="st">    </span>.[, well_id <span class="op">:</span><span class="er">=</span><span class="st"> </span>temp_site]</a>
<a class="sourceLine" id="cb77-45" data-line-number="45"></a>
<a class="sourceLine" id="cb77-46" data-line-number="46">  <span class="kw">return</span>(data_temp)</a>
<a class="sourceLine" id="cb77-47" data-line-number="47">  <span class="kw">gc</span>()</a>
<a class="sourceLine" id="cb77-48" data-line-number="48">}</a></code></pre></div>
<p>Here is what one run (for the first well) of <code>get_daymet()</code> returns</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1"><span class="co">#--- one run ---#</span></a>
<a class="sourceLine" id="cb78-2" data-line-number="2">(</a>
<a class="sourceLine" id="cb78-3" data-line-number="3">returned_data &lt;-<span class="st"> </span><span class="kw">get_daymet</span>(<span class="dv">1</span>)[]</a>
<a class="sourceLine" id="cb78-4" data-line-number="4">)</a></code></pre></div>
<pre><code>    month year prcp     tmax well_id
 1:     4 2010   42 20.96667       1
 2:     5 2010   94 24.19355       1
 3:     6 2010   70 32.51667       1
 4:     7 2010   89 33.50000       1
 5:     8 2010   63 34.17742       1
 6:     9 2010   15 31.43333       1
 7:     4 2011   25 21.91667       1
 8:     5 2011   26 26.30645       1
 9:     6 2011   23 35.16667       1
10:     7 2011   35 38.62903       1
11:     8 2011   37 36.90323       1
12:     9 2011    9 28.66667       1</code></pre>
<p>We get the number of cores you can use by <code>RhpcBLASctl::get_num_procs()</code> and parallelize the loop over wells using <code>future_lapply()</code>.<a href="#fn35" class="footnote-ref" id="fnref35"><sup>35</sup></a></p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="co">#--- prepare parallelized process ---#</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2"><span class="kw">library</span>(RhpcBLASctl) </a>
<a class="sourceLine" id="cb80-3" data-line-number="3">num_core &lt;-<span class="st"> </span><span class="kw">get_num_procs</span>() <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb80-4" data-line-number="4"></a>
<a class="sourceLine" id="cb80-5" data-line-number="5"><span class="co">#--- run get_daymet with parallelization ---#</span></a>
<a class="sourceLine" id="cb80-6" data-line-number="6">(</a>
<a class="sourceLine" id="cb80-7" data-line-number="7">all_daymet &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(well_locations), get_daymet) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-8" data-line-number="8"><span class="st">  </span><span class="kw">rbindlist</span>() </a>
<a class="sourceLine" id="cb80-9" data-line-number="9">)</a></code></pre></div>
<pre><code>        month year prcp     tmax well_id
     1:     4 2010   42 20.96667       1
     2:     5 2010   94 24.19355       1
     3:     6 2010   70 32.51667       1
     4:     7 2010   89 33.50000       1
     5:     8 2010   63 34.17742       1
    ---                                 
336980:     5 2011   18 26.11290   78051
336981:     6 2011   25 34.61667   78051
336982:     7 2011    6 38.37097   78051
336983:     8 2011   39 36.66129   78051
336984:     9 2011   23 28.45000   78051</code></pre>
<hr />
<p>Before merging the Daymet data, we need to reshape the data into a wide format to get monthly precipitation and maximum temperature as columns.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="co">#--- long to wide ---#</span></a>
<a class="sourceLine" id="cb82-2" data-line-number="2">daymet_to_merge &lt;-<span class="st"> </span><span class="kw">dcast</span>(all_daymet, well_id <span class="op">+</span><span class="st"> </span>year <span class="op">~</span><span class="st"> </span>month, <span class="dt">value.var =</span> <span class="kw">c</span>(<span class="st">&quot;prcp&quot;</span>, <span class="st">&quot;tmax&quot;</span>))</a>
<a class="sourceLine" id="cb82-3" data-line-number="3"></a>
<a class="sourceLine" id="cb82-4" data-line-number="4"><span class="co">#--- take a look ---#</span></a>
<a class="sourceLine" id="cb82-5" data-line-number="5">daymet_to_merge</a></code></pre></div>
<pre><code>       well_id year prcp_4 prcp_5 prcp_6 prcp_7 prcp_8 prcp_9   tmax_4   tmax_5
    1:       1 2010     42     94     70     89     63     15 20.96667 24.19355
    2:       1 2011     25     26     23     35     37      9 21.91667 26.30645
    3:       3 2010     85     62    109    112     83     41 19.93333 21.64516
    4:       3 2011     80    104     44    124    118     14 18.40000 22.62903
    5:       7 2010     44     83     23     99    105     13 18.81667 22.14516
   ---                                                                         
56160:   78049 2011     27      6     38     37     34     36 22.81667 26.70968
56161:   78050 2010     35     48     68    111     56      9 21.38333 24.85484
56162:   78050 2011     26      7     44     38     34     35 22.76667 26.70968
56163:   78051 2010     30     62     48     29     76      3 21.05000 24.14516
56164:   78051 2011     33     18     25      6     39     23 21.90000 26.11290
         tmax_6   tmax_7   tmax_8   tmax_9
    1: 32.51667 33.50000 34.17742 31.43333
    2: 35.16667 38.62903 36.90323 28.66667
    3: 30.73333 32.80645 33.56452 28.93333
    4: 30.08333 35.08065 32.90323 25.81667
    5: 31.30000 33.12903 32.67742 30.16667
   ---                                    
56160: 35.01667 38.32258 36.54839 28.80000
56161: 33.16667 33.88710 34.40323 32.11667
56162: 34.91667 38.32258 36.54839 28.83333
56163: 32.90000 33.83871 34.38710 31.56667
56164: 34.61667 38.37097 36.66129 28.45000</code></pre>
<p>Now, let’s merge the weather data to the groundwater pumping dataset.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">(</a>
<a class="sourceLine" id="cb84-2" data-line-number="2">reg_data &lt;-<span class="st"> </span><span class="kw">data.table</span>(gw_KS_sf) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="st">  </span><span class="co">#--- keep only the relevant variables ---#</span></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="st">  </span>.[, .(well_id, year, af_used)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5"><span class="st">  </span><span class="co">#--- join ---#</span></a>
<a class="sourceLine" id="cb84-6" data-line-number="6"><span class="st">  </span>daymet_to_merge[., <span class="dt">on =</span> <span class="kw">c</span>(<span class="st">&quot;well_id&quot;</span>, <span class="st">&quot;year&quot;</span>)]</a>
<a class="sourceLine" id="cb84-7" data-line-number="7">)</a></code></pre></div>
<pre><code>       well_id year prcp_4 prcp_5 prcp_6 prcp_7 prcp_8 prcp_9   tmax_4   tmax_5
    1:       1 2010     42     94     70     89     63     15 20.96667 24.19355
    2:       1 2011     25     26     23     35     37      9 21.91667 26.30645
    3:       3 2010     85     62    109    112     83     41 19.93333 21.64516
    4:       3 2011     80    104     44    124    118     14 18.40000 22.62903
    5:       7 2010     44     83     23     99    105     13 18.81667 22.14516
   ---                                                                         
56221:   79348 2011     NA     NA     NA     NA     NA     NA       NA       NA
56222:   79349 2011     NA     NA     NA     NA     NA     NA       NA       NA
56223:   79367 2011     NA     NA     NA     NA     NA     NA       NA       NA
56224:   79372 2011     NA     NA     NA     NA     NA     NA       NA       NA
56225:   80930 2011     NA     NA     NA     NA     NA     NA       NA       NA
         tmax_6   tmax_7   tmax_8   tmax_9   af_used
    1: 32.51667 33.50000 34.17742 31.43333  67.00000
    2: 35.16667 38.62903 36.90323 28.66667 171.00000
    3: 30.73333 32.80645 33.56452 28.93333  30.93438
    4: 30.08333 35.08065 32.90323 25.81667  12.00000
    5: 31.30000 33.12903 32.67742 30.16667   0.00000
   ---                                              
56221:       NA       NA       NA       NA  76.00000
56222:       NA       NA       NA       NA 182.00000
56223:       NA       NA       NA       NA   0.00000
56224:       NA       NA       NA       NA 134.00000
56225:       NA       NA       NA       NA  23.69150</code></pre>
<hr />
<p>Let’s run regression and display the results.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1"><span class="co">#--- load lfe package ---#</span></a>
<a class="sourceLine" id="cb86-2" data-line-number="2"><span class="kw">library</span>(lfe)</a>
<a class="sourceLine" id="cb86-3" data-line-number="3"></a>
<a class="sourceLine" id="cb86-4" data-line-number="4"><span class="co">#--- run FE ---#</span></a>
<a class="sourceLine" id="cb86-5" data-line-number="5">reg_results &lt;-<span class="st"> </span><span class="kw">felm</span>(</a>
<a class="sourceLine" id="cb86-6" data-line-number="6">  af_used <span class="op">~</span><span class="st"> </span></a>
<a class="sourceLine" id="cb86-7" data-line-number="7"><span class="st">  </span>prcp_<span class="dv">4</span> <span class="op">+</span><span class="st"> </span>prcp_<span class="dv">5</span> <span class="op">+</span><span class="st"> </span>prcp_<span class="dv">6</span> <span class="op">+</span><span class="st"> </span>prcp_<span class="dv">7</span> <span class="op">+</span><span class="st"> </span>prcp_<span class="dv">8</span> <span class="op">+</span><span class="st"> </span>prcp_<span class="dv">9</span> <span class="op">+</span></a>
<a class="sourceLine" id="cb86-8" data-line-number="8"><span class="st">  </span>tmax_<span class="dv">4</span> <span class="op">+</span><span class="st"> </span>tmax_<span class="dv">5</span> <span class="op">+</span><span class="st"> </span>tmax_<span class="dv">6</span> <span class="op">+</span><span class="st"> </span>tmax_<span class="dv">7</span> <span class="op">+</span><span class="st"> </span>tmax_<span class="dv">8</span> <span class="op">+</span><span class="st"> </span>tmax_<span class="dv">9</span></a>
<a class="sourceLine" id="cb86-9" data-line-number="9">  <span class="op">|</span>well_id <span class="op">+</span><span class="st"> </span>year<span class="op">|</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>well_id,</a>
<a class="sourceLine" id="cb86-10" data-line-number="10">  <span class="dt">data =</span> reg_data</a>
<a class="sourceLine" id="cb86-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb86-12" data-line-number="12"></a>
<a class="sourceLine" id="cb86-13" data-line-number="13"><span class="co">#--- display regression results ---#</span></a>
<a class="sourceLine" id="cb86-14" data-line-number="14"><span class="kw">stargazer</span>(reg_results, <span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</a></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
af_used
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
prcp_4
</td>
<td>
-0.053<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.017)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
prcp_5
</td>
<td>
0.112<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.010)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
prcp_6
</td>
<td>
-0.073<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.008)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
prcp_7
</td>
<td>
0.014
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.010)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
prcp_8
</td>
<td>
0.093<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.014)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
prcp_9
</td>
<td>
-0.177<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.025)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
tmax_4
</td>
<td>
9.159<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.227)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
tmax_5
</td>
<td>
-7.505<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.062)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
tmax_6
</td>
<td>
15.134<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.360)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
tmax_7
</td>
<td>
3.969<sup>**</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.618)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
tmax_8
</td>
<td>
3.420<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.066)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
tmax_9
</td>
<td>
-11.803<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1.801)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
55,754
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.942
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.883
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
46.864 (df = 27659)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
<p>That’s it. Do not bother to try to read into the regression results. Again, this is just an illustration of how R can be used to prepare a regression-ready dataset with spatial variables.</p>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="9">
<li id="fn9"><p>Note that this lecture does not deal with spatial econometrics at all. This lecture is about spatial data processing, not spatial econometrics. <a href="http://www.econ.uiuc.edu/~lab/workshop/Spatial_in_R.html">This</a> is a great resource for spatial econometrics in R.<a href="demo.html#fnref9" class="footnote-back">↩</a></p></li>
<li id="fn10"><p>I welcome any suggestions to improve the reading experience of unexperienced R users.<a href="demo.html#fnref10" class="footnote-back">↩</a></p></li>
<li id="fn11"><p>I thought about using the <code>here</code> package, but I found it a bit confusing for unexperienced R users.<a href="demo.html#fnref11" class="footnote-back">↩</a></p></li>
<li id="fn12"><p>the distance from the surface to the top of the aquifer<a href="demo.html#fnref12" class="footnote-back">↩</a></p></li>
<li id="fn13"><p>For our geographic focus of southwest Nebraska, corn is the dominant crop type. Irrigation for corn happens typically between April through September. For example, this means that changes in groundwater level (<span class="math inline">\(y_{i,2012} - y_{i,2011}\)</span>) captures the impact of groundwater pumping that occurred April through September in 2011.<a href="demo.html#fnref13" class="footnote-back">↩</a></p></li>
<li id="fn14"><p><code>month()</code> and <code>year()</code> are from the <code>lubridate</code> package. They extract month and year from a <code>Date</code> object.<a href="demo.html#fnref14" class="footnote-back">↩</a></p></li>
<li id="fn15"><p>This can alternatively be done using the <code>st_is_within_distance()</code> function.<a href="demo.html#fnref15" class="footnote-back">↩</a></p></li>
<li id="fn16"><p><code>theme_for_map</code> is a user defined object that defines the theme of figures generated using <code>ggplot2</code> for this section. You can find it in <strong>Chap_1_Demonstration.R</strong>.<a href="demo.html#fnref16" class="footnote-back">↩</a></p></li>
<li id="fn17"><p>Here we are demonstrating that R can read spatial data in different formats. R can read spatial data of many other formats. Here, we are reading a shapefile (.shp) and GeoPackage file (.gpkg).<a href="demo.html#fnref17" class="footnote-back">↩</a></p></li>
<li id="fn18"><p>Here is its <a href="https://github.com/thomasp85/patchwork">github page</a>. See the bottom of the page to find vignettes.<a href="demo.html#fnref18" class="footnote-back">↩</a></p></li>
<li id="fn19"><p><code>gen_subplots</code> is a user-defined function. See <strong>Chap_1_Demonstration.R</strong>.<a href="demo.html#fnref19" class="footnote-back">↩</a></p></li>
<li id="fn20"><p>We by no means are saying that this is the right geographical unit of analysis. This is just about demonstrating how R can be used for analysis done at the higher spatial resolution than county.<a href="demo.html#fnref20" class="footnote-back">↩</a></p></li>
<li id="fn21"><p>You do not have to run this code to download the data. It is included in the data folder for replication (<a href="https://www.dropbox.com/sh/cyx9clgmshwc8eo/AAApv03Qpx84IGKCyF5v2rJ6a?dl=0">here</a>).<a href="demo.html#fnref21" class="footnote-back">↩</a></p></li>
<li id="fn22"><p><a href="https://github.com/ropensci/prism">prism github page</a><a href="demo.html#fnref22" class="footnote-back">↩</a></p></li>
<li id="fn23"><p>For this project, I could have just used monthly PRISM data, which can be downloaded using the <code>get_prism_monthlys()</code> function. But, in many applications, daily data is necessary, so I wanted to illustrate how to download and process them.<a href="demo.html#fnref23" class="footnote-back">↩</a></p></li>
<li id="fn24"><p>Do not use <code>st_buffer()</code> for spatial objects in geographic coordinates (latitude, longitude) if you intend to use the created buffers for any serious IA (it is difficult to get the right distance parameter anyway.). Significant distortion will be introduced to the buffer due to the fact that one degree in latitude and longitude means different distances at the latitude of IA. Here, I am just creating a buffer to extract PRISM cells to display on the map.<a href="demo.html#fnref24" class="footnote-back">↩</a></p></li>
<li id="fn25"><p>In practice, this may not be advisable. The coverage fraction calculation by <code>exact_extract()</code> is done using latitude and longitude. Therefore, the relative magnitude of the fraction numbers incorrectly reflects the actual relative magnitude of the overlapped area. When the spatial resolution of the sources grids (grids from which you extract values) is much smaller relative to that of the target grids (grids to which you assign values to), then a simple average would be very similar to a coverage-weighted mean. For example, CDL consists of 30m by 30m grids, and more than <span class="math inline">\(1,000\)</span> grids are inside one analysis grid.<a href="demo.html#fnref25" class="footnote-back">↩</a></p></li>
<li id="fn26"><p>Parallelization of extracting values from many raster layers for polygons are discussed in much more detail in Chapter <a href="#Efficient"><strong>??</strong></a>. When I tried stacking all 183 files into one stack and applying <code>exact_extract</code>, it did not finish the job after over five minutes. So, I terminated the process in the middle. The parallelized version gets the job done in about <span class="math inline">\(30\)</span> seconds on my desktop.<a href="demo.html#fnref26" class="footnote-back">↩</a></p></li>
<li id="fn27"><p>We can match on <code>grid_id</code> from <code>corn_soy</code> and <code>ID</code> from “precip_by_period” because <code>grid_id</code> is identical with the row number and ID variables were created so that the ID value of <span class="math inline">\(i\)</span> corresponds to <span class="math inline">\(i\)</span> th row of <code>IA_grids</code>.<a href="demo.html#fnref27" class="footnote-back">↩</a></p></li>
<li id="fn28"><p>In order to actually download the data, you need to obtain the API key <a href="https://quickstats.nass.usda.gov/api">here</a>. Once the API key was obtained, I stored it using <code>set_key()</code> from the <code>keyring</code> package, which was named “usda_nass_qs_api”. In the code to the left, I retrieve the API key using <code>key_get(&quot;usda_nass_qs_api&quot;)</code> in the code.<a href="demo.html#fnref28" class="footnote-back">↩</a></p></li>
<li id="fn29"><p><code>theme_for_map</code> is a user defined object that defines the theme of figures generated using <code>ggplot2</code> for this section. You can find it in <strong>Chap_1_Demonstration.R</strong>.<a href="demo.html#fnref29" class="footnote-back">↩</a></p></li>
<li id="fn30"><p><a href="https://daymet.ornl.gov/">Daymet website</a><a href="demo.html#fnref30" class="footnote-back">↩</a></p></li>
<li id="fn31"><p><a href="https://cran.r-project.org/web/packages/daymetr/vignettes/daymetr-vignette.html">daymetr vignette</a><a href="demo.html#fnref31" class="footnote-back">↩</a></p></li>
<li id="fn32"><p>See <a href="">here</a> for a fuller explanation of how to use the <code>daymetr</code> package.<a href="demo.html#fnref32" class="footnote-back">↩</a></p></li>
<li id="fn33"><p>This may not be ideal for a real research project because the original raw data is not kept. It is often the case that your econometric plan changes on the course of your project (e.g., using other weather variables or using different temporal aggregation of weather variables instead of monthly aggregation). When this happens, you need to download the same data all over again.<a href="demo.html#fnref33" class="footnote-back">↩</a></p></li>
<li id="fn34"><p>For parallelized computation, see Chapter <a href="#prallel"><strong>??</strong></a><a href="demo.html#fnref34" class="footnote-back">↩</a></p></li>
<li id="fn35"><p>For Mac users, <code>mclapply</code> or <code>pbmclapply</code> (<code>mclapply</code> with progress bar) are good alternatives.<a href="demo.html#fnref35" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="preface.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="vector-basics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
