<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>1.3 Demonstration 3: Land Use and Weather | R as GIS for Economists</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="1.3 Demonstration 3: Land Use and Weather | R as GIS for Economists" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="1.3 Demonstration 3: Land Use and Weather | R as GIS for Economists" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Taro Mieno" />


<meta name="date" content="2020-05-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="demonstration-2-precision-agriculture.html"/>
<link rel="next" href="demo4.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R as GIS for Economists</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html"><i class="fa fa-check"></i>Why R as GIS for Economists?</a><ul>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#r-vs-python"><i class="fa fa-check"></i>R vs Python</a></li>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#r-vs-arcgis-or-qgis"><i class="fa fa-check"></i>R vs ArcGIS or QGIS</a></li>
<li class="chapter" data-level="" data-path="why-r-as-gis-for-economists.html"><a href="why-r-as-gis-for-economists.html#summary"><i class="fa fa-check"></i>Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="how-is-this-book-different-from-other-online-books-and-resources.html"><a href="how-is-this-book-different-from-other-online-books-and-resources.html"><i class="fa fa-check"></i>How is this book different from other online books and resources?</a></li>
<li class="chapter" data-level="" data-path="what-is-going-to-be-covered-in-this-book.html"><a href="what-is-going-to-be-covered-in-this-book.html"><i class="fa fa-check"></i>What is going to be covered in this book?</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html"><i class="fa fa-check"></i>Conventions of the book and some notes</a><ul>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#texts-in-gray-boxes"><i class="fa fa-check"></i>Texts in gray boxes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#colored-boxes"><i class="fa fa-check"></i>Colored Boxes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#parentheses-around-codes"><i class="fa fa-check"></i>Parentheses around codes</a></li>
<li class="chapter" data-level="" data-path="conventions-of-the-book-and-some-notes.html"><a href="conventions-of-the-book-and-some-notes.html#footnotes"><i class="fa fa-check"></i>Footnotes</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="session-information.html"><a href="session-information.html"><i class="fa fa-check"></i>Session Information</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="demo.html"><a href="demo.html"><i class="fa fa-check"></i><b>1</b> R as GIS: Demonstrations</a><ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1.1" data-path="Demo1.html"><a href="Demo1.html"><i class="fa fa-check"></i><b>1.1</b> Demonstration 1: The impact of groundwater pumping on depth to water table</a><ul>
<li class="chapter" data-level="1.1.1" data-path="Demo1.html"><a href="Demo1.html#project-overview"><i class="fa fa-check"></i><b>1.1.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.1.2" data-path="Demo1.html"><a href="Demo1.html#project-demonstration"><i class="fa fa-check"></i><b>1.1.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="demonstration-2-precision-agriculture.html"><a href="demonstration-2-precision-agriculture.html"><i class="fa fa-check"></i><b>1.2</b> Demonstration 2: Precision Agriculture</a><ul>
<li class="chapter" data-level="1.2.1" data-path="demonstration-2-precision-agriculture.html"><a href="demonstration-2-precision-agriculture.html#project-overview-1"><i class="fa fa-check"></i><b>1.2.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.2.2" data-path="demonstration-2-precision-agriculture.html"><a href="demonstration-2-precision-agriculture.html#project-demonstration-1"><i class="fa fa-check"></i><b>1.2.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="demonstration-3-land-use-and-weather.html"><a href="demonstration-3-land-use-and-weather.html"><i class="fa fa-check"></i><b>1.3</b> Demonstration 3: Land Use and Weather</a><ul>
<li class="chapter" data-level="1.3.1" data-path="demonstration-3-land-use-and-weather.html"><a href="demonstration-3-land-use-and-weather.html#project-overview-2"><i class="fa fa-check"></i><b>1.3.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.3.2" data-path="demonstration-3-land-use-and-weather.html"><a href="demonstration-3-land-use-and-weather.html#project-demonstration-2"><i class="fa fa-check"></i><b>1.3.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="demo4.html"><a href="demo4.html"><i class="fa fa-check"></i><b>1.4</b> Demonstration 4: The Impact of Railroad Presence on Corn Planted Acreage</a><ul>
<li class="chapter" data-level="1.4.1" data-path="demo4.html"><a href="demo4.html#project-overview-3"><i class="fa fa-check"></i><b>1.4.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.4.2" data-path="demo4.html"><a href="demo4.html#project-demonstration-3"><i class="fa fa-check"></i><b>1.4.2</b> Project Demonstration</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><a href="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><i class="fa fa-check"></i><b>1.5</b> Demonstration 5: Groundwater use for agricultural irrigation</a><ul>
<li class="chapter" data-level="1.5.1" data-path="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><a href="demonstration-5-groundwater-use-for-agricultural-irrigation.html#project-overview-4"><i class="fa fa-check"></i><b>1.5.1</b> Project Overview</a></li>
<li class="chapter" data-level="1.5.2" data-path="demonstration-5-groundwater-use-for-agricultural-irrigation.html"><a href="demonstration-5-groundwater-use-for-agricultural-irrigation.html#project-demonstration-4"><i class="fa fa-check"></i><b>1.5.2</b> Project Demonstration</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="vector-basics.html"><a href="vector-basics.html"><i class="fa fa-check"></i><b>2</b> Handle vector data using the sf package</a><ul>
<li class="chapter" data-level="" data-path="introduction-1.html"><a href="introduction-1.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="2.1" data-path="spatial-data-structure.html"><a href="spatial-data-structure.html"><i class="fa fa-check"></i><b>2.1</b> Spatial Data Structure</a></li>
<li class="chapter" data-level="2.2" data-path="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><a href="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><i class="fa fa-check"></i><b>2.2</b> Simple feature geometry, simple feature geometry list-column, and simple feature</a><ul>
<li class="chapter" data-level="2.2.1" data-path="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><a href="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html#simple-feature-geometry-sfg"><i class="fa fa-check"></i><b>2.2.1</b> Simple feature geometry (<code>sfg</code>)</a></li>
<li class="chapter" data-level="2.2.2" data-path="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html"><a href="simple-feature-geometry-simple-feature-geometry-list-column-and-simple-feature.html#create-simple-feature-geometry-list-column-sfc-and-simple-feature-sf-from-scratch"><i class="fa fa-check"></i><b>2.2.2</b> Create simple feature geometry list-column (<code>sfc</code>) and simple feature (<code>sf</code>) from scratch</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html"><i class="fa fa-check"></i><b>2.3</b> Reading and writing vector data</a><ul>
<li class="chapter" data-level="2.3.1" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html#reading-a-shapefile"><i class="fa fa-check"></i><b>2.3.1</b> Reading a shapefile</a></li>
<li class="chapter" data-level="2.3.2" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html#writing-to-a-shapefile"><i class="fa fa-check"></i><b>2.3.2</b> Writing to a shapefile</a></li>
<li class="chapter" data-level="2.3.3" data-path="reading-and-writing-vector-data.html"><a href="reading-and-writing-vector-data.html#better-alternatives"><i class="fa fa-check"></i><b>2.3.3</b> Better alternatives</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="projection-with-a-different-coordinate-reference-systems.html"><a href="projection-with-a-different-coordinate-reference-systems.html"><i class="fa fa-check"></i><b>2.4</b> Projection with a different Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.5" data-path="non-spatial-transformation-of-sf.html"><a href="non-spatial-transformation-of-sf.html"><i class="fa fa-check"></i><b>2.5</b> Non-spatial transformation of sf</a></li>
<li class="chapter" data-level="2.6" data-path="turning-a-data-frame-of-points-into-an-sf.html"><a href="turning-a-data-frame-of-points-into-an-sf.html"><i class="fa fa-check"></i><b>2.6</b> Turning a data.frame of points into an <code>sf</code></a></li>
<li class="chapter" data-level="2.7" data-path="conversion-to-and-from-sp.html"><a href="conversion-to-and-from-sp.html"><i class="fa fa-check"></i><b>2.7</b> Conversion to and from sp</a></li>
<li class="chapter" data-level="2.8" data-path="geometrical-operations.html"><a href="geometrical-operations.html"><i class="fa fa-check"></i><b>2.8</b> Geometrical operations</a><ul>
<li class="chapter" data-level="2.8.1" data-path="geometrical-operations.html"><a href="geometrical-operations.html#st_buffer"><i class="fa fa-check"></i><b>2.8.1</b> st_buffer</a></li>
<li class="chapter" data-level="2.8.2" data-path="geometrical-operations.html"><a href="geometrical-operations.html#st_area"><i class="fa fa-check"></i><b>2.8.2</b> st_area</a></li>
<li class="chapter" data-level="2.8.3" data-path="geometrical-operations.html"><a href="geometrical-operations.html#st_centroid"><i class="fa fa-check"></i><b>2.8.3</b> st_centroid</a></li>
<li class="chapter" data-level="2.8.4" data-path="geometrical-operations.html"><a href="geometrical-operations.html#st_length"><i class="fa fa-check"></i><b>2.8.4</b> st_length</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatial-interactions-of-vector-data-subsetting-and-joining.html"><a href="spatial-interactions-of-vector-data-subsetting-and-joining.html"><i class="fa fa-check"></i><b>3</b> Spatial Interactions of Vector Data: Subsetting and Joining</a><ul>
<li class="chapter" data-level="3.1" data-path="topological-relations.html"><a href="topological-relations.html"><i class="fa fa-check"></i><b>3.1</b> Topological relations</a><ul>
<li class="chapter" data-level="3.1.1" data-path="topological-relations.html"><a href="topological-relations.html#st_intersects"><i class="fa fa-check"></i><b>3.1.1</b> st_intersects()</a></li>
<li class="chapter" data-level="3.1.2" data-path="topological-relations.html"><a href="topological-relations.html#st_intersection"><i class="fa fa-check"></i><b>3.1.2</b> st_intersection()</a></li>
<li class="chapter" data-level="3.1.3" data-path="topological-relations.html"><a href="topological-relations.html#st_is_within_distance"><i class="fa fa-check"></i><b>3.1.3</b> st_is_within_distance()</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html"><i class="fa fa-check"></i><b>3.2</b> Spatial Subsetting (or Flagging)</a><ul>
<li class="chapter" data-level="3.2.1" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#polygons-vs-polygons"><i class="fa fa-check"></i><b>3.2.1</b> polygons vs polygons</a></li>
<li class="chapter" data-level="3.2.2" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#points-vs-polygons"><i class="fa fa-check"></i><b>3.2.2</b> points vs polygons</a></li>
<li class="chapter" data-level="3.2.3" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#lines-vs-polygons"><i class="fa fa-check"></i><b>3.2.3</b> lines vs polygons</a></li>
<li class="chapter" data-level="3.2.4" data-path="spatial-subsetting-or-flagging.html"><a href="spatial-subsetting-or-flagging.html#flagging-instead-of-subsetting"><i class="fa fa-check"></i><b>3.2.4</b> Flagging instead of subsetting</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="spatial-join.html"><a href="spatial-join.html"><i class="fa fa-check"></i><b>3.3</b> Spatial Join</a><ul>
<li class="chapter" data-level="3.3.1" data-path="spatial-join.html"><a href="spatial-join.html#case-1-points-target-vs-polygons-source"><i class="fa fa-check"></i><b>3.3.1</b> Case 1: points (target) vs polygons (source)</a></li>
<li class="chapter" data-level="3.3.2" data-path="spatial-join.html"><a href="spatial-join.html#case-2-polygons-target-vs-points-source"><i class="fa fa-check"></i><b>3.3.2</b> Case 2: polygons (target) vs points (source)</a></li>
<li class="chapter" data-level="3.3.3" data-path="spatial-join.html"><a href="spatial-join.html#polygon-polygon"><i class="fa fa-check"></i><b>3.3.3</b> Case 3: polygons (target) vs polygons (source)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R as GIS for Economists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<link href="style.css" rel="stylesheet" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-59758608-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-59758608-3');
</script>
<div id="demonstration-3-land-use-and-weather" class="section level2">
<h2><span class="header-section-number">1.3</span> Demonstration 3: Land Use and Weather</h2>
<style>
.book .book-body .page-wrapper .page-inner section.normal table
{
  width:auto;
}
.book .book-body .page-wrapper .page-inner section.normal table td,
.book .book-body .page-wrapper .page-inner section.normal table th,
.book .book-body .page-wrapper .page-inner section.normal table tr
{
  padding:0;
  border:0;
  background-color:#fff;
}
</style>
<div id="project-overview-2" class="section level3">
<h3><span class="header-section-number">1.3.1</span> Project Overview</h3>
<hr />
<p><strong>Objective</strong></p>
<p>Understand the impact of past precipitation on crop choice in Iowa (IA).</p>
<hr />
<p><strong>Datasets</strong></p>
<ul>
<li>IA county boundary</li>
<li>Regular grids over IA, created using <code>sf::st_make_grid()</code></li>
<li>PRISM daily precipitation data downloaded using <code>prism</code> package</li>
<li>Land use data from the Cropland Data Layer (CDL) for IA in 2015, downloaded using <code>cdlTools</code> package</li>
</ul>
<hr />
<p><strong>Econometric Model</strong></p>
<p>The econometric model we would like to estimate is:</p>
<p><span class="math display">\[
 CS_i = \alpha + \beta_1 PrN_{i} + \beta_2 PrC_{i} + v_i
\]</span>
where <span class="math inline">\(CS_i\)</span> is the area share of corn divided by that of soy in 2015 for grid <span class="math inline">\(i\)</span> (we will generate regularly-sized grids in the Demo section), <span class="math inline">\(PrN_i\)</span> is the total precipitation observed in April through May and September in 2014, <span class="math inline">\(PrC_i\)</span> is the total precipitation observed in June through August in 2014, and <span class="math inline">\(v_i\)</span> is the error term. To run the econometric model, we need to find crop share and weather variables observed at the grids. We first tackle the crop share variable, and then the precipitation variable.</p>
<hr />
<p><strong>GIS tasks</strong></p>
<ul>
<li>download Cropland Data Layer (CDL) data by USDA NASS
<ul>
<li>use <code>cdlTools::getCDL()</code></li>
</ul></li>
<li>download PRISM weather data
<ul>
<li>use <code>prism::get_prism_dailys()</code></li>
</ul></li>
<li>crop PRISM data to the geographic extent of IA
<ul>
<li>use <code>raster::crop()</code></li>
</ul></li>
<li>create regular grids within IA, which become the observation units of the econometric analysis
<ul>
<li>use <code>sf::st_make_grid()</code></li>
</ul></li>
<li>remove grids that share small area with IA
<ul>
<li>use <code>sf::st_intersection()</code> and <code>sf::st_area</code></li>
</ul></li>
<li>assign crop share and weather data to each of the generated IA grids (parallelized)
<ul>
<li>use <code>exactextractr::exact_extract()</code> and <code>future.apply::future_lapply()</code></li>
</ul></li>
<li>create maps
<ul>
<li>use <code>tmap</code> package</li>
</ul></li>
</ul>
<hr />
<p><strong>Preparation for replication</strong></p>
<ul>
<li>Load (install first if you have not) the following packages (There are other packages that will be loaded during the demonstration).</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb43-5" data-line-number="5"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb43-6" data-line-number="6"><span class="kw">library</span>(tmap)</a>
<a class="sourceLine" id="cb43-7" data-line-number="7"><span class="kw">library</span>(future.apply)</a>
<a class="sourceLine" id="cb43-8" data-line-number="8"><span class="kw">library</span>(stargazer)</a></code></pre></div>
</div>
<div id="project-demonstration-2" class="section level3">
<h3><span class="header-section-number">1.3.2</span> Project Demonstration</h3>
<p>The geographic focus of this project is IA. Let’s get IAs state border (see Figure <a href="demonstration-3-land-use-and-weather.html#fig:IA-map">1.8</a> for its map).</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;maps&quot;</span>)</a>
<a class="sourceLine" id="cb44-2" data-line-number="2"></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="co">#--- IA state boundary ---#</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4">IA_boundary &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="st">&quot;state&quot;</span>, <span class="st">&quot;iowa&quot;</span>, <span class="dt">plot =</span> <span class="ot">FALSE</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>)) </a></code></pre></div>
<div class="figure"><span id="fig:IA-map"></span>
<img src="Demonstration_files/figure-html/IA-map-1.png" alt="IA state boundary" width="672" />
<p class="caption">
Figure 1.8: IA state boundary
</p>
</div>
<p>The unit of analysis is artificial grids that we create over IA. The grids are regularly-sized rectangles except around the edge of the IA state border<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>. So, let’s create grids and remove those that do not overlap much with IA.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="co">#--- create regular grids (40 cells by 40 columns) over IA ---#</span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2">IA_grids &lt;-<span class="st"> </span>IA_boundary <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="st">  </span><span class="co">#--- create grids ---#</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="st">  </span><span class="kw">st_make_grid</span>(, <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">40</span>, <span class="dv">40</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="st">  </span><span class="co">#--- convert to sf ---#</span></a>
<a class="sourceLine" id="cb45-6" data-line-number="6"><span class="st">  </span><span class="kw">st_as_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-7" data-line-number="7"><span class="st">  </span><span class="co">#--- find the intersections of IA grids and IA polygon ---#</span></a>
<a class="sourceLine" id="cb45-8" data-line-number="8"><span class="st">  </span><span class="kw">st_intersection</span>(., IA_boundary) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-9" data-line-number="9"><span class="st">  </span><span class="co">#--- calculate the area of each grid ---#</span></a>
<a class="sourceLine" id="cb45-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb45-11" data-line-number="11">    <span class="dt">area =</span> <span class="kw">as.numeric</span>(<span class="kw">st_area</span>(.)),</a>
<a class="sourceLine" id="cb45-12" data-line-number="12">    <span class="dt">area_ratio =</span> area<span class="op">/</span><span class="kw">max</span>(area)</a>
<a class="sourceLine" id="cb45-13" data-line-number="13">  ) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-14" data-line-number="14"><span class="st">  </span><span class="co">#--- keep only if the intersected area is large enough ---#</span></a>
<a class="sourceLine" id="cb45-15" data-line-number="15"><span class="st">  </span><span class="kw">filter</span>(area_ratio <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-16" data-line-number="16"><span class="st">  </span><span class="co">#--- assign grid id for future merge ---#</span></a>
<a class="sourceLine" id="cb45-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">grid_id =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.))</a></code></pre></div>
<p>Here is what the generated grids look like (Figure <a href="demonstration-3-land-use-and-weather.html#fig:Demo4-IA-grids-map">1.9</a>):</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co">#--- plot the grids over the IA state border ---#</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"><span class="kw">tm_shape</span>(IA_boundary) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-3" data-line-number="3"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;green&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-4" data-line-number="4"><span class="kw">tm_shape</span>(IA_grids) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-6" data-line-number="6"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<div class="figure"><span id="fig:Demo4-IA-grids-map"></span>
<img src="Demonstration_files/figure-html/Demo4-IA-grids-map-1.png" alt="Map of regular grids generated over IA" width="672" />
<p class="caption">
Figure 1.9: Map of regular grids generated over IA
</p>
</div>
<hr />
<p>Let’s work on crop share data. You can download CDL data using the <code>getCDL()</code> function from the <code>cdlTools</code> package.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="co">#--- load the cdlTools package ---#</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="kw">library</span>(cdlTools)</a>
<a class="sourceLine" id="cb47-3" data-line-number="3"></a>
<a class="sourceLine" id="cb47-4" data-line-number="4"><span class="co">#--- download the CDL data for IA in 2015 ---#</span></a>
<a class="sourceLine" id="cb47-5" data-line-number="5">(</a>
<a class="sourceLine" id="cb47-6" data-line-number="6">IA_cdl_<span class="dv">2015</span> &lt;-<span class="st"> </span><span class="kw">getCDL</span>(<span class="st">&quot;Iowa&quot;</span>, <span class="dv">2015</span>)<span class="op">$</span>IA2015</a>
<a class="sourceLine" id="cb47-7" data-line-number="7">)</a></code></pre></div>
<pre><code>class      : RasterLayer 
dimensions : 11671, 17795, 207685445  (nrow, ncol, ncell)
resolution : 30, 30  (x, y)
extent     : -52095, 481755, 1938165, 2288295  (xmin, xmax, ymin, ymax)
crs        : +proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
source     : /private/var/folders/t4/5gnqprbn38nftyxkyk5hdwmd8hnypy/T/RtmpUSOffv/CDL_2015_19.tif 
names      : CDL_2015_19 
values     : 0, 255  (min, max)</code></pre>
<p>The cells (30 meter by 30 meter) of the imported raster layer take a value ranging from 0 to 255. Corn and soybean are represented by 1 and 5, respectively (visualization of the CDL data is on the right).</p>
<p>Figure <a href="demonstration-3-land-use-and-weather.html#fig:overlap-cdl-grid">1.10</a> shows the map of one of the IA grids and the CDL cells it overlaps with.</p>
<div class="figure"><span id="fig:overlap-cdl-grid"></span>
<img src="Demonstration_files/figure-html/overlap-cdl-grid-1.png" alt="Spatial overlap of a IA grid and CDL layer" width="672" />
<p class="caption">
Figure 1.10: Spatial overlap of a IA grid and CDL layer
</p>
</div>
<p>We would like to extract all the cell values within the blue border.</p>
<p>We use <code>exactextractr::exact_extract()</code> to identify which cells of the CDL raster layer fall within each of the IA grids and extract land use type values. We then find the share of corn and soybean for each of the grids.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1"><span class="co">#--- reproject grids to the CRS of the CDL data ---#</span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2">IA_grids_rp_cdl &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(IA_cdl_<span class="dv">2015</span>))</a>
<a class="sourceLine" id="cb49-3" data-line-number="3"></a>
<a class="sourceLine" id="cb49-4" data-line-number="4"><span class="co">#--- load the exactextractr package for fast rater value extractions for polygons ---#</span></a>
<a class="sourceLine" id="cb49-5" data-line-number="5"><span class="kw">library</span>(exactextractr)</a>
<a class="sourceLine" id="cb49-6" data-line-number="6"></a>
<a class="sourceLine" id="cb49-7" data-line-number="7"><span class="co">#--- extract crop type values and find frequencies ---#</span></a>
<a class="sourceLine" id="cb49-8" data-line-number="8">cdl_extracted &lt;-<span class="st"> </span><span class="kw">exact_extract</span>(IA_cdl_<span class="dv">2015</span>, IA_grids_rp_cdl) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-9" data-line-number="9"><span class="st">  </span><span class="kw">lapply</span>(., <span class="cf">function</span> (x) <span class="kw">data.table</span>(x)[,.N, <span class="dt">by =</span> value]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-10" data-line-number="10"><span class="st">  </span><span class="co">#--- combine the list of data.tables into one data.table ---#</span></a>
<a class="sourceLine" id="cb49-11" data-line-number="11"><span class="st">  </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-12" data-line-number="12"><span class="st">  </span><span class="co">#--- find the share of each land use type ---#</span></a>
<a class="sourceLine" id="cb49-13" data-line-number="13"><span class="st">  </span>.[, share <span class="op">:</span><span class="er">=</span><span class="st"> </span>N<span class="op">/</span><span class="kw">sum</span>(N), by =<span class="st"> </span>.id] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-14" data-line-number="14"><span class="st">  </span>.[, N <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb49-15" data-line-number="15"><span class="st">  </span><span class="co">#--- keep only the share of corn and soy ---#</span></a>
<a class="sourceLine" id="cb49-16" data-line-number="16"><span class="st">  </span>.[value <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>), ]  </a></code></pre></div>
<p>We then find the corn to soy ratio for each of the IA grids.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="co">#--- find corn/soy ratio ---#</span></a>
<a class="sourceLine" id="cb50-2" data-line-number="2">corn_soy &lt;-<span class="st"> </span>cdl_extracted <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-3" data-line-number="3"><span class="st">  </span><span class="co">#--- long to wide ---#</span></a>
<a class="sourceLine" id="cb50-4" data-line-number="4"><span class="st">  </span><span class="kw">dcast</span>(.id <span class="op">~</span><span class="st"> </span>value, <span class="dt">value.var =</span> <span class="st">&quot;share&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="st">  </span><span class="co">#--- change variable names ---#</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="st">  </span><span class="kw">setnames</span>(<span class="kw">c</span>(<span class="st">&quot;.id&quot;</span>, <span class="st">&quot;1&quot;</span>, <span class="st">&quot;5&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;grid_id&quot;</span>, <span class="st">&quot;corn_share&quot;</span>, <span class="st">&quot;soy_share&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="st">  </span><span class="co">#--- corn share divided by soy share ---#</span></a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="st">  </span>.[, c_s_ratio <span class="op">:</span><span class="er">=</span><span class="st"> </span>corn_share <span class="op">/</span><span class="st"> </span>soy_share]</a></code></pre></div>
<hr />
<p>We are still missing daily precipitation data at the moment. We have decided to use daily weather data from PRISM. Daily PRISM data is a raster data with the cell size of 4 km by 4 km. Figure <a href="demonstration-3-land-use-and-weather.html#fig:Demo4-show-prism-data">1.11</a> the right presents precipitation data downloaded for April 1, 2010. It covers the entire contiguous U.S.</p>
<div class="figure"><span id="fig:Demo4-show-prism-data"></span>
<img src="Demonstration_files/figure-html/Demo4-show-prism-data-1.png" alt="Map of PRISM raster data layer" width="672" />
<p class="caption">
Figure 1.11: Map of PRISM raster data layer
</p>
</div>
<p>Let’s now download PRISM data<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>. This can be done using the <code>get_prism_dailys()</code> function from the <code>prism</code> package.<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a></p>
<!-- not to be seen -->
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="kw">options</span>(<span class="dt">prism.path =</span> <span class="st">&quot;./Data/PRISM&quot;</span>)</a>
<a class="sourceLine" id="cb51-2" data-line-number="2"></a>
<a class="sourceLine" id="cb51-3" data-line-number="3"><span class="kw">get_prism_dailys</span>(</a>
<a class="sourceLine" id="cb51-4" data-line-number="4">  <span class="dt">type =</span> <span class="st">&quot;ppt&quot;</span>, </a>
<a class="sourceLine" id="cb51-5" data-line-number="5">  <span class="dt">minDate =</span> <span class="st">&quot;2014-04-01&quot;</span>, </a>
<a class="sourceLine" id="cb51-6" data-line-number="6">  <span class="dt">maxDate =</span> <span class="st">&quot;2014-09-30&quot;</span>, </a>
<a class="sourceLine" id="cb51-7" data-line-number="7">  <span class="dt">keepZip =</span> <span class="ot">FALSE</span> </a>
<a class="sourceLine" id="cb51-8" data-line-number="8">)</a></code></pre></div>
<p>When we use <code>get_prism_dailys()</code> to download data<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a>, it creates one folder for each day. So, I have about 180 folders inside the folder I designated as the download destination above with the <code>options()</code> function.</p>
<!-- The name of the folder is expressive about what the data inside it is about. For example, the precipitation data for April 1st, 2010 is stored in the folder called "PRISM_ppt_stable_4kmD2_20100401_bil." Inside it, you will see bunch of files with exactly the same prefix, but with different extensions.   -->
<hr />
<p>We now try to extract precipitation value by day for each of the IA grids by geographically overlaying IA grids onto the PRISM data layer and identify which PRISM cells each of the IA grid encompass. Figure <a href="demonstration-3-land-use-and-weather.html#fig:Demo4-prism-crop">1.12</a> shows how the first IA grid overlaps with the PRISM cells<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a>.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="co">#--- read a PRISM dataset ---#</span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2">prism_whole &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil&quot;</span>) </a>
<a class="sourceLine" id="cb52-3" data-line-number="3"></a>
<a class="sourceLine" id="cb52-4" data-line-number="4"><span class="co">#--- align the CRS ---#</span></a>
<a class="sourceLine" id="cb52-5" data-line-number="5">IA_grids_rp_prism &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(prism_whole))</a>
<a class="sourceLine" id="cb52-6" data-line-number="6"></a>
<a class="sourceLine" id="cb52-7" data-line-number="7"><span class="co">#--- crop the PRISM data for the 1st IA grid ---#</span></a>
<a class="sourceLine" id="cb52-8" data-line-number="8">PRISM_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">crop</span>(prism_whole, <span class="kw">st_buffer</span>(IA_grids_rp_prism[<span class="dv">1</span>, ], <span class="dt">dist =</span> <span class="fl">0.05</span>))</a>
<a class="sourceLine" id="cb52-9" data-line-number="9"></a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="co">#--- map them ---#</span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="kw">tm_shape</span>(PRISM_<span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-12" data-line-number="12"><span class="st">  </span><span class="kw">tm_raster</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13"><span class="kw">tm_shape</span>(IA_grids_rp_prism[<span class="dv">1</span>, ]) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha =</span> <span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">frame =</span> <span class="ot">NA</span>)</a></code></pre></div>
<div class="figure"><span id="fig:Demo4-prism-crop"></span>
<img src="Demonstration_files/figure-html/Demo4-prism-crop-1.png" alt="Spatial overlap of an IA grid over PRISM cells" width="672" />
<p class="caption">
Figure 1.12: Spatial overlap of an IA grid over PRISM cells
</p>
</div>
<p>As you can see, some PRISM grids are fully inside the analysis grid, while others are partially inside it. So, when assigning precipitation values to grids, we will use the coverage-weighted mean of precipitations<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a>.</p>
<p>Unlike the CDL layer, we have 183 raster layers to process. Fortunately, we can process many raster files at the same time very quickly by first “stacking” many raster files first and then applying the <code>exact_extract()</code> function. Using <code>future_lapply()</code>, we let <span class="math inline">\(6\)</span> cores take care of this task with each processing 31 files, except one of them handling only 28 files.<a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a>
We first get all the paths to the PRISM files.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="co">#--- get all the dates ---#</span></a>
<a class="sourceLine" id="cb53-2" data-line-number="2">dates_ls &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2014-04-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2014-09-30&quot;</span>), <span class="st">&quot;days&quot;</span>) </a>
<a class="sourceLine" id="cb53-3" data-line-number="3"></a>
<a class="sourceLine" id="cb53-4" data-line-number="4"><span class="co">#--- remove hyphen ---#</span></a>
<a class="sourceLine" id="cb53-5" data-line-number="5">dates_ls_no_hyphen &lt;-<span class="st"> </span><span class="kw">str_remove_all</span>(dates_ls, <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb53-6" data-line-number="6"></a>
<a class="sourceLine" id="cb53-7" data-line-number="7"><span class="co">#--- get all the prism file names ---#</span></a>
<a class="sourceLine" id="cb53-8" data-line-number="8">folder_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;PRISM_ppt_stable_4kmD2_&quot;</span>, dates_ls_no_hyphen, <span class="st">&quot;_bil&quot;</span>) </a>
<a class="sourceLine" id="cb53-9" data-line-number="9">file_name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;PRISM_ppt_stable_4kmD2_&quot;</span>, dates_ls_no_hyphen, <span class="st">&quot;_bil.bil&quot;</span>) </a>
<a class="sourceLine" id="cb53-10" data-line-number="10">file_paths &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;./Data/PRISM/&quot;</span>, folder_name, <span class="st">&quot;/&quot;</span>, file_name)</a>
<a class="sourceLine" id="cb53-11" data-line-number="11"></a>
<a class="sourceLine" id="cb53-12" data-line-number="12"><span class="co">#--- take a look ---#</span></a>
<a class="sourceLine" id="cb53-13" data-line-number="13"><span class="kw">head</span>(file_paths)</a></code></pre></div>
<pre><code>[1] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140401_bil/PRISM_ppt_stable_4kmD2_20140401_bil.bil&quot;
[2] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140402_bil/PRISM_ppt_stable_4kmD2_20140402_bil.bil&quot;
[3] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140403_bil/PRISM_ppt_stable_4kmD2_20140403_bil.bil&quot;
[4] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140404_bil/PRISM_ppt_stable_4kmD2_20140404_bil.bil&quot;
[5] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140405_bil/PRISM_ppt_stable_4kmD2_20140405_bil.bil&quot;
[6] &quot;./Data/PRISM/PRISM_ppt_stable_4kmD2_20140406_bil/PRISM_ppt_stable_4kmD2_20140406_bil.bil&quot;</code></pre>
<p>We now prepare for parallelized extractions and then implement them using <code>future_apply()</code>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="co">#--- define the number of cores to use ---#</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2">num_core &lt;-<span class="st"> </span><span class="dv">6</span></a>
<a class="sourceLine" id="cb55-3" data-line-number="3"></a>
<a class="sourceLine" id="cb55-4" data-line-number="4"><span class="co">#--- prepare some parameters for parallelization ---#</span></a>
<a class="sourceLine" id="cb55-5" data-line-number="5">file_len &lt;-<span class="st"> </span><span class="kw">length</span>(file_paths)</a>
<a class="sourceLine" id="cb55-6" data-line-number="6">files_per_core &lt;-<span class="st"> </span><span class="kw">ceiling</span>(file_len<span class="op">/</span>num_core)</a>
<a class="sourceLine" id="cb55-7" data-line-number="7"></a>
<a class="sourceLine" id="cb55-8" data-line-number="8"><span class="co">#--- prepare for parallel processing ---#</span></a>
<a class="sourceLine" id="cb55-9" data-line-number="9"><span class="kw">plan</span>(multiprocess, <span class="dt">workers =</span> num_core)</a>
<a class="sourceLine" id="cb55-10" data-line-number="10"></a>
<a class="sourceLine" id="cb55-11" data-line-number="11"><span class="co">#--- reproject IA grids to the CRS of PRISM data ---#</span></a>
<a class="sourceLine" id="cb55-12" data-line-number="12">IA_grids_reprojected &lt;-<span class="st"> </span><span class="kw">st_transform</span>(IA_grids, <span class="kw">projection</span>(prism_whole))</a></code></pre></div>
<p>Here is the function that we run in parallel over 6 cores.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="co">#--- define the function to extract PRISM values by block of files ---#</span></a>
<a class="sourceLine" id="cb56-2" data-line-number="2">extract_by_block &lt;-<span class="st"> </span><span class="cf">function</span>(i, files_per_core) {</a>
<a class="sourceLine" id="cb56-3" data-line-number="3"></a>
<a class="sourceLine" id="cb56-4" data-line-number="4">  <span class="co">#--- files processed by core  ---#</span></a>
<a class="sourceLine" id="cb56-5" data-line-number="5">  start_file_index &lt;-<span class="st"> </span>(i<span class="dv">-1</span>) <span class="op">*</span><span class="st"> </span>files_per_core <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb56-6" data-line-number="6"></a>
<a class="sourceLine" id="cb56-7" data-line-number="7">  <span class="co">#--- indexes for files to process ---#</span></a>
<a class="sourceLine" id="cb56-8" data-line-number="8">  file_index &lt;-<span class="st"> </span><span class="kw">seq</span>(</a>
<a class="sourceLine" id="cb56-9" data-line-number="9">    <span class="dt">from =</span> start_file_index,</a>
<a class="sourceLine" id="cb56-10" data-line-number="10">    <span class="dt">to =</span> <span class="kw">min</span>((start_file_index <span class="op">+</span><span class="st"> </span>files_per_core), file_len),</a>
<a class="sourceLine" id="cb56-11" data-line-number="11">    <span class="dt">by =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb56-12" data-line-number="12">  )</a>
<a class="sourceLine" id="cb56-13" data-line-number="13"></a>
<a class="sourceLine" id="cb56-14" data-line-number="14">  <span class="co">#--- extract values ---# </span></a>
<a class="sourceLine" id="cb56-15" data-line-number="15">  data_temp &lt;-<span class="st"> </span>file_paths[file_index] <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># get file names</span></a>
<a class="sourceLine" id="cb56-16" data-line-number="16"><span class="st">    </span><span class="co">#--- stack files ---#</span></a>
<a class="sourceLine" id="cb56-17" data-line-number="17"><span class="st">    </span><span class="kw">stack</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-18" data-line-number="18"><span class="st">    </span><span class="co">#--- extract ---#</span></a>
<a class="sourceLine" id="cb56-19" data-line-number="19"><span class="st">    </span><span class="kw">exact_extract</span>(., IA_grids_reprojected) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-20" data-line-number="20"><span class="st">    </span><span class="co">#--- combine into one data set ---#</span></a>
<a class="sourceLine" id="cb56-21" data-line-number="21"><span class="st">    </span><span class="kw">rbindlist</span>(<span class="dt">idcol =</span> <span class="st">&quot;ID&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-22" data-line-number="22"><span class="st">    </span><span class="co">#--- wide to long ---#</span></a>
<a class="sourceLine" id="cb56-23" data-line-number="23"><span class="st">    </span><span class="kw">melt</span>(<span class="dt">id.var =</span> <span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;coverage_fraction&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb56-24" data-line-number="24"><span class="st">    </span><span class="co">#--- calculate &quot;area&quot;-weighted mean ---#</span></a>
<a class="sourceLine" id="cb56-25" data-line-number="25"><span class="st">    </span>.[, .(<span class="dt">value =</span> <span class="kw">sum</span>(value <span class="op">*</span><span class="st"> </span>coverage_fraction)<span class="op">/</span><span class="kw">sum</span>(coverage_fraction)), by =<span class="st"> </span>.(ID, variable)]</a>
<a class="sourceLine" id="cb56-26" data-line-number="26"></a>
<a class="sourceLine" id="cb56-27" data-line-number="27">  <span class="kw">return</span>(data_temp)</a>
<a class="sourceLine" id="cb56-28" data-line-number="28">}</a></code></pre></div>
<p>Now, let’s run the function in parallel and calculate precipitation by period.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="co">#--- run the function ---#</span></a>
<a class="sourceLine" id="cb57-2" data-line-number="2">precip_by_period &lt;-<span class="st"> </span><span class="kw">future_lapply</span>(<span class="dv">1</span><span class="op">:</span>num_core, <span class="cf">function</span>(x) <span class="kw">extract_by_block</span>(x, files_per_core)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rbindlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-3" data-line-number="3"><span class="st">  </span><span class="co">#--- recover the date ---#</span></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="st">  </span>.[, variable <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">str_extract</span>(variable, <span class="st">&quot;[0-9]{8}&quot;</span>), <span class="st">&quot;%Y%m%d&quot;</span>)] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-5" data-line-number="5"><span class="st">  </span><span class="co">#--- change the variable name to date ---#</span></a>
<a class="sourceLine" id="cb57-6" data-line-number="6"><span class="st">  </span><span class="kw">setnames</span>(<span class="st">&quot;variable&quot;</span>, <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-7" data-line-number="7"><span class="st">  </span><span class="co">#--- define critical period ---#</span></a>
<a class="sourceLine" id="cb57-8" data-line-number="8"><span class="st">  </span>.[,critical <span class="op">:</span><span class="er">=</span><span class="st"> &quot;non_critical&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-9" data-line-number="9"><span class="st">  </span>.[<span class="kw">month</span>(date) <span class="op">%in%</span><span class="st"> </span><span class="dv">6</span><span class="op">:</span><span class="dv">8</span>, critical <span class="op">:</span><span class="er">=</span><span class="st"> &quot;critical&quot;</span>] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb57-10" data-line-number="10"><span class="st">  </span><span class="co">#--- total precipitation by critical dummy  ---#</span></a>
<a class="sourceLine" id="cb57-11" data-line-number="11"><span class="st">  </span>.[, .(<span class="dt">precip=</span><span class="kw">sum</span>(value)), by =<span class="st"> </span>.(ID, critical)] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-12" data-line-number="12"><span class="st">  </span><span class="co">#--- wide to long ---#</span></a>
<a class="sourceLine" id="cb57-13" data-line-number="13"><span class="st">  </span><span class="kw">dcast</span>(ID <span class="op">~</span><span class="st"> </span>critical, <span class="dt">value.var =</span> <span class="st">&quot;precip&quot;</span>)</a></code></pre></div>
<p>We now have grid-level crop share and precipitation data.</p>
<hr />
<p>Let’s merge them and run regression.<a href="#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="co">#--- crop share ---#</span></a>
<a class="sourceLine" id="cb58-2" data-line-number="2">reg_data &lt;-<span class="st"> </span>corn_soy[precip_by_period, on =<span class="st"> </span><span class="kw">c</span>(<span class="dt">grid_id =</span> <span class="st">&quot;ID&quot;</span>)]</a>
<a class="sourceLine" id="cb58-3" data-line-number="3"></a>
<a class="sourceLine" id="cb58-4" data-line-number="4"><span class="co">#--- OLS ---#</span></a>
<a class="sourceLine" id="cb58-5" data-line-number="5">reg_results &lt;-<span class="st"> </span><span class="kw">lm</span>(c_s_ratio <span class="op">~</span><span class="st"> </span>critical <span class="op">+</span><span class="st"> </span>non_critical, <span class="dt">data =</span> reg_data)</a></code></pre></div>
<p>Here is the regression results table.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1"><span class="co">#--- regression table ---#</span></a>
<a class="sourceLine" id="cb59-2" data-line-number="2"><span class="kw">stargazer</span>(reg_results, <span class="dt">type =</span> <span class="st">&quot;html&quot;</span>)</a></code></pre></div>
<table style="text-align:center">
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
<em>Dependent variable:</em>
</td>
</tr>
<tr>
<td>
</td>
<td colspan="1" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
c_s_ratio
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
critical
</td>
<td>
-0.002<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
non_critical
</td>
<td>
-0.0003
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.0003)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
2.701<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.161)
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
1,218
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.058
</td>
</tr>
<tr>
<td style="text-align:left">
Adjusted R<sup>2</sup>
</td>
<td>
0.056
</td>
</tr>
<tr>
<td style="text-align:left">
Residual Std. Error
</td>
<td>
0.743 (df = 1215)
</td>
</tr>
<tr>
<td style="text-align:left">
F Statistic
</td>
<td>
37.234<sup>***</sup> (df = 2; 1215)
</td>
</tr>
<tr>
<td colspan="2" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
<p>Again, do not read into the results as the econometric model is terrible.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="20">
<li id="fn20"><p>We by no means are saying that this is the right geographical unit of analysis. This is just about demonstrating how R can be used for analysis done at the higher spatial resolution than county.<a href="demonstration-3-land-use-and-weather.html#fnref20" class="footnote-back">↩</a></p></li>
<li id="fn21"><p>You do not have to run this code to download the data. It is included in the data folder for replication (<a href="https://www.dropbox.com/sh/cyx9clgmshwc8eo/AAApv03Qpx84IGKCyF5v2rJ6a?dl=0">here</a>).<a href="demonstration-3-land-use-and-weather.html#fnref21" class="footnote-back">↩</a></p></li>
<li id="fn22"><p><a href="https://github.com/ropensci/prism">prism github page</a><a href="demonstration-3-land-use-and-weather.html#fnref22" class="footnote-back">↩</a></p></li>
<li id="fn23"><p>For this project, I could have just used monthly PRISM data, which can be downloaded using the <code>get_prism_monthlys()</code> function. But, in many applications, daily data is necessary, so I wanted to illustrate how to download and process them.<a href="demonstration-3-land-use-and-weather.html#fnref23" class="footnote-back">↩</a></p></li>
<li id="fn24"><p>Do not use <code>st_buffer()</code> for spatial objects in geographic coordinates (latitude, longitude) if you intend to use the created buffers for any serious IA (it is difficult to get the right distance parameter anyway.). Significant distortion will be introduced to the buffer due to the fact that one degree in latitude and longitude means different distances at the latitude of IA. Here, I am just creating a buffer to extract PRISM cells to display on the map.<a href="demonstration-3-land-use-and-weather.html#fnref24" class="footnote-back">↩</a></p></li>
<li id="fn25"><p>In practice, this may not be advisable. The coverage fraction calculation by <code>exact_extract()</code> is done using latitude and longitude. Therefore, the relative magnitude of the fraction numbers incorrectly reflects the actual relative magnitude of the overlapped area. When the spatial resolution of the sources grids (grids from which you extract values) is much smaller relative to that of the target grids (grids to which you assign values to), then a simple average would be very similar to a coverage-weighted mean. For example, CDL consists of 30m by 30m grids, and more than <span class="math inline">\(1,000\)</span> grids are inside one analysis grid.<a href="demonstration-3-land-use-and-weather.html#fnref25" class="footnote-back">↩</a></p></li>
<li id="fn26"><p>Parallelization of extracting values from many raster layers for polygons are discussed in much more detail in Chapter <a href="#Efficient"><strong>??</strong></a>. When I tried stacking all 183 files into one stack and applying <code>exact_extract</code>, it did not finish the job after over five minutes. So, I terminated the process in the middle. The parallelized version gets the job done in about <span class="math inline">\(30\)</span> seconds on my desktop.<a href="demonstration-3-land-use-and-weather.html#fnref26" class="footnote-back">↩</a></p></li>
<li id="fn27"><p>We can match on <code>grid_id</code> from <code>corn_soy</code> and <code>ID</code> from “precip_by_period” because <code>grid_id</code> is identical with the row number and ID variables were created so that the ID value of <span class="math inline">\(i\)</span> corresponds to <span class="math inline">\(i\)</span> th row of <code>IA_grids</code>.<a href="demonstration-3-land-use-and-weather.html#fnref27" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="demonstration-2-precision-agriculture.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="demo4.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
